/**
 * Created by ciprian on 2/12/15.
 */

var Accommodation = {};
var infoWindow;
var focusstatus=false;
let showOverlay =false;
/**
 *
 * KEYSTOP event to replace keyup/blur/change
 *
 */
(function ($) { "use strict";

    $.event.special.keystop = {
        add: function (details) {
            var $el = $(this);
            var ns = ".__" + details.guid;
            var delay = details.data || 500;
            var tID = -1;

            details.namespace += ns;

            $el.on("input" + ns + " propertychange" + ns, function () {
                clearTimeout(tID);

                tID = setTimeout(function () {
                    $el.trigger("keystop" + ns);
                }, delay);
            });
        },
        remove: function (details) {
            var ns = ".__" + details.guid;

            $(this).off("input" + ns + " propertychange" + ns);
        }
    };

    $.fn.keystop = function (handler, delay) {
        return handler ? this.on("keystop", delay, handler) : this.trigger("keystop");
    };
    // hotel details fixed header
    if ($('#isSinglePage').length > 0) {
        var stickyOffset = $('#accordion').offset().top;
        $(window).scroll(function () {
            var sticky = $('.sticky'),
                scroll = $(window).scrollTop();
            if (scroll >= stickyOffset) sticky.addClass('hotel-header-fixed');
            else sticky.removeClass('hotel-header-fixed');
        });
    }

    $('body').tooltip({
        selector: '[data-toggle="tooltip"]'
    });
    $("#umrahdestimnation").change(function () {
        var selectedVal = this.value;
        if (selectedVal > 0) {
            $("input[name=destination]").val($("#umrahdestimnation option:selected").text());
            $("input[name=PSearchId]").val(selectedVal);
            $("input[name=PSearchType]").val('city');
        } else {
            $("input[name=destination]").val('');
            $("input[name=PSearchId]").val('');
            $("input[name=PSearchType]").val('');
        }

    });
})(jQuery);

//search module
Accommodation.Search =
{
    rules               : {},
    messages            : {},
    container           : '#content > div.row',
    URL                 : $('#searchForm').attr('action'),
    formId              : '#searchForm',
    modalBannerUrl      : null,
    labelsText          : {},
    getInfoUrl          : '',
    getGalleryUrl       : '',
    getHotelInfoUrl     : '',
    hotelDescLen        : 0,
    wCountObj           : $('#show_more_cnt'),
    hotelInfoObj        : $('#hotel_info_hidden'),
    bigMap              : null,
    geoMarkers          : [],
    markerCluster       : null,
    displayedDailyRates : [],
    searchPerformed     : false,
    performedSearchData : {},
    getOffersUrl        : '',
    getRoomsUrl: '',
    getRoomDetailsUrl   : '',
    getDailyRatesUrl    : '',
    getDailyRoomRatesUrl    : '',
    getRemainingResultsUrl : '',
    getSendToEmailUrl: '',
    validator           : null,
    remainingResults    : null,
    geoAutocomplete     : null,
    remainingResultsFullRequest : null,
	identifier : [],
    roomPolicyStats : {},
    fullSearchResults : null,
    fromFastSearch: false,
    init : function()
    {
        var _self = Accommodation.Search;
        var status=false;
        $('#searchRoomsNo').selectpicker();
        $('#numberOfNights').selectpicker();
        $('#commission').selectpicker();
        $('#markerRange').selectpicker();
        $('#searchRoomsNo').change(function(){
            setTimeout(function() {
                _self.insertRooms();
            }, 25);
            if(status == true )
            {
                if($('#isCriteriaChange').length > 0)
                {
                    $('#isCriteriaChange').val(1);
                }
            }
          status= true;

        });

        $(document).on('click', '#show-all-rooms', function(ev)
        {
            ev.preventDefault();
            let state = $(this).data('state');
            let rooms = $('#searchRoomsNo').val();

            $('#searchForm > div.search_row:lt(' + rooms + ")").toggle(! state);
            $(this).data('state',  ! state);

            if (! state) {
                $(this).find('.show-less').show();
                $(this).find('.show-more').hide();
            } else {
                $(this).find('.show-less').hide();
                $(this).find('.show-more').show();
            }
        });

        $('#search_row .customSelect').selectpicker();
        $('#search_row_advanced .customSelect').selectpicker();
        $('#search_row1 .customSelect').selectpicker();
        $('#search_row2 .customSelect').selectpicker();
        $('#search_row3 .customSelect').selectpicker();
        $('#search_row4 .customSelect').selectpicker();
        $('#search_row5 .customSelect').selectpicker();
        $("#showOnMap").bootstrapSwitch();
        $('#searchAdvancedButton').click(function(){
            $('#searchAdvancedButton').hide();
            $('#searchSimpleButton').show();
            $('#search_row_advanced').show(200);
        });
        $('#searchSimpleButton').click(function(){
            $('#searchSimpleButton').hide();
            $('#searchAdvancedButton').show();
            $('#search_row_advanced').hide(200);
        });
        $('#searchRoomsNo').change();

        _self.residencyAndNationalityTypeahead();

        // Form js validation and execute on submit
        if (typeof ValidatorWithLaravelRules === "undefined") {
            AlertError.show(makeAMessagePanel(_self.labelsText.validatorNotDefined), _self.labelsText.error);
        }
        _self.validator = new ValidatorWithLaravelRules();
        _self.validator.rules             = _self.rules;
        _self.validator.messages          = _self.messages;
        _self.validator.showSearchText    = true;
        $.extend(
            true,
            _self.validator.messages,
            {
                error: _self.labelsText.error,
                invalidValue: _self.labelsText.invalidValue
            }
        );
        _self.validator.URL               = _self.URL;
        _self.validator.formId            = _self.formId;
        _self.validator.errorHolder       = '#search_errors';
        _self.validator.resultContainer   = _self.container;
        _self.validator.callBack          = _self.searchCallBack;
        _self.validator.init();

        if(isOldIE() <= 9) {
            $("#address").attr('placeholder', '');
        }

        if(typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
            infoWindow = new google.maps.InfoWindow();
            _self.geoAutocomplete = new google.maps.places.Autocomplete(
                (document.getElementById('address')),
                {types: ['geocode']});
            google.maps.event.addListener(_self.geoAutocomplete, 'place_changed', function() {
                _self.selectAddress();
            });
            $("#address").on('keypress', function(e) {
                //clear coordinates and city when typing address
                var code = e.keyCode || e.which;
                if(code == 13) {
                    e.preventDefault();
                } else {
                    _self.clearAddress(false);
                }
            });
        }
        else {
            $("#address").parent().hide();
            $('#search_row_advanced [name="radius"]').parent().hide();
        }

        $('[name="destination"]').on('change', function(){
            //clear address when selecting city
            $('input[name="address"]').val('');
            $('input[name="latitude"]').val('');
            $('input[name="longitude"]').val('');
        });

        if(!$('#serachDetailsPage').val()){
            $('#destination, [name="destinationCity"],[name="PSearchId"],[name="PSearchType"],[name="PLocationType"], #fromDatepicker, [name="dateFrom"], #toDatepicker, [name="dateTo"], #hotelSearchId, [name="productCode"], ' +
                '[name="roomsNo"], [name="propertyType"], [name="starRating"], [name="availability"], [name*="residency"], [name*="orderRates"], ' +
                '[name*="nationality"], [name*="adultsCount"], [name*="childrenCount"], [name*="childrenAges"], [name="radius"], [name="address"]', '#searchForm').change(function (event) {
                _self.cleanResultsAfterUserChangingFieldValue(event, this);
            });
        }
        $(document).on('click', 'button[name="apply_markup"]', function (e) {
            e.preventDefault();
            var markupValue = parseFloat($('input[name="markup_value"]').val().replace(DECIMAL_SEPARATOR, '.'));
            if (isNaN(markupValue)){
                markupValue = 0;
                $('input[name="markup_value"]').val(markupValue);
            }

            var markupType = $('select[name="markup_type"]').val();

            if (markupValue < 0 || (markupType == 1 && markupValue >= 100)) {
                if (markupType == 1) {
                    markupValue = 99.99;

                } else {
                    markupValue = 0;
                }
                $('input[name="markup_value"]').val(markupValue.toString().replace('.', DECIMAL_SEPARATOR));
            }

            var roomRates = $('.aj-room_price');
            if (roomRates.length == 0) {
                return;
            }
            $.each(roomRates, function (index, room) {
                var newRate, roomRate = $(room).data('room_rate').toString().replace(THOUSAND_SEPARATOR, '');
                roomRate = roomRate.replace(DECIMAL_SEPARATOR, '.');
                roomRate = parseFloat(roomRate);

                if (markupType == 1) {
                    newRate = roomRate / ((100 - markupValue) / 100);
                } else {
                    newRate = roomRate + markupValue;
                }
            //    newRate = +(Math.round(newRate + "e+2") + "e-2");
                $(room).text(currencyRound($('#activeCurrency').data('activecurrencyname'), newRate, false));
            });


        });

        $(document).on('click', 'button[name="apply_cancellation"]', function (e) {
            e.preventDefault();

            var cancellationType  = $('[name="cancellation_type"]').val();
            var cancellationBufferValue  = $('[name="cancellation_value"]').val();

            var roomDeadlines = $('.ai-room_deadline_status');
            if (roomDeadlines.length == 0) {
                return;
            }

            $.each(roomDeadlines, function (index, room)
            {
                var roomCancellationType = $(room).data('cancellation');
                var roomId = $(room).data('roomid');

                var defaultPolicy='';
                if(roomCancellationType == 'date'){
                    defaultPolicy = trans('compare.deadlineText') + "&#160;" + $(room).data('value');
                } else if(roomCancellationType == 'deadline'){
                    defaultPolicy = '<span class="text-danger non-hover"><span class="glyphicon glyphicon-info-sign text-danger"></span>&#160;' + trans('compare.withinDeadlineText') + '</span>';
                } else if(roomCancellationType == 'refundable'){
                    defaultPolicy = '<span class="text-danger non-hover"><span class="glyphicon glyphicon-warning-sign text-danger"></span>&#160;' + trans('compare.nonRefundableText') + '</span>';
                } else {
                    defaultPolicy = '<span class="text-success">' + trans('compare.noDeadlineText') + '</span>';
                }

                var roomPolicy = defaultPolicy;
                if(cancellationType == 1){
                    roomPolicy = '<span class="text-danger non-hover"><span class="glyphicon glyphicon-warning-sign text-danger"></span>&#160;' + trans('compare.nonRefundableText') + '</span>';
                } else if (cancellationType == 2){
                    roomPolicy = '<span class="text-danger non-hover"><span class="glyphicon glyphicon-info-sign text-danger"></span>&#160;' + trans('compare.withinDeadlineText') + '</span>';
                } else if (cancellationType == 3){
                    if(roomCancellationType == 'date'){
                        var dateObj = new Date( $(room).data('value') );
                        dateObj.setDate(dateObj.getDate() - cancellationBufferValue);
                        roomPolicy = trans('compare.deadlineText') + " " + $.datepicker.formatDate(JS_DATE_FORMAT_EXT, dateObj) + " " + getTime(dateObj);
                    }
                }
                //non refundable cannot be altered
                if(roomCancellationType == 'refundable'){
                    roomPolicy = defaultPolicy;
                }
                var roomCancellationInput = '<textarea name="room_cancellation_' + roomId + '" id="room_cancellation_' + roomId + '" style="display:none">' + roomPolicy + '</textarea>'
                $(room).html(roomCancellationInput + roomPolicy);
            });
        });



        $(document).on('switchChange.bootstrapSwitch', 'input[name="apply_rates"]', function (e, state) {
            if (!state) {
                $('input[name="markup_value"]').val(0);
                $('select[name="markup_type"]').val(1);
                $('button[name="apply_markup"]').click();
            }
            $('select[name="markup_type"]').attr('readonly', !state);
            $('input[name="markup_value"]').attr('readonly', !state);
            $('button[name="apply_markup"]').attr('disabled', !state);
        });

        $(document).on('switchChange.bootstrapSwitch', 'input[name="adjust_cancellation"]', function (e, state) {
            if (!state) {
                $('select[name="cancellation_type"]').val(0);
                $('select[name="cancellation_value"]').val(0);
                $('button[name="apply_cancellation"]').click();
            }
            $('select[name="cancellation_type"]').attr('readonly', !state);
            $('select[name="cancellation_value"]').attr('readonly', !state);
            $('button[name="apply_cancellation"]').attr('disabled', !state);
            Accommodation.Search.filterCancellationTypes();
        });

        $(document).on('change', 'select[name="cancellation_type"]', function (e, state) {
            $('select[name="cancellation_value"]').attr('readonly', true);
            if($(this).val() == 3 && $('input[name="adjust_cancellation"]').is(':checked')){
                $('select[name="cancellation_value"]').val(0);
                $('select[name="cancellation_value"]').attr('readonly', false);
            }
        });

        $(document).on('click', 'div#content .main-hotel-info', function() {
            _self.getExtendedInfo(this);
        });
        /*not used*/
        /*$(document).on('click', 'div#content .aj-show-hotelinfo', function (e) {
            e.preventDefault();
            var hotelInfoLink = $(this).parents('.search-result_row').find('a.main-hotel-info');
            if (hotelInfoLink[0] == undefined) {
                AlertError.show('Invalid hotel. Please try again');
                return false;
            }
            _self.getExtendedInfo(hotelInfoLink[0], true);
        });*/

        /*dwc-362 clear all rooms from pdf creator*/
        $(document).on('click', '#clearAllRoomsFromPdf', function (e) {
            // find all checkbox room table
            var rooms = $('tbody tr td input[type=checkbox]');
            var checkBox = $(this).is(':checked');
            if (checkBox) {
                $(rooms).prop("checked", true);
            } else {
                $(rooms).prop("checked", false);
            }
        });
        $(document).on('click', 'input[name="room_id[]"]', function (e) {

            var allRooms = $('input[name="room_id[]"]').length;
            var allRoomsChecked = $('input[name="room_id[]"]:checked').length;
            var selectAllElement = $('#clearAllRoomsFromPdf');
            if (allRoomsChecked !== allRooms) {
                $(selectAllElement).prop("checked", false);
            } else {
                $(selectAllElement).prop("checked", true);
            }

        });


        //$(document).on('click', 'div#content .cancelInfoIcon', function(){
        //   Accommodation.Search.showCancellationInfo(this);
        //});

        $(document).on('click', 'div#content .showMoreDescInit', function(){
            _self.showMoreDescInit(this);
        });
        // for hotel details info
        $(document).on('click', 'div#content .showMoreHotelDetails', function(){
            _self.showMoreHotelDetails(this);
        });
        $(document).on('click', 'div#content .showLessDetailsDesc', function(){
            _self.showLessDetailsDesc(this);
        });
        $(document).on('click', 'div#content .showMoreDesc', function(){
            _self.showMoreDesc(this);
        });
        $(document).on('click', 'div#content .showLessDesc', function(){
            _self.showLessDesc(this);
        });
        $(document).on('click', 'div#content .roomBookNowButton', function(e){
            if($('#canViewRatesAndBook').val() == '1') {
                if (e.originalEvent != undefined) {
                    Compare.bookFromPopupList = false;
                }

                Accommodation.Booking.roomBookNow(this, false);
            }
            else {
                _self.noViewRateAndBook();
            }
        });
        $(document).on('click', 'div#content .mrBookButton', function(event){
            if($('#canViewRatesAndBook').val() == '1') {
                Accommodation.Booking.hotelBookNow(this);
            }
            else {
                _self.noViewRateAndBook();
            }
        });
        $(document).on('change blur', 'div#content .multipleRoomsSelect', function(event){
            event.preventDefault();
            Accommodation.Booking.updateRoomsGroup(this);
        });

        _self.showRoomMoreOptions();
        $(document).on('click', 'div#content .roomNoBookNowButton', function(){
            AlertInfo.show($(this).data('message'));
            AlertInfo.setWidth('600px');
        });

        $(document).on('click', 'div#content .mainGallery', function (ev) {
            ev.preventDefault();
            var $this = $(this);
            var gallery = this.attributes['data-hotelId'].value;
            var firstImage = $('[data-gallery="gallery_' + gallery + '"]')[0];
            if ($(firstImage).length) {
                $(firstImage).trigger('click');
            }
            else
            {
                var _self = Accommodation.Search;
                Loader.show(false, false);
                var accommodationId = $this.parents('.search-result_row').data('hotelid');
                var params = $('#searchForm').serialize();

                $.ajax({
                    url: _self.getGalleryUrl + '/' + accommodationId,
                    dataType: 'html',
                    type: "POST",
                    async: true,
                    data: params,
                    statusCode: {
                        302: function () {
                            window.location.href = BASE_CI_URL + '/login';
                        }
                    }
                }).done(function (result)
                {
                    $this.next().html(result);
                    firstImage = $('[data-gallery="gallery_' + gallery + '"]')[0];
                    if ($(firstImage).length) {
                        $(firstImage).trigger('click');
                    }

                }).fail(function (xhr, err, errText) {
                    // only show the alert if the status is not a redirect
                    if(xhr.status != 302) {
                        AlertError.show(xhr.responseText, _self.labelsText.error); //
                    }
                }).always(function() {
                    Loader.hide();
                });
            }
            return false;
        });

        $(document).undelegate('*[data-toggle="lightbox"]', 'click').delegate('*[data-toggle="lightbox"]', 'click', function(event) {
            event.preventDefault();

            // slider bullets
            var gallery = $(this).data('gallery');
            $(this).parent().find('a').each(function(index){
                var bullets = '<ol class="carousel-indicators galleryFooterThumbs">';
                for(var i = 0, j = $(this).parent().find('a').length; i < j; i++) {
                    bullets += '<li data-target="#' + gallery + '" data-slide-to="' + i + '"' + (i == index ? ' class="active"' : '') + '></li>';
                }
                bullets += '</ol>';
                $(this).data('footer', bullets);
            });
            return $(this).ekkoLightbox({
                onShown: function() {
                    var lightbox = this;
                    $(document).off('click', '.ekko-lightbox .modal-footer li').on('click', '.ekko-lightbox .modal-footer li', function(ev){
                        ev.preventDefault();
                        lightbox.navigateTo($(this).data('slide-to'));
                    });
                }
            });

            // image thumbnails
            /*var thumbs = '<div class="galleryFooterThumbsSlider"><ul class="galleryFooterThumbs columns-4">';
            $(this).parent().find('a').each(function(index){
                thumbs += '<li>';
                thumbs += '<img src="' + $(this).attr('href') + '" data-index="' + index + '"/>';
                thumbs += '</li>';
            });
            thumbs += '</ul></div>';
            $(this).parent().find('a').each(function(){
                $(this).data('footer', thumbs);
            });
            return $(this).ekkoLightbox({
                onShown: function() {
                    var lightbox = this;
                    $(document).off('click', '.ekko-lightbox .modal-footer img').on('click', '.ekko-lightbox .modal-footer img', function(ev){
                        ev.preventDefault();
                        lightbox.navigateTo($(this).data('index'));
                    });
                }
            });*/
        });

        $(document).on('focus', 'input#address', function () {

            if (navigator.geolocation && typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var geolocation = new google.maps.LatLng(
                        position.coords.latitude, position.coords.longitude);
                    var circle = new google.maps.Circle({
                        center: geolocation,
                        radius: position.coords.accuracy
                    });
                    Accommodation.Search.geoAutocomplete.setBounds(circle.getBounds());
                });
            }
        });
        $(document).on('click', 'div#content .mapIcon', function () {

            if(typeof google === 'undefined' || typeof google.maps === 'undefined') {
                return false;
            }
            var latLng = new google.maps.LatLng($(this).attr('data-lat'), $(this).attr('data-lng'));

            var map = new google.maps.Map(document.getElementById('mapContainer'), {
                center    : latLng,
                zoom      : 15,
                panControl: false,
                mapTypeId : google.maps.MapTypeId.ROADMAP
            });

            new google.maps.Marker({
                position : latLng,
                map      : map,
                draggable: false
            });

            $('#mapHotelName').html($(this).closest('.search-result_row').find('.search-name-container h3.unitName').html());
            $('#mapModal').modal('show').on('shown.bs.modal', function () {
                google.maps.event.trigger(map, "resize");
                map.setCenter(latLng);
            });
        });
        $('#mapModal').on('shown.bs.modal', function () {
            $('#mapModal').find('.modal-backdrop').css({
                height: 'auto',
                bottom: 0
            });
        });
        $ (document).on ('mouseover', 'div#search-result_rows .infoBoxTrigger, div#search-result_rows .mainGallery', function ()
        {
            $('.lefttooltip').remove();

            var $this = $(this);
            if($this.data('toggle') == 'tooltip')
            {
                $this.tooltip("show");
            }
            else
            {
                if($this.hasClass('cancelInfoIcon'))
                {
                    //$this.data('content', $this.next().html());
                    var html = Accommodation.Search.getCancellationRulesHtmlFromJson($this.next().val());
                    $this.data('content', html);
                }
                else if($this.hasClass('icon-notes'))
                {
                    var pos = $this.data('content-position');
                    var notes = $this.parents('.search-result_row').find('input[name="tariffNotesRoom"]').val();
                    notes = notes.substring(pos);
                    pos = notes.indexOf('!#@#!');
                    $this.data('content', notes.substring(0, pos));

                    $this
                        .popover("show")
                        .data('bs.popover')
                        .tip()
                        .addClass('tariff-notes');
                }

                $this.popover("show");
            }
        });
        $ (document).on('focusout', 'div#search-result_rows .cancelInfoIcon', function ()
        {
            $(this).popover("hide");
        });

        $(document).on('mouseout', 'div.lefttooltip .popover-content', function ()
        {
            $('.lefttooltip').remove();
        });

        $(document).on('mouseout', 'div#search-result_rows .infoBoxTrigger', function (event)
        {
            const pointerY = event.pageY;
            const iconY = event.currentTarget.offsetTop;
            const popupY = $('.lefttooltip').offset().top;

            if (!(popupY + $('.lefttooltip').height() < pointerY && pointerY < iconY)) {
                $('.lefttooltip').remove();
            }
        });

        $(document).bind('resized.FilterMobileMenu', function(){
            _self.resizedFilterMobileMenu();
        });
        $(document).bind('beginApplyFilters.ResultFilter', function(){
            _self.beginApplyFiltersResultFilter();
        });
        $(document).bind('appendRemainingResults.main appendRemainingResults.ResultsSortBy appendRemainingResults.ResultFilter appendRemainingResults.AccommodationSearch', function(event){
            //console.log('appendRemainingResults', event);
            _self.appendRemainingResults();
        });
        //filter triggered event to update the geo markers
        $(document).bind('updateGeoMarkers.ResultFilter', function(event, hotelIds) {
            _self.updateGeoMarkers(hotelIds);
        });

        $(document).on('click', '.clearTypeaheadAddress', function(event)
        {
            if($('#address').val()!=''){
                _self.clearAddress(true);
            }
        });

        if(document.location.href.indexOf('doSearch') != -1)
        {
            //check if the request is coming from umrah or one single hotel => fastSearch is false
            var fromFastSearch = true;
            if(IS_UMRAH_CUSTOMER === '1' || document.location.href.indexOf('PSearchType=hotel') != -1) {
                fromFastSearch = false;
            }

            setTimeout(function(){
                _self.searchCallBack(undefined, fromFastSearch);
            }, 25);
        }
        else {
            if(typeof(Storage) !== "undefined") {
                if (localStorage.getItem('localStorageObject')) {
                    Compare.checkCompareListStorage();
                }
            }
        }

        $(document).on('focusout', '.search_textbox_field', function () {
            if ($('.guest_form_container').length > 5) {
                $('.btn-copy-passenger-ci').trigger('click');
            }
        });

        $(document).on('click', '.btn-copy-passenger-ci', function(ev) {
            ev.preventDefault();
            let parent = $(this).parent('div');
            let title = parent.find('select[name^="title"]').val();
            let fname = parent.find('input[name^="firstName"]').val();
            let lname = parent.find('input[name^="lastName"]').val();
            let cpc = parent.find('input[name^="countryPhoneCode"]').val();
            let cpcText = parent.find('input[name^="textPhoneNumberCountryCode"]').val();
            let pn = parent.find('input[name^="phoneNumber"]').val();
            let email = parent.find('input[name^="email"]').val();

            let p = 'a';
            $('[id^="pbcpRoom"]')
                .not(parent)
                .each(function(i, el)
                {
                    let suffix = '';
                    let e_title = $(el).find('select[name^="title"]');
                    let e_fname = $(el).find('input[name^="firstName"]');
                    let e_lname = $(el).find('input[name^="lastName"]');
                    let e_cpc   = $(el).find('input[name^="countryPhoneCode"]');
                    let e_cpcText = $(el).find('input[name^="textPhoneNumberCountryCode"]');
                    let e_pn    = $(el).find('input[name^="phoneNumber"]');
                    let e_email = $(el).find('input[name^="email"]');

                    suffix = p;
                    p = nextLetter(p);
                    if (i > 24) {
                        p = p + i;
                    }
                    e_title.val(title);
                    e_fname.val(fname + ' ' + suffix);
                    e_lname.val(lname + ' ' + suffix);
                    e_cpc.val(cpc);
                    e_cpcText.val(cpcText);
                    e_pn.val(pn);
                    e_email.val(email);

                });

        });

        $(window).scroll(function () {
            if (_self.shouldInsertFullSearchResults()) {
                _self.insertFullSearchResults();
            }

            const popupElement = $('div.lefttooltip .popover-content');

            if (popupElement.length && !checkVisible(popupElement)) {
                $('.lefttooltip').remove();
            }
        });
    },
    sendPDFHandler: function () {
        $('.modal-backdrop').css({
            position: 'fixed',
            top: 0,
            bottom: 0
        });
        $('.email-form-container').toggle();
    },
    shouldInsertFullSearchResults: function() {
        return Accommodation.Search.isLoadingMoreResultsLoaderInViewport();
    },
    isLoadingMoreResultsLoaderInViewport: function() {
        var jqLoader = $('.app-loading-more-results');
        if (!jqLoader.length) return false;
        var rect = jqLoader[0].getBoundingClientRect();
        var elemTop = rect.top;
        var elemBottom = rect.bottom;

        return (elemTop >= 0) && (elemBottom <= window.innerHeight);
    },
    getCancellationRulesHtmlFromJson: function(json)
    {
		if(typeof json === 'undefined' || json.length <= 0) {
            return '';
        }
        json = $.parseJSON(json);
        var $tmpl = '';
        $.each(json, function( index, value )
        {
            if(typeof value.t !== 'undefined') {
                var html = $('#' + value.t + 'Template').html();
                $tmpl += Mustache.render(html, value) + '<br class="clear" />';
            }
        });
        return $tmpl;
    },
    disableRow: function(row)
    {
        $('select, input', row).each(function(){
            var $this = $(this);
            $this.prop('disabled', 'disabled');
            if($this.data('selectpicker')) {
                $this.selectpicker('refresh');
            }
            // this part of code delete nationality content field when is added more than one
            // room from customer interface. This prevent populate nationaitly field with default value
            /*if($this.attr('name').match(/nationality/g))
            {
                $this.parent().find('.clearTypeahead').click();
            }*/
        });
        row.hide();
    },
    enableRow: function(row)
    {
        var _self = Accommodation.Search;

        $('select, input', row).each(function(){
            var $this = $(this);
            $this.prop('disabled', false);
            if($this.data('selectpicker')) {
                $this.selectpicker('refresh');
            }
            if($this.attr('name').match(/childrenCount/g))
            {
                _self.updateChildren($this);
            }
        });

        row.show();
    },
    insertRooms: function()
    {
        var index = parseInt($('#searchRoomsNo').val(), 10);
        var roomsForGroupRate = 30
        if (typeof IS_UMRAH_CUSTOMER !== "undefined" && Boolean(IS_UMRAH_CUSTOMER) === true && typeof IS_GROUP_RATE_SEARCH !== 'undefined' && IS_GROUP_RATE_SEARCH !== null) {
            roomsForGroupRate = IS_GROUP_RATE_SEARCH
        }

        for(var i = 1; i <= roomsForGroupRate; i++)
        {
            if(i <= index) {
                this.enableRow($('#search_row' + i));
            }
            else {
                this.disableRow($('#search_row' + i));
            }
        }
    },
    updateChildren: function(element)
    {
        var index = parseInt($(element).val(), 10);

        var i = 0;
        $('.childrenAgesHolder input', $(element).parent().parent()).each(function(){
            if(i < index)
            {
                $(this).show();
            }
            else
            {
                $(this).val('3');
                $(this).hide();
            }
            i++;
        });

        this.updateChildrenLabel();
    },
    updateChildrenLabel : function()
    {
        var childrenCount = 0;
        $('#searchForm [name*="childrenCount"]').each(function(){
            childrenCount += parseInt($(this).val(), 10);
        });
        if(childrenCount > 0)
        {
            $('#search_row1 .childrenAgesHolder label').show();
        }
        else
        {
            $('#search_row1 .childrenAgesHolder label').hide();
        }
    },

    selectAddress : function ()
    {
        var _self = Accommodation.Search;
        // Get the place details from the autocomplete object.
        var place = _self.geoAutocomplete.getPlace();

        $('input[name="latitude"]').val(place.geometry.location.lat());
        $('input[name="longitude"]').val(place.geometry.location.lng());

    },

    clearAddress : function (clearInput)
    {
        if(clearInput) {
            $('input[name="address"]').val('');
        }

        $('input[name="destination"]').val('');
        //$('input[name="destinationCity"]').val('');
        $('input[name="PSearchId"]').val('');
        $('input[name="PSearchType"]').val('');
        $('input[name="PLocationType"]').val('');
        $('input[name="destinationCountry"]').val('');

        $('input[name="latitude"]').val('');
        $('input[name="longitude"]').val('');
    },

    getExtendedInfo : function (accommodation)
    {
        $('.modal.fade.info.hotel-info').remove();
        var _self = Accommodation.Search;
        Loader.show(false, false);
        var accommodationId = $(accommodation).data('hotelid');
        var params = $('#searchForm').serialize();

        $.ajax({
            url: _self.getInfoUrl + '/' + accommodationId,
            dataType: 'html',
            type: "POST",
            async: true,
            data: params,
            statusCode: {
                302: function () {
                    window.location.href = BASE_CI_URL + '/login';
                }
            }
        }).done(function (result) {
            var InfoBox = new al('info');
            InfoBox.build();
            InfoBox.div.css('z-index', 9999);
            InfoBox.div.addClass('hotel-info');
            InfoBox.show(result, _self.labelsText.hotelInfo);
            $('input[name="apply_rates"]').bootstrapSwitch();
            $('input[name="adjust_cancellation"]').bootstrapSwitch();

            InfoBox.setWidth('75%');
            InfoBox.setMinWidth('700px');
        }).fail(function (xhr, err, errText) {
            // only show the alert if the status is not a redirect
            if(xhr.status != 302)
            {
                AlertError.show(xhr.responseText, _self.labelsText.error); //
            }
        }).always(function() {
            Loader.hide();
        });

    },
    sendToEmail: function (emailForm)
    {
        var _self = Accommodation.Search;
        var accommodationId = $(emailForm).data('accommodation_id');
        var params = $('#searchForm').serializeArray();
        var submitButton = $(emailForm).find('button[type="submit"]');
        var input = $(emailForm).find('input[name="sendToEmail"]');

        var emailData = $(emailForm).serializeArray();
        params = params.concat(emailData);

        $('.modal.fade.info.hotel-info').remove();

        $.ajax({
            url: _self.getSendToEmailUrl + '/' + accommodationId,
            type: "post",
            async: true,
            data: params,
            dataType: 'json',
            beforeSend: function () {
                Loader.show(false, false);
                $(submitButton).attr('disabled', true);
                $('.email-result-message').fadeOut().removeClass('alert-success alert-danger');
            },
            statusCode: {
                302: function () {
                    window.location.href = BASE_CI_URL + '/login';
                }
            }
        }).done(function (response) {
                if(response.html != undefined) {
                    AlertInfo.show(response.html);
                } else {
                    AlertInfo.show(trans('errors.occured'));
                }
                $('.modal').scrollTop(0);
            }
        ).always(function () {
                $(input).val('');
                $(submitButton).attr('disabled', false);
                Loader.hide(false, false);

            }
        ).fail(function (xhr, error, errorText) {
                if (xhr.status != 302) {
                    AlertInfo.show(trans('errors.occured'));
                    //AlertError.show(xhr.responseText, _self.labelsText.error);
                }
            }
        );
    },
    showPromoInfo: function(button)
    {
        var _self = Accommodation.Search;
        var InfoBox = new al('info');
        InfoBox.build();
        InfoBox.div.css('z-index', 9999);
        InfoBox.show(_self.getPromotionsHtmlFromJson($(button).next().val()), _self.labelsText.promotionsInfo);
        InfoBox.setWidth('600px');
        InfoBox.setModalBodyPadding('20px');
    },
    getPromotionsHtmlFromJson: function(json)
    {
        json = $.parseJSON(json);
        var $tmpl = '';
        $.each(json, function( index, value )
        {
            if(typeof value.t !== 'undefined') {
                var html = $('#' + value.t + 'Template').html();
                $tmpl += Mustache.render(html, value) + '<br class="clear" />';
            }
        });
        return $tmpl;
    },
    showRoomInfo: function(button)
    {
        var info = 'info';

        // clean the old block up
        $('.modal.fade.' + info).remove();

        var _self = Accommodation.Search;

        var hotelId = $(button).parents('.search-result_row').data('hotelid');
        var roomId = $(button).closest('.rdRow').data('roomid.1');
        var params = $('#searchForm').serialize();

        Loader.show(false, false);

        $.ajax({
            url: _self.getRoomDetailsUrl + '/' + hotelId + '/' + roomId, //getRoomDetailsUrl
            dataType: 'json',
            type: "POST",
            async: true,
            data: params,
            statusCode: {
                302: function () {
                    window.location.href = BASE_CI_URL + '/login';
                }
            }
        }).done(function (result) {
            if(typeof(result.html) != undefined){

                if(result.success == true) {
                    var InfoBox = new al(info);
                    InfoBox.build();
                    InfoBox.div.css('z-index', 9999);
                    InfoBox.show(result.html, $(button).closest('.rdRow').find('.roomTypeText').text());
                    InfoBox.setWidth('60%');
                    InfoBox.setMinWidth('700px');
                } else {
                    AlertError.show(result.html);
                }
            } else {
                AlertInfo.show(result,$(button).closest('.rdRow').find('.roomTypeText').text());
            }
        }).fail(function (xhr, err, errText) {
            if(xhr.status != 302)
            {
                AlertError.show(xhr.responseText, _self.labelsText.error);
            }
        }).always(function() {
            Loader.hide();
        });
    },
    showRoomMoreOptions: function()
    {
        var _self = this;
        $(document).on('click', 'div#content .roomMoreOptions', function(){
            $('div#content .moreOptionContainer').addClass('hidden');
            $(this).next().toggleClass('hidden');
        });

        $(document).mouseup(function (e)
        {
            var container = $(".roomMoreOptions").parent();

            if (!container.is(e.target))
            {
                $('div#content .moreOptionContainer').addClass('hidden');
            }
        });
		/**
         * add new item
         */
        $(document).on('click', 'div#content .addRoomToCompare', function(){
            var self = this;
            var $room =  $(this).parents('.rdRow');
            var hotelId =$(this).parents('.search-result_row').data('hotelid');
            var roomId = $room.data('roomid.1');
            var roomNo = $room.data('runno.1');
            var identifier = roomId+"_"+$room.data('board.1');
            var roomIndex = $(this).closest('.rooms-details').find('li a.addRoomToCompare').index(this);
            var dateToCompare = _self.getDataForCompare($room, roomIndex, identifier);
            // check if the browser is IE > 7 or other browser
            if (typeof(Storage) !== "undefined")
            {
                if (_self.roomPolicyStats.hotelData == 'noData')
                {
                    if (Compare.add(roomId, roomNo, dateToCompare))
                    {
                        if (dateToCompare['customDeleteKey'] == undefined) {
                            dateToCompare['customDeleteKey'] = $(this).parents('.rdRow').find("input[name='roomRndValue']").val();
                        }
                        $(this).attr('data-addedElement', dateToCompare['customDeleteKey']);
                        Accommodation.Search.updateRateNotes($room);
                        dateToCompare['selectedRoom'] = $($room).clone().wrap("<div />").parent().html();
                        dateToCompare['$hotel'] = $($room).closest('div.search-result_row').clone().wrap("<div />").parent().html();
                        var promo = $($room).find('input[name="promotionsJson"]');
                        if(typeof promo[0] !== 'undefined') {
                            dateToCompare['getPromotionRaw'] = '<div>' + _self.getPromotionsHtmlFromJson(promo.val()) + '</div>';
                        }
                        else {
                            dateToCompare['getPromotionRaw'] = '';
                        }
                        $(this).removeClass('addRoomToCompare').addClass('removeFromCompare');
                        $(this).empty().text(trans('compare.remove'));

                        Compare.addOrRemoveBckColor($room);

                        // get alocationDetails
                        Accommodation.Search.getAllocationDetails(
                            hotelId,
                            dateToCompare['tID'],
                            parseInt($('#searchRoomsNo').val(), 10),
                            dateToCompare['roomRunNo[1]'],
                            dateToCompare['roomTypeCode[1]'],
                            dateToCompare['roomRateRunNo[1]'],
                            dateToCompare['roomToken[1]']
                        );
                        dateToCompare['allocationDetails'] = Accommodation.Search.allocationDetails[1];
                        if (typeof(Storage) !== "undefined") {
                            Compare.addCompareListInStorage(dateToCompare);
                        }
                    }
                }
            }
            else
            {
                if (Compare.add(roomId, roomNo, dateToCompare))
                {
                    //console.log('qaz5');
                    if (dateToCompare['customDeleteKey'] == undefined) {
                        dateToCompare['customDeleteKey'] = $(this).parents('.rdRow').find("input[name='roomRndValue']").val();
                    }
                    $(this).removeClass('addRoomToCompare').addClass('removeFromCompare');
                    $(this).attr('data-addedElement', dateToCompare['customDeleteKey']);
                    $(this).empty().text(trans('compare.remove'));
                }
            }

        });
        /**
         * remove item
         */
        $(document).on('click', 'div#content .removeFromCompare', function(){
            var room = $(this).parents('.rdRow');
            var roomId = room.data('roomid.1');
            var roomNo = room.data('runno.1');
            var roomBoard = room.data('board.1');
            var customDeleteKey = $(this).attr('data-addedelement');
            if (Compare.remove(roomId, roomNo, customDeleteKey)) {
                $(this).removeClass('removeFromCompare').addClass('addRoomToCompare').removeAttr('data-addedElement');
                $(this).empty().text(trans('compare.add'));
                Compare.addOrRemoveBckColor(room, 'remove');
            }
        });
    },
	allocationDetails : [],
    getAllocationDetails: function (hotelId, tID, roomNo, roomRunNo, roomTypeCode, roomRateRunNo, roomToken)
    {
        var _self = this;
        $.ajax({
            url: BASE_CI_URL + '/accommodation/getAllocationDetails/',
            dataType: 'json',
            type: 'post',
            async: true,
            data: {
                _token: CSRF_TOKEN, roomInfo: {
                    'hotelId'        : hotelId,
                    'tID'            : tID,
                    'roomNo'         : roomNo,
                    'roomRunNo.1'    : roomRunNo,
                    'roomTypeCode.1' : roomTypeCode,
                    'roomRateRunNo.1': roomRateRunNo,
                    'roomToken.1'    : roomToken
                }
            },
            statusCode: {
                302: function () {
                    window.location.href = BASE_CI_URL + '/login';
                }
            }
        }).done(function (response) {
            if (response.success == true) {
                if (response.data['1'].length > 0) {
                    _self.allocationDetails = response.data;
                }
                else {
                    Compare.compareList = [];
                    Compare.removeLocalStorage('localStorageObject');
                    window.location.href = BASE_CI_URL + '/accomodation'
                }
            }

        }).fail(function (xhr, err, errText) {
            // only show the alert if the status is not a redirect
            if(xhr.status != 302)
    {
                AlertError.show(xhr.responseText, trans('booking.title.quotation'));
            }
        });
        return _self.allocationDetails;
    },
    addRoomToCompare: function (hotelId)
    {
        // remeber this
        var _self = this;
        // check if browseer support local storage
        if (typeof(Storage) !== "undefined") {
            if (this.roomPolicyStats.hotelData != undefined && this.roomPolicyStats.hotelData.length > 0 ) {
                var hotelsId = _self.roomPolicyStats.hotelData[0];
                var index = _self.roomPolicyStats.hotelData[1];
                var hotelGroup = $('#search-result_rows').find('#hotel_' + hotelsId + '_row');
                var searchDetailsContainer = $(hotelGroup).children('.search-details-container');
                var roomDetailsContainer = $(searchDetailsContainer).children('.rooms-details');
                var roomDetails = $(roomDetailsContainer).children('.rdRow');
                if (roomDetails.length > 0) {
                    $.each(roomDetails, function (idx, el) {
                        if (idx == index) {
                            var $room = $(el);
                            var roomId = $room.data('roomid.1');
                            var roomNo = $room.data('runno.1');
                            var dateToCompare = _self.getDataForCompare($room, index);
                            if (Compare.add(roomId, roomNo, dateToCompare)) {
                                var link = $room.children('.rdrLast').find('ul.dropdown-menu-right li a.addRoomToCompare');
                                if (dateToCompare['customDeleteKey'] == undefined) {
                                    dateToCompare['customDeleteKey'] = $(link).parents('.rdRow').find("input[name='roomRndValue']").val();
                                }
                                dateToCompare['urlSearch'] = Accommodation.Search.removeURLParameter(window.location.href.substr(window.location.href.indexOf("?") + 1));
                                Accommodation.Search.updateRateNotes($room);
                                dateToCompare['selectedRoom'] = $($room).clone().wrap("<div />").parent().html();
                                dateToCompare['$hotel'] = $($room).closest('div.search-result_row').clone().wrap("<div />").parent().html();
                                var promo = $($room).find('input[name="promotionsJson"]');
                                if(typeof promo[0] !== 'undefined') {
                                    dateToCompare['getPromotionRaw'] = _self.getPromotionsHtmlFromJson(promo.val());
                                }
                                else {
                                    dateToCompare['getPromotionRaw'] = '';
                                }
                                $(link).removeClass('addRoomToCompare').addClass('removeFromCompare');
                                $(link).attr('data-addedElement', dateToCompare['customDeleteKey']);
                                $(link).empty().text(trans('compare.remove'));
                                if (typeof(Storage) !== "undefined") {
                                    Compare.addCompareListInStorage(dateToCompare);
                                }
                            }
                        }
                    })
                }
            }
            // empty object
            _self.roomPolicyStats = {};
        }

        if (Compare.compareList.length > 0) {
            if (Compare.compareList.length == 4) {
                $('.addRoomToCompare').empty().text(trans('compare.max'));
            }
            $.each(Compare.compareList, function(idx, elem) {
                var listHotelId = elem.hotelId;
                if (hotelId == listHotelId ) {
                    var $room = $('#hotel_' + listHotelId + '_row').
                        find('.rdRow[data-roomid\\.1="' + elem.roomId  + '"][data-board\\.1="' + elem.boardBasisCode + '"][data-roomformattedprice\\.1="' + elem.price + '"]');
                    var link = $room.children('.rdrLast').find('ul.dropdown-menu-right li a.addRoomToCompare');
                    $(link).attr('data-addedElement', elem.customDeleteKey);
                    $(link).removeClass('addRoomToCompare').addClass('removeFromCompare');
                    $(link).empty().text(trans('compare.remove'));
                    Compare.addOrRemoveBckColor($room);
                }
            });
        }

    },
    removeURLParameter: function (url)
    {
        var queryParameters = {}, re = /([^&=]+)=([^&]*)/g, m;
        while (m = re.exec(url)) {
            queryParameters[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
        }
        // Add new parameters or update existing ones
        queryParameters['hotelName'] = '';
        queryParameters['destinationCountry'] = '';
        queryParameters['productCode'] = '';
        return $.param(queryParameters);
    },
    updateRateNotes: function($room)
    {
        var rateNotes = $room.find('.rdrRight .icon-notes');
        if(rateNotes.data('title') != null && rateNotes.data('content') == null)
        {
            var pos = rateNotes.data('content-position');
            var notes = $room.parents('.search-result_row').find('input[name="tariffNotesRoom"]').val();
            notes = notes.substring(pos);
            pos = notes.indexOf('!#@#!');
            //rateNotes.data('content', notes.substring(0, pos));

            newHtml = rateNotes[0].outerHTML;
            newHtml = newHtml.substr(0, newHtml.length - 8);
            newHtml += ' data-content="' + notes.substring(0, pos) + '"></span>';
            rateNotes.replaceWith(newHtml);
        }
    },
    getDataForCompare: function($room, roomIndex, identifier)
    {
        var _self = this;
        var data   = {};
        var $hotel = $room.parents('.search-result_row');

        var roomId = Hotel.getRoomId($room);
        var roomNo = Hotel.getRoomNo($room);
        var boardBasisCode = Hotel.getRoomBoardBasisCode($room);
        var hotelId= $hotel.data('hotelid');

        data['hotelId'] = hotelId;
        data['roomCode'] = roomId + '-' + roomNo;
        data['roomId'] = roomId;
        data['roomNo'] = roomNo;
        data['imagePath'] = Hotel.getImagePath($hotel);
        data['hotelName'] = Hotel.getHotelName($hotel);
        data['location'] = Hotel.getHotelLocation($hotel);

        data['starRate'] = Hotel.getHotelStarRateHtml($hotel);
        data['roomTypeName'] = Hotel.getRoomType($room);
        data['roomOccupancy'] = Hotel.getRoomOccupancy($room);
        data['roomOccupancyRaw'] = Hotel.getRoomOccupancyRaw($room);
        data['roomPolicyRow'] = Hotel.getRoomPolicyRaw($room);
        data['boardBasis'] = Hotel.getRoomBoardBasis($room);
        data['boardBasisCode'] = boardBasisCode;
        data['showbooknow'] = ((parseInt(Hotel.getRoomsCount($room)) == 1));
        data['onrequest'] = $room.data('onrequest.1');
        data['locationName'] = Hotel.getHotelLocationName($hotel);
        data['urlSearch'] = this.removeURLParameter(window.location.href.substr(window.location.href.indexOf("?") + 1));
        data['roomRunNo'] = $room.data('roomrunno.1');
        data['matchingSearch'] = $('#matchingSearch').val();

        data['tID'] = $room.data('tid');
        data['tokenCreationTime'] =$('#tokenCreationTime').val();
        data['roomChangedOccupancy[1]'] = $room.data('changedoccupancy.1') != '' ?  $room.data('changedoccupancy.1') : '0';
        data['aprcurrencyid.1'] = $room.data('aprcurrencyid.1');
        data['roomToken[1]'] = $room.data('allocationdetails.1');
        data['roomRateRunNo[1]'] = $room.data('runno.1');
        data['roomRunNo[1]'] = $room.data('roomrunno.1');
        data['roomTypeCode[1]'] = $room.data('roomid.1');

        //data['destinationCity'] = $('input[name = "destinationCity"]').val();
        data['PSearchId'] = $('input[name = "PSearchId"]').val();
        data['PSearchType'] = $('input[name = "PSearchType"]').val();
        data['PLocationType'] = $('input[name = "PLocationType"]').val();
        data['nationality[1]'] = $('input[name = "nationality[1]"]').val();
        data['nationalityText'] = $('input[name = "textNationality[1]"]').val();
        data['url'] = window.location.href;

//        data['getPromotionRaw'] = Hotel.getPromotionRaw($room);

        Hotel.getRoomAmenitiesHtml(hotelId,roomId, function(html) {
            data['roomAmenities']  = ((html) ? html : "<i>none</i>");
        });

        var roomPolicyHtml = Hotel.getRoomPolicyHtml($room,data);
        // is false when the room policy have value "click to view deadline"
        if(!roomPolicyHtml) {
            _self.roomPolicyStats = {hotelData : 'prepareToSet'};
            var $roomPolicy = $room.find('.roomPolicy');
            Accommodation.Search.loadMoreBoards(hotelId,$roomPolicy.find('span'),false,roomIndex, identifier,function(html) {
                if(!html) {
                    // Hmm Error. Changed my mind remove room from compare list
                    Compare.remove(roomId,roomNo);
                }
                else
                {
                    var $updatedRoom = $(html).find("[data-roomid\\.1='" + roomId + "']:first");
                    if (typeof $updatedRoom.html() === "undefined") {
                        Compare.remove(roomId, roomNo);
                    }
                    else
                    {
                        roomPolicyHtml = Accommodation.Search.getCancellationRulesHtmlFromJson($updatedRoom.find('input[name="cancellationRulesJson"]').val());
                        roomPolicyHtml = $(roomPolicyHtml).find('.criLegend').first().text();
                        //roomPolicyHtml = $updatedRoom.find('.cancellationRulesInfo').find('.criLegend').first().text();
                        data['roomPolicy'] = ((typeof roomPolicyHtml != 'undefined') ? roomPolicyHtml : "<i>none</i>");
                        Loader.hide();
                    }
                }
            });
        } else {
            data['roomPolicy']  = (roomPolicyHtml.length > 0 ? roomPolicyHtml : '<i>none</i>');
            _self.roomPolicyStats = {hotelData : 'noData'};
            setTimeout(function() {Loader.hide();}, 200);
        }

        data['rateType'] = Hotel.getRoomRateType($room);
        data['rateTypeNumeric'] = Hotel.getRoomRateTypeNumeric($room);
        data['promotions'] = Hotel.roomHasPromotions($room);
        data['promotionsHtml'] = Hotel.getRoomPromotionsHtml($room);
        data['currency'] = Hotel.getCurrency($room);
        data['price'] = Hotel.getRoomPrice($room);
        data['searchFormS'] = $('#searchForm').serializeObject();
        return data;
    },
    filterCancellationTypes: function()
    {
        var withinCancCnt = 0;
        var nonRefCnt = 0;
        var roomDeadlines = $('.ai-room_deadline_status');
        if (roomDeadlines.length == 0) {
            return;
        }

        $.each(roomDeadlines, function (index, room)
        {
            var roomCancellationType = $(room).data('cancellation');
            if(roomCancellationType == "deadline"){
                withinCancCnt++;
            } else if(roomCancellationType == "refundable"){
                nonRefCnt++
            }
        });

        if(nonRefCnt == roomDeadlines.length){
            $("select[name='cancellation_type'] option[value!='0']").hide();
        }
        if(withinCancCnt == roomDeadlines.length){
            $("select[name='cancellation_type'] option[value='2']").hide();
            $("select[name='cancellation_type'] option[value!='2']").show();
        }
        if(nonRefCnt + withinCancCnt >= roomDeadlines.length){
            $("select[name='cancellation_type'] option[value='2']").hide();
            $("select[name='cancellation_type'] option[value='3']").hide();
            $('select[name="cancellation_value"]').attr('readonly', true);
        }
    },
    showPricePerDayInfo: function(button)
    {
        var _self = Accommodation.Search;

        var elem = 'div';
        if(isOldIE() == 7) {
            elem = '';
        }

        var container = $(button).closest(elem +'.rdRow').next();
        var table = container.find('.pricePerDay');
        var hideDailyBreakUpText = $('#breakUpText').data('hidebreakup');
        var showDailyBreakUpText = $('#breakUpText').data('showbreakup');

        if(typeof table[0] === 'undefined')
        {
            var hotelId = $(button).parents('.search-result_row').data('hotelid');
            var x = $(button).closest('.rdRow');

            var roomId = x.data('roomid.1');
            var roomRunno = x.data('roomrunno.1');
            var rateRunno = x.data('runno.1');
            var tId = x.data('tid');

            Loader.show(false, false);

            $.ajax({
                url: _self.getDailyRatesUrl + '/' + tId + '/' + hotelId + '/' + roomRunno + '/' + roomId + '/' + rateRunno,
                dataType: 'json',
                type: "get",
                async: true,
                statusCode: {
                    302: function () {
                        window.location.href = BASE_CI_URL + '/login';
                    }
                }
            }).done(function (result)
            {

                if(result.success === false || result.html === "")
                {
                    AlertInfo.show(result.html != '' ? result.html : _self.labelsText.noRatesFound, $(button).closest('.rdRow').find('div').first().text());
                    return;
                }
                else
                {
                    container.html(result.html);

                    table = container.find('.pricePerDay');
                    table.width(container.width());
                    table.show();
                    container.height(table.height() + 1);

                    _self.displayedDailyRates.push(container[0]);
                    $(button).text(hideDailyBreakUpText);
                }

            }).fail(function (xhr, err, errText) {
                if(xhr.status != 302)
                {
                    AlertError.show(xhr.responseText, _self.labelsText.error);
                }
            }).always(function() {
                Loader.hide();
            });
        }
        else
        {
            if(table.css('display') == 'block')
            {
                table.hide();
                container.css('height', 'auto');

                _self.displayedDailyRates = $.grep(_self.displayedDailyRates, function(value) {
                    return value != container[0];
                });

                $(button).text(showDailyBreakUpText);
            }
            else
            {
                table.width(container.width());
                table.show();
                container.height(table.height() + 1);

                _self.displayedDailyRates.push(container[0]);
                $(button).text(hideDailyBreakUpText);
            }
        }
    },
    showRoomPricePerDayInfo: function(tId, hotelId, roomRunno, roomId, rateRunno, divId )
    {
        var _self = Accommodation.Search;

        Loader.show(false, false);
        $.ajax({
            url: _self.getDailyRoomRatesUrl + '/' + tId + '/' + hotelId + '/' + roomRunno + '/' + roomId + '/' + rateRunno,
            dataType: 'json',
            type: "get",
            async: true,
            statusCode: {
                302: function () {
                    window.location.href = BASE_CI_URL + '/login';
                }
            }
        }).done(function (result)
        {
            if(result.success === false || result.html === "")
            {
                AlertInfo.show(result.html != '' ? result.html : _self.labelsText.noRatesFound);
                return;
            }
            else
            {
                $('#'+divId).html(result.html);

            }

        });
    },
    resizedFilterMobileMenu : function()
    {
        for(var i = 0; i < this.displayedDailyRates.length; i++)
        {
            var price = $(this.displayedDailyRates[i]);
            var table = price.find('.pricePerDay');
            if(table.css('display') == 'block')
            {
                table.width(price.width());
            }
        }
    },
    beginApplyFiltersResultFilter : function()
    {
        for(var i = 0; i < this.displayedDailyRates.length; i++)
        {
            var price = $(this.displayedDailyRates[i]);
            price.css('height', 'auto');
            price.find('.pricePerDay').hide();
        }
        this.displayedDailyRates.length = 0;
    },
    appendRemainingResults : function()
    {
        var _self = Accommodation.Search;

        if(_self.remainingResults === null)
        {
            setTimeout(function(){_self.appendRemainingResults();}, 250);
        }
        else if(_self.remainingResults != 'loaded')
        {
            //Loader.show(false, false);
            //console.time('append results');
            $('#search-result_rows').append(_self.remainingResults);
            //console.timeEnd('append results');
            _self.remainingResults = 'loaded';
            _self.prepareGoogleBigMap();
            if(typeof google === 'undefined' || typeof google.maps === 'undefined') {
                $('div#content .mapIcon').hide();
            }
            $(document).trigger('EndAppendRemainingResults.AccommodationSearch');
            //Loader.hide();
        }
        // Hotel description fix only for IE7
        IE_hotelDesc_fix();
    },
    showMoreBoards : function(button)
    {
        var _self = Accommodation.Search;
        var $button = $(button);
        var elem = 'div';
        if(isOldIE() == 7) {
            elem = '';
        }
        var showLessLabel = _self.labelsText.showLess;
        var showMoreLabel = _self.labelsText.showMore;
        if (typeof IS_UMRAH_CUSTOMER === "undefined" || Boolean(IS_UMRAH_CUSTOMER) === false) {
            showLessLabel = _self.labelsText.hideRooms;
            showMoreLabel = _self.labelsText.showRooms;
        }

        if(typeof SHOW_NEW_SEARCH_FORMAT == "undefined" || Boolean(SHOW_NEW_SEARCH_FORMAT) === false) {
            if (parseInt($button.data('rooms'), 10) <= 3) {
                return;
            }
        }
        var $roomsContainer = $button.parent().parent();

        if ($('#isSinglePage').length > 0) {
            var $hiddenRooms = $roomsContainer.find(elem + '.rdRow.hidden').filter(':not(.notInFilterRangeBoardBasis, .notInFilterRangeRateType, .notInFilterRange )');
        }else {
            var $hiddenRooms = $roomsContainer.find(elem + '.rdRow.hidden').filter(':not(.notInFilterRangeBoardBasis, .notInFilterRangeRateType)');
        }

        if (typeof SHOW_NEW_SEARCH_FORMAT !== "undefined" && Boolean(SHOW_NEW_SEARCH_FORMAT) === true) {
            $(button).parent().find('.available-rooms-btn').hide();
            $(button).parent().find('.hide-rooms-btn').show();
            $hiddenRooms.removeClass('hidden');
            $roomsContainer.find('.rooms-details').show();
            $roomsContainer.find('.mrbnContainer').show();
        } else {
            if ($hiddenRooms.length > 0) {
                $hiddenRooms.removeClass('hidden');
                $button.val(showLessLabel);
                $button.addClass('showLess');
            } else {
                if ($('#isSinglePage').length > 0) {

                    $roomsContainer.find('.rooms-details').each(function () {
                        $(this)
                            .find(elem +'.rdRow')
                            .addClass('hidden')
                            .filter(':not(.notInFilterRangeBoardBasis, .notInFilterRangeRateType, .notInFilterRange ):lt(3)')
                            .removeClass('hidden');
                    });
                }else{

                    $roomsContainer.find('.rooms-details').each(function () {
                        $(this)
                            .find(elem +'.rdRow')
                            .addClass('hidden')
                            .filter(':not(.notInFilterRangeBoardBasis, .notInFilterRangeRateType):lt(3)')
                            .removeClass('hidden');
                    });
                    if (typeof IS_UMRAH_CUSTOMER === "undefined" || Boolean(IS_UMRAH_CUSTOMER) === false) {
                        $roomsContainer.find('.rooms-details').hide();
                    }
                }

                $button.val(showMoreLabel);
                $button.removeClass('showLess');

                //hide daily rates - if any
                for(var i = 0; i < _self.displayedDailyRates.length; i++)
                {
                    var $price = $(_self.displayedDailyRates[i]);
                    $price.css('height', 'auto');
                    $price.find('.pricePerDay').hide();
                }
                _self.displayedDailyRates.length = 0;
            }
        }

        checkForSorting();
        removeBookingButton();

    },
    loadMoreBoards : function(hotelId, element, forceLoad, roomIndex, identifier, callback, async)
    {
        var _self = Accommodation.Search;
        var elem = 'div';
        var method ='get';
        if(isOldIE() == 7) {
            elem = '';
        }
        if(typeof forceLoad === 'undefined') {
            forceLoad = false;
        }
        var insertionPoint = $(element).closest(elem +'.search-details-container').children(elem +'[name="roomsInsertionPoint"]');
        if(!forceLoad && insertionPoint.data('alreadyLoaded') === true)
        {
            _self.showMoreBoards(element);
            return;
        }

        var $room = $(element).closest('.rdRow');
        var roomData = {hotelId: hotelId, groupedRoomsNo: $room.closest('.rooms-details').data('groupedroomsno'), roomId: $room.data('roomid.1'), board: $room.data('board.1'), onRequest: $room.data('onrequest.1')};

        Loader.show();
        var params = $('#searchForm').serialize();
        if (typeof IS_UMRAH_CUSTOMER !== "undefined" && Boolean(IS_UMRAH_CUSTOMER) === true && typeof IS_GROUP_RATE_SEARCH !== 'undefined' && IS_GROUP_RATE_SEARCH > 5) {
            method ='post';
        }
        $.ajax({
            url: _self.getRoomsUrl + '/' + hotelId,
            dataType: 'html',
            type: method,
            async: typeof async === 'undefined' ? true : async,
            data: params + '&matchingSearch=' + $('#matchingSearch').val(),
            statusCode: {
                302: function () {
                    window.location.href = BASE_CI_URL + '/login';
                }
            }
        }).done(function (result) {
            insertionPoint.siblings('.rooms-details, .mrbnContainer, input[name="searchedRooms"], .transactionID').remove();
            $(result).insertAfter(insertionPoint);
            insertionPoint.data('alreadyLoaded', true);
            var htmlResponse = $(result).find('.rdRow');

            // check if browser is Ie < 7 or other Browser
            if (typeof(Storage) !== "undefined") {
                $.each(htmlResponse, function(idx, el){
                    var responseRoomId = $(el).data('roomid.1');
                    var responseBoard = $(el).data('board.1');
                    var uniqueId = responseRoomId + "_" + responseBoard;
                    if (uniqueId == identifier) {
                        if (_self.roomPolicyStats.hotelData == 'prepareToSet'){
                            _self.roomPolicyStats = {hotelData : [
                                hotelId, idx, uniqueId
                            ]};
                        }
                    }
                });
                Accommodation.roomPolicyStats = {hotelData : 'prepareToSet'};
                Accommodation.Search.addRoomToCompare(hotelId);
            }
            if(!forceLoad) {
                ResultFilter.reloadFilterCounters(); //update board basis filter
            }
            var roomCount = $(result).find('.rdRow').length;
            var hiddenRows = $(result).find('.rdRow.hidden').length;
            $(element).data('rooms', roomCount);

            if (typeof SHOW_NEW_SEARCH_FORMAT !== "undefined" && Boolean(SHOW_NEW_SEARCH_FORMAT) === true) {
                var hotelDivID = 'hotel_'+hotelId+'_row';
                $('#'+hotelDivID).find('.available-rooms-btn').hide();
                $('#'+hotelDivID).find('.hide-rooms-btn').show();
                $('#'+hotelDivID).find('.rooms-details').show();
            } else {
                if (parseInt($(element).data('rooms'), 10) > 3) {
                    var showMoreLabel = _self.labelsText.showMore;
                    if (typeof IS_UMRAH_CUSTOMER === "undefined" || Boolean(IS_UMRAH_CUSTOMER) === false) {
                        showMoreLabel = _self.labelsText.showRooms;
                    }
                    $(element).val(showMoreLabel);
                    $(element).addClass('showMore');
                } else {
                    $(element).hide();
                }
            }

            $('#hotel_' + hotelId + '_row').find('.price-range').find('.search_btn').data('rooms', roomCount);

            if(typeof(callback) == 'function'){
                callback(result, roomData);
            }

            _self.showMoreBoards(element);

        }).fail(function (xhr, err, errText) {
            // only show the alert if the status is not a redirect
            if(xhr.status != 302)
            {
                if(typeof(callback) == 'function'){
                    callback(false);
                }
                AlertError.show(xhr.responseText, _self.labelsText.error);
            }
        }).always(function() {
            Loader.hide();
        });
    },
    displayUpdatedCancellationPopUp: function(result, roomData)
    {
        if(typeof roomData === 'undefined') {
            return;
        }
        var $room = $('#hotel_' + roomData.hotelId + '_row').
            find('.rooms-details[data-groupedroomsno="' + roomData.groupedRoomsNo + '"]').
            find('.rdRow[data-roomid\\.1="' + roomData.roomId + '"][data-board\\.1="' + roomData.board + '"][data-onrequest\\.1="' + roomData.onRequest + '"]');
        if(typeof $room[0] !== 'undefined')
        {
            $room.find('.cancelInfoIcon').first().focus().mouseover();
        }
    },
    showMoreDescInit : function(button)
    {
        var _self = Accommodation.Search;
        Loader.show(false, false);
        var accommodationId = $(button).parents('.search-result_row').data('hotelid');
        var params = $('#searchForm').serialize();
        params += '&getMeJustTheDescription=1';

        $.ajax({
            url: _self.getInfoUrl + '/' + accommodationId,
            dataType: 'html',
            type: "POST",
            async: true,
            data: params,
            statusCode: {
                302: function () {
                    window.location.href = BASE_CI_URL + '/login';
                }
            }
        }).done(function (result)
        {
            var parent = $(button).parents('p');
            parent.html(result);
            parent.find('.showMoreDesc').click();
        }).fail(function (xhr, err, errText) {
            // only show the alert if the status is not a redirect
            if(xhr.status != 302) {
                AlertError.show(xhr.responseText, _self.labelsText.error); //
            }
        }).always(function() {
            Loader.hide();
        });
    },
    showMoreHotelDetails : function(button)
    {
        var showMore=$(button).data('show-text');
        var showLess=$(button).data('hide-text');
        var _self = Accommodation.Search;
        if( hotel_info_hidden != '' ) {
            Loader.show(false, false);
            var parent = $(button).parents('p');
            parent.html(_self.hotelInfoObj.val() + '<span class="showLessDetailsDesc" data-show-text="'+showMore+'" data-hide-text="'+showLess+'" > '+showLess+' </span>');
            Loader.hide();
        }
    },
    showLessDetailsDesc : function (button) {
        Loader.show(false, false);
        var showMore=$(button).data('show-text');
        var showLess=$(button).data('hide-text');
        var _self = Accommodation.Search;
        var update_txt = _self.subText(_self.hotelInfoObj.val(), _self.hotelDescLen );
        var parent = $(button).parents('p');
        parent.html(update_txt + '<span class="showMoreHotelDetails" data-show-text="'+showMore+'" data-hide-text="'+showLess+'" > '+showMore+'</span>');
        _self.wCountObj.val(1);
        Loader.hide();

    },
    subText: function (str, mx) {
        //trim the string to the maximum length
        var trimmedString = str.substr(0, mx);
        //re-trim if we are in the middle of a word
        trimmedString = trimmedString.substr(0, Math.max(trimmedString.length, trimmedString.lastIndexOf(" ")));
        return trimmedString;
    },
    showMoreDesc : function(button)
    {
        $(button).hide().next().removeClass('hidden').find('.showLessDesc').show();
    },
    showLessDesc : function(button)
    {
        $(button).hide().parent().addClass('hidden').parent().find('.showMoreDesc').show();

    },
    cleanResultsAfterUserChangingFieldValue: function(event, element)
    {
        var _self = Accommodation.Search;
        if(!_self.searchPerformed)
        {
            return;
        }
        _self.searchPerformed = false;

        $.ajax({
            url: _self.getOffersUrl,
            dataType: 'html',
            type: "get",
            async: true,
            statusCode: {
                302: function () {
                    window.location.href = BASE_CI_URL + '/login';
                }
            }
        }).done(function (result) {
            $(_self.container).empty().append(result);
            $('.shoppingcart_container .total').addClass('hidden');

            /* Calling the carousels here */
            if(document.getElementById('landingCarousel') && document.getElementById('landingCarousel2')) { // Checking if the id exists
                /* First Carousel */
                $('#landingCarousel').carousel({
                    interval: false,
                });
                $('#landingCarousel2').carousel({
                    interval: false,
                });
                /** Script for first carousel with two items */
                $('.carousel.carousel1 .item').each(function () {
                    var next = $(this).next();
                    var minPerSlide = 0;
                    if (!next.length) {
                        next = $(this).siblings(':first');
                    }
                    next.children(':first-child').clone().appendTo($(this));
                    for (var i = 0; i < minPerSlide; i++) {
                        next = next.next();
                        if (!next.length) {
                            next = $(this).siblings(':first');
                        }
                        next.children(':first-child').clone().appendTo($(this));
                    }
                });
                $('.carousel.carousel2 .item').each(function () {
                    var next = $(this).next();
                    var minPerSlide = 1;
                    if (!next.length) {
                        next = $(this).siblings(':first');
                    }
                    next.children(':first-child').clone().appendTo($(this));
                    for (var i = 0; i < minPerSlide; i++) {
                        next = next.next();
                        if (!next.length) {
                            next = $(this).siblings(':first');
                        }
                        next.children(':first-child').clone().appendTo($(this));
                    }
                });
            }
        }).fail(function (xhr, err, errText) {
            // only show the alert if the status is not a redirect
            if(xhr.status != 302)
            {
                $(_self.container).html('');
            }
        }).always(function() {
            if(typeof Compare !== "undefined") {
                if (Compare.compareList.length > 0){var keepList = true; }
                Compare.emptyList(keepList);
            }
            historyPushState("", "",window.location.href.replace(window.location.search,''));
        });
    },
    residencyAndNationalityTypeahead: function()
    {
        var Typeaheadcountries = new Bloodhound({
            datumTokenizer: function (d) {
                return Bloodhound.tokenizers.whitespace(d.value);
            },
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            remote        : {
                url: BASE_URL + '/' + ROUTE_FOLDER + '/autocomplete/search.php?query=%QUERY&l=%LANG&t=country',
                ajax   : {
                    beforeSend: function ()
                    {
                        if ($(document.activeElement).typeahead != null)
                        {
                            $(document.activeElement)
                                .activity({
                                    outside: true,
                                    align: 'right',
                                    width: 2,
                                    length: 2,
                                    color: '#ffffff'
                                });
                        }
                    },
                    complete: function ()
                    {
                        if ($(document.activeElement).typeahead != null) {
                            $(document.activeElement).activity(false);
                        }
                    }
                },
                replace: function (url, query)
                {
                    var backup = CI_PROXY_URL + '?c=Country&m=getCountryCodeNameArray&transformArr=0&query=%QUERY';
                    backup = backup.replace('%QUERY', encodeURIComponent(query));

                    return url.replace('%QUERY', encodeURIComponent(query))
                        .replace('%LANG', _currentLang)
                        + '&u=' + encodeURIComponent(backup);
                }
            },
            rateLimitWait : 100,
            limit         : 50,
            sorter:       function(a, b) {
                return a.index - b.index;
            }
        });

        Typeaheadcountries.initialize();

        $('#searchTaps')
            .find('.typeaheadFiled')
            .on('click', function() {
                $(this).select();
            })
            .typeahead(
            {
                minLength: 2,
                highlight: true,
                hint: false,
                autoSelect: true
            },
            {
                name: 'country',
                displayKey: 'value',
                source: Typeaheadcountries.ttAdapter(),
                templates: {
                    suggestion: function (ctx) {
                        ctx.value = ctx.value || ctx.text;

                        var siteUrl = BASE_URL + (ROUTE_FOLDER ? '/' + ROUTE_FOLDER : '');
                        var $flag = (ctx.flag && ctx.flag.length > 0 ? '<img src="' + siteUrl + '/_laravel/public/images/destination/country/flags/' + ctx.flag + '" alt="" style="width:40px; height:20px"/>' : '');

                        var $details_hint = '';

                        if (ctx.hint)
                        {
                            $details_hint += '<br><small>' +
                                ctx.hint.value +
                                '</small>';
                        }

                        return '<p>' +
                            $flag +
                            '&nbsp;&nbsp;' +
                            ctx.value +
                            $details_hint +
                            '</p>';
                    }
                }
            })
            .on('typeahead:selected typeahead:autocompleted', function (j, ctx)
            {
                if($('#isCriteriaChange').length > 0 )
                {
                    $('#isCriteriaChange').val(1)
                }
                var $parent = $(this).parents('.field_holder');
                $parent.find('.typeaheadSelectedValue').val(ctx['Id']);

                __typeaheadCallback(this, ctx);
            });

        var __typeaheadCallback = function(input, context) {
            if ($('#searchRoomsNo').val() < 3) {
                return;
            }

            var inputName = input.name.substring(0, input.name.indexOf('['));
            var label = $(input).parents('.field_holder').find('label').html().toLowerCase();

            bootbox.confirm({
                message: 'This will change ' + label + ' for all rooms/passengers. <br/>Do you want to proceed ?',
                title: label + ' filter change',
                buttons: {
                    cancel: {
                        label: trans('lang.button.no'),
                        className: 'btn-link btn-small',
                    },
                    confirm: {
                        label: trans('lang.button.yes'),
                        className: 'search_btn',
                    }
                },
                callback: function(result) {
                    if (result) {
                        $('#searchForm')
                            .find('[name^="' + inputName + '"]:visible')
                            .each(function(i, el) {
                                $(el).parents('.field_holder').find('.typeaheadSelectedValue').val(context['Id']);
                                $(el).val(context['value']);
                            });
                    }
                }
            });
        }

    },
    noViewRateOrBook: function()
    {
        var _self = Accommodation.Search;
        AlertError.show(makeAMessagePanel(_self.labelsText.noViewRateOrBook), _self.labelsText.error);
        return false;
    },
    noViewRateAndBook: function()
    {
        var _self = Accommodation.Search;
        AlertError.show(makeAMessagePanel(_self.labelsText.noViewRateAndBook), _self.labelsText.error);
        return false;
    },
    showLoadingMoreResultsLoader: function() {
        var siteUrl = BASE_URL + (FOLDER ? '/' + FOLDER : '');
        var html =
            '<div class="app-loading-more-results text-center">'
            + '<img src="' + siteUrl + '/_laravel/public/ci/images/splash-loader_.gif" width="60" height="64" />'
            + '</div>';
        var loader = $('.app-loading-more-results');
        if (loader.length) {
            loader.show();
        } else {
            $('.search-results').append(html);
        }
    },
    hideLoadingMoreResultsLoader: function() {
        $('.app-loading-more-results').hide();
    },
    insertFullSearchResults: function() {
        var _self = Accommodation.Search;
        if (_self.fullSearchResults) {
            var fullSearchResultsCopy = _self.fullSearchResults;
            _self.fullSearchResults = null;
            // we want to keep user at the same hotel which will be the last one
            var lastHotelId = $('.search-result_row:last').data('hotelid');
            _self.hideLoadingMoreResultsLoader();
            Loader.show();
            setTimeout(function(){
                // get current active filters
                var previousActiveFilters = ResultFilter.getActiveFilters();
                // price filter does not have to be re-applied
                delete previousActiveFilters.price;
                // get current filterHotelByName value
                var filterHotelByNameValue = ResultFilter.$filterHotelByName.val();
                // replace results and filters
                $(_self.container).html(
                    _self.mergeCurrentResultsWithFullSearchResponse(fullSearchResultsCopy)
                );

                _self.reloadTriggersForResults();
                // set previous filterHotelByName value
                ResultFilter.$filterHotelByName.val(filterHotelByNameValue);
                // apply previous active filters
                ResultFilter.applyFilters('reload', previousActiveFilters);
                // select previous active filters
                ResultFilter.selectFilters(previousActiveFilters);

                Loader.hide();
                if (lastHotelId && $('[data-hotelid=' + lastHotelId + ']').length) {
                    $('html,body').animate({scrollTop: $('[data-hotelid=' + lastHotelId + ']').offset().top}, 0);
                }
            }, 100);
        }
    },
    mergeCurrentResultsWithFullSearchResponse : function(fullSearchResultsHTML)
    {
        var jqFullSearchResults = $('<div class="tmp">' + fullSearchResultsHTML + '</div>');
        var jqFullSearchResultsRows = jqFullSearchResults.find('.search-result_row');
        var totalCount = jqFullSearchResultsRows.length;
        var fullSearchIds = jqFullSearchResultsRows
            .map(function() { return $(this).data('hotelid'); }).get();

        $('.search-result_row').each(function() {
            if ($.inArray($(this).data('hotelid'), fullSearchIds) === -1) {
                jqFullSearchResults = jqFullSearchResults
                    .find('#search-result_rows').prepend($(this))
                    .parents('.tmp').last();
                totalCount++;
            }
        });

        jqFullSearchResults.find('#resultsFoundCount').val(totalCount);

        return jqFullSearchResults.html();
    },
    searchCallBack : function(result, fromFastSearch = false)
    {
        var _self = Accommodation.Search;
        _self.fromFastSearch = fromFastSearch;

        _self.remainingResults = null;

        if(typeof result !== 'undefined')
        {
            $(_self.container).html(result);
        }

        IE_hotelDesc_fix();
        if (!fromFastSearch || $('#resultsFoundCount').val() > 0) {
            Loader.unlock();
        }

        if (!fromFastSearch) {
            $('#resultsFoundCountLabel').html('(' + $('#resultsFoundCount').val() + ')');
        }

        //console.time('body animate');
        if ($('#isSinglePage').length > 0) {
            if (focusstatus == true) {
                $('html,body').animate({scrollTop: $('#searchTaps').offset().top}, 750);
            }
            else {
                $('html,body').animate({scrollTop: $('#content > .row:first').offset().top}, 750);
            }
        }else {
            $('html,body').animate({scrollTop: $('#content > .row:first').offset().top}, 750);
            if(!fromFastSearch)
            {
                setTimeout(function(){
                    _self.loadRemainingResults();
                }, 1500);
            }
            else
            {
                setTimeout(function(){
                   _self.loadRemainingResultsFullRequest();
                }, 1500);
            }
        }

        //console.timeEnd('body animate');
        if(typeof google === 'undefined' || typeof google.maps === 'undefined') {
            $('#googleMiniMap').hide();
            $('div#content .mapIcon').hide();
        }
        //console.time('init filter');
        ResultFilter.minPrice = typeof $('#minimumPrice')[0] !== 'undefined' && $('#minimumPrice').val() != '' ? parseFloat($('#minimumPrice').val()) : 0;
        ResultFilter.maxPrice = typeof $('#maximumPrice')[0] !== 'undefined' && $('#maximumPrice').val() != '' ? parseFloat($('#maximumPrice').val()) : 0;
        ResultFilter.init();
        //console.timeEnd('init filter');

        //console.time('init sort');
        ResultsSortBy.init();
        //console.timeEnd('init sort');

        //console.time('init minimap');
        _self.initGoogleMiniMap();
        //console.timeEnd('init minimap');

        //console.time('init bigmap');
        setTimeout(function(){
            _self.prepareGoogleBigMap();
            ResultFilter.hasGeoMarkers = _self.geoMarkers;
            //console.timeEnd('init bigmap');
        }, 500);

        //console.timeEnd('Accommodation.Search.searchCallBack');
        _self.performedSearchData = $('#searchForm').serializeObject();
        _self.searchPerformed = ($('#resultsFoundCount').val() > 0 ? true : false);

        if($('#searchRoomsNo').val() >= 2){
            ShoppingCart.toggleBottom(true);
            Accommodation.Booking.updateThisGroup(null, null, true);
            $('.shoppingcart_container .total').removeClass('hidden');
        } else {
            ShoppingCart.toggleBottom(false);
        }

        // clear compare list
        if(typeof Compare !== "undefined")
        {
            if (Compare.compareList.length > 0){var accomodationCall = true; }
            Compare.emptyList(accomodationCall);
        }
        // get items from localstorage and update DOM
        if(typeof(Storage) !== "undefined") {
            if (localStorage.getItem('localStorageObject')) {
                Compare.checkCompareListStorage(true);
            }
        }
        checkForSorting();
        removeBookingButton();
    },
    loadRemainingResultsFullRequest : function() {
        var _self = Accommodation.Search;

        var params = $(_self.formId).serializeArray();
        params.push({'name': 'doSearch', 'value': 1});
        params.push({'name': 'fastSearch', 'value': 'no'});

        _self.showLoadingMoreResultsLoader();

        Loader.unlock();

        _self.remainingResultsFullRequest = $.ajax({
            url: _self.URL,
            dataType: 'html',
            type: 'POST',
            async: true,
            data: $.param(params),
            statusCode: {
                302: function () {
                    window.location.href = BASE_CI_URL + '/login';
                }
            }
        }).done(function (result) {
            _self.fromFastSearch = false;
            _self.fullSearchResults = result;
            if (_self.shouldInsertFullSearchResults()) {
                _self.insertFullSearchResults();
            }

        }).fail(function (xhr, err, errText) {
            // only show the alert if the status is not a redirect and is not an abort
            if(xhr.status != 302 && xhr.statusText !== 'abort')
            {
                AlertError.show(xhr.responseText, _self.messages.error);
                AlertError.setWidth('550px');
                AlertError.setModalBodyPadding('20px');
            }
        }).always(function() {
        });
    },
    abortRemainingResultsFullRequest : function(){
        var _self = Accommodation.Search;
        if (_self.remainingResultsFullRequest !== null) {
            _self.remainingResultsFullRequest.abort();
        }
        _self.fullSearchResults = null;
        _self.hideLoadingMoreResultsLoader();
    },
    reloadTriggersForResults : function(){
        var _self = Accommodation.Search;
        if(typeof google === 'undefined' || typeof google.maps === 'undefined') {
            $('#googleMiniMap').hide();
            $('div#content .mapIcon').hide();
        }
        //console.time('init filter');
        ResultFilter.minPrice = typeof $('#minimumPrice')[0] !== 'undefined' && $('#minimumPrice').val() != '' ? parseFloat($('#minimumPrice').val()) : 0;
        ResultFilter.maxPrice = typeof $('#maximumPrice')[0] !== 'undefined' && $('#maximumPrice').val() != '' ? parseFloat($('#maximumPrice').val()) : 0;
        ResultFilter.init();
        //console.timeEnd('init filter');

        //console.time('init sort');
        ResultsSortBy.init();
        //console.timeEnd('init sort');

        //console.time('init minimap');
        _self.initGoogleMiniMap();
        //console.timeEnd('init minimap');

        //console.time('init bigmap');
        setTimeout(function(){
            _self.prepareGoogleBigMap();
            ResultFilter.hasGeoMarkers = _self.geoMarkers;
            //console.timeEnd('init bigmap');
        }, 500);

        //console.timeEnd('Accommodation.Search.searchCallBack');
        _self.performedSearchData = $('#searchForm').serializeObject();
        _self.searchPerformed = ($('#resultsFoundCount').val() > 0 ? true : false);

        if($('#searchRoomsNo').val() >= 2){
            ShoppingCart.toggleBottom(true);
            Accommodation.Booking.updateThisGroup(null, null, true);
            $('.shoppingcart_container .total').removeClass('hidden');
        } else {
            ShoppingCart.toggleBottom(false);
        }

        // clear compare list
        if(typeof Compare !== "undefined")
        {
            if (Compare.compareList.length > 0){var accomodationCall = true; }
            Compare.emptyList(accomodationCall);
        }
        // get items from localstorage and update DOM
        if(typeof(Storage) !== "undefined") {
            if (localStorage.getItem('localStorageObject')) {
                Compare.checkCompareListStorage(true);
            }
        }
    },
    loadRemainingResults : function()
    {
        var _self = Accommodation.Search;
        var transactionId = $('#currentTransactionID').val();
        if(typeof transactionId === 'undefined')
        {
            _self.remainingResults = 'loaded';
            return;
        }
        $.ajax({
            url: _self.getRemainingResultsUrl + '/' + transactionId,
            dataType: 'html',
            type: "get",
            async: true,
            statusCode: {
                302: function () {
                    window.location.href = BASE_CI_URL + '/login';
                }
            }
        }).done(function (result) {
            _self.remainingResults = result;
        }).fail(function (xhr, err, errText) {

        }).always(function() {
        });
    },
    initGoogleMiniMap: function()
    {
        if(typeof google === 'undefined' || typeof google.maps === 'undefined') {
            return;
        }
        var _self = Accommodation.Search;
        $('#googleMiniMap .mapOverlay, #closeGoogleMap').unbind('click');
        $('#googleMiniMap .mapOverlay, #closeGoogleMap').click(function(){
            if ((typeof IS_UMRAH_CUSTOMER === "undefined" || Boolean(IS_UMRAH_CUSTOMER) === false) && $('#isSinglePage').length > 0) {
                $('#mapHotelDetailsName').html($('.hotel-header-title').html());
                $('#mapHotelDetailsModal').modal('show').on('shown.bs.modal', function () {
                    _self.showGoogleBigMap();
                });
            } else if($('#googleBigMap').css('display') == 'none') {
                _self.showGoogleBigMap(_self.labelsText.miniMapClickToHide, true);
            } else {
                $('#googleMiniMap label').text(_self.labelsText.miniMapClickToShow);
                $('#googleBigMap').hide();
                $('#googleMapLegend').hide(250);
                if ($('#isSinglePage').length > 0) {
                    $('#slidershowhide').show(250)
                }
            }
        });
    },
    showGoogleBigMap: function(buttonLabel, hideSlider) {

        var _self = Accommodation.Search;
        $(document).trigger('appendRemainingResults.AccommodationSearch');

        if (typeof buttonLabel !== "undefined") {
            $('#googleMiniMap label').text(buttonLabel);
        }
        var x = _self.bigMap.getZoom();
        var c = _self.bigMap.getCenter();
        google.maps.event.trigger(_self.bigMap, 'resize');

        // zoom to country bounds
        var geocoder = new google.maps.Geocoder();
        geocoder.geocode({'address': $('#searchCityAddress').val()}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                _self.bigMap.setCenter(results[0].geometry.location);
                _self.bigMap.fitBounds(results[0].geometry.viewport);
            }
        });

        _self.bigMap.setZoom(x);
        $('#googleBigMap').css('display', 'block');
        $('#googleMapLegend').show(250);

        if (typeof hideSlider !== "undefined" && Boolean(hideSlider) === true && $('#isSinglePage').length > 0) {
            $('#slidershowhide').hide(250)
        }
    },
    prepareGoogleBigMap : function()
    {
        if(typeof $('#googleBigMap')[0] === 'undefined' || typeof google === 'undefined' || typeof google.maps === 'undefined')
        {
            return;
        }

        var _self = Accommodation.Search;

        //clear markers from memory (if any)
        for(var i = 0; i < _self.geoMarkers.length; i++)
        {
            _self.geoMarkers[i].setMap(null);
        }
        _self.geoMarkers.length = 0;

        _self.bigMap = new google.maps.Map(
            document.getElementById('googleBigMap'),
            {
                center: new google.maps.LatLng(0, 0),
                zoom: 12,
                panControl: false,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
        );
        //this will hide business locations
        _self.bigMap.setOptions(
            {
                styles: [
                    {
                        featureType: "poi.business",
                        elementType: "labels",
                        stylers: [
                            { visibility: "off" }
                        ]
                    }
                ]
            }
        );
        //
        // var geocoder = new google.maps.Geocoder();
        // var mapCenter = null;
        // geocoder.geocode({'address': $('#searchCityAddress').val()}, function(results, status) {
        //
        //     if (status == google.maps.GeocoderStatus.OK) {
        //         mapCenter = results[0].geometry.location;
        //         _self.bigMap.setCenter(mapCenter);
        //     }
        // });

        var markers = [];
        $.each($('#googleBigMap').data('geopoints'), function(index, geoPoint) {
            if(geoPoint.id > 0)
            {
                var marker = _self.createMarker(_self.bigMap, new google.maps.LatLng(geoPoint.lat, geoPoint.lng), geoPoint.id, false);
                if(marker !== null) {
                    _self.geoMarkers.push(marker);
                }
            }
        });

        _self.markerCluster = new MarkerClusterer(_self.bigMap, _self.geoMarkers, {gridSize: 30, maxZoom: 15});

        var closeInfoWindow = function()
        {
            if( infoWindow )
            {
                infoWindow.close();
            }
        };

        google.maps.event.addListener(_self.bigMap, 'click', closeInfoWindow );
        google.maps.event.addListener(_self.bigMap, 'drag', closeInfoWindow );
    },
    createMarker: function (map, point, hotelId, isSelected)
    {
        var _self = Accommodation.Search;

        var hotelContainer = $('#hotel_'+ hotelId + '_row');
        if(typeof hotelContainer[0] === 'undefined' || typeof google === 'undefined' || typeof google.maps === 'undefined')
        {
            return null;
        }

        var iconSize = new google.maps.Size(20, 34);
        var iconShadowSize = new google.maps.Size(37, 34);
        var iconHotSpotOffset = new google.maps.Point(9, 0); // Should this be (9, 34)?
        var iconPosition = new google.maps.Point(0, 0);
        var iconShadowUrl = "//www.google.com/mapfiles/shadow50.png";
        var iconImageSelectedUrl = "//maps.google.com/mapfiles/marker.png";
        var iconImageUrl = BASE_URL + (FOLDER ? '/' + FOLDER : '') + '/_laravel/public/ci/images/blue_blank.png';
        var iconImageOverUrl = BASE_URL + (FOLDER ? '/' + FOLDER : '') + '/_laravel/public/ci/images/orange_blank.png';

        var iconImageOutUrl;
        var markerImage;

        if(isSelected)
        {
            iconImageOutUrl = iconImageSelectedUrl;
            markerImage = new google.maps.MarkerImage(iconImageSelectedUrl, iconSize, iconPosition, iconHotSpotOffset);
        }
        else
        {
            iconImageOutUrl = iconImageUrl;
            markerImage = new google.maps.MarkerImage(iconImageUrl, iconSize, iconPosition, iconHotSpotOffset);
        }

        var markerShadow = new google.maps.MarkerImage(iconShadowUrl, iconShadowSize, iconPosition, iconHotSpotOffset);
        var markerImageOver = new google.maps.MarkerImage(iconImageOverUrl, iconSize, iconPosition, iconHotSpotOffset);
        var markerImageOut = new google.maps.MarkerImage(iconImageOutUrl, iconSize, iconPosition, iconHotSpotOffset);

        var marker = new google.maps.Marker({
            position: point,
            map: map,
            title: _self.labelsText.bigMapClickToGo,
            animation: google.maps.Animation.DROP,
            shadow: markerShadow,
            icon: markerImage,
            hotelId: hotelId
        });

        if(isSelected)
        {
            marker.setZIndex(600);
        }

        google.maps.event.addListener(marker, "mouseover", function() {
            marker.setIcon(markerImageOver);

            //get the price
            var price = $('.search-details-container .price-range', hotelContainer).html();
            price = price.substr(0, price.indexOf('</h3>'));
            price = price.replace('<h3>', '<br/>');

            infoWindow.setOptions({
                content:    '<div class="gbmHotelHeader">' +
                '<div class="gbmImage">' + $('.search_img img', hotelContainer).get(0).outerHTML + '</div>' +
                '<div class="gbmName">' + $('.search-name-container > div:first-child', hotelContainer).html() + '</div>' +
                '<div class="gbmPrice">' + price + '</div>' +
                '<div class="clear"></div>' +
                '</div>' +
                '<div class="gbmDescription">' + $('.search-details-container .info_container span', hotelContainer).first().html() + '</div>'
            });

            infoWindow.open(map, marker);
        });

        google.maps.event.addListener(marker, "mouseout", function() {
            marker.setIcon(markerImageOut);
        });

        google.maps.event.addListener(marker, "click", function() {
            marker.setIcon(markerImageOut);
            hotelContainer.prevAll('.search-result_row.hidden').removeClass('hidden');
            hotelContainer.removeClass('hidden');
            $('html,body').animate({scrollTop: hotelContainer.offset().top - $('#header').outerHeight(true)}, 100);
        });

        return marker;
    },
    updateGeoMarkers : function(hotelIds)
    {
        if(typeof google === 'undefined' || typeof google.maps === 'undefined') {
            return;
        }
        var _self = Accommodation.Search;
        var markersForCluster = [];

        $.each(_self.geoMarkers, function(key, value)
        {
            if($.inArray(parseInt(value.hotelId), hotelIds) == -1) {
                value.setVisible(false);
            } else {
                value.setVisible(true);
                markersForCluster.push(value);
            }
        });
        if(_self.geoMarkers.length > 0) {
            _self.markerCluster.removeMarkers(_self.geoMarkers);
        }
        if(markersForCluster.length > 0) {
            _self.markerCluster.addMarkers(markersForCluster);
        }
    },
    setSearchModalBanners: function()
    {
        var _self = Accommodation.Search;
        var params = $('#searchForm').serialize();

        $.ajax({
            url: _self.modalBannerUrl,
            dataType: 'json',
            type: "get",
            async: true,
            data: params,
            statusCode: {
                302: function () {
                    window.location.href = BASE_CI_URL + '/login';
                }
            }
        }).done(function (result)
        {
            if(result.success === true) {
                var html = $(result.html).html();
                $('#loaderContent').removeClass('hasBanner');
                $('#loaderContent').empty().append(html);

                if($(html).find('.carousel').length) {
                    $('#loaderContent').addClass('hasBanner');
                }

                $('#modalCarousel').carousel();
            }
        });
    }
};

Accommodation.Booking = (function($)
{
	var obj = {
		rules       : {},
		messages    : {},
		labelsText  : {},
		bookingUrl  : null,
		additionalMandatoryServicesUrl: null,
		$hotel      : null,
		formId      : '#passenger-details-container',
		bookingContainer: '#bookingContainer',
		resultsContainer: '#accommodation-search-results',
		selectedRooms: [],
		ccCustomer   : false,
        hasItinerary : false,
		bookingParams   : [],
		validator       : null,
        saveValidator   : null,
        lastHotelSelection: {hotelId: 0, waitingForInput: false},
        blockHotelBooking: false,
        scrolledHeight: 0,
        checkPINUrl : null,
        getNewROEUrl: null,
        mealPriceUpdateInfo: {roomId: -1, price: -1},
        validateDuplicate: true
	};

	obj.init = function()
	{
        var nonumrahacm = $("input[name=nonumrahacm]").val();
        var searchBtn = $('#searchButton')
		$(document).on('click', '#passenger-details-container .back_btn', function() {
		    if(nonumrahacm == 0) {
                /**
                 * In Case of umrah customer, Triggering the search again
                 */
                if (IS_UMRAH_CUSTOMER == 1) searchBtn.trigger('click')
                else window.location.reload()
            } else {
                Accommodation.Booking.backToResults();
                $(document).trigger('booking.hidePassengersForm');
            }

		});

        $(document).on('click', '.btn-copy-passenger', function(ev) {
            ev.preventDefault();
            let parent = $(this).parents('tr');
            let title = parent.find('select[name^="title"]').val();
            let fname = parent.find('input[name^="firstName"]').val();
            let lname = parent.find('input[name^="lastName"]').val();
            let cpc = parent.find('input[name^="countryPhoneCode"]').val();
            let cpcText = parent.find('input[name^="textPhoneNumberCountryCode"]').val();
            let pn = parent.find('input[name^="phoneNumber"]').val();
            let email = parent.find('input[name^="email"]').val();

            if(title == '' || fname == '' || lname == '' || cpc == '' || pn == '' || email == '')
            {
                AlertError.show(makeAMessagePanel(Accommodation.Booking.labelsText.copyPassengerError), Accommodation.Booking.labelsText.error);
                AlertError.setWidth('550px');
                AlertError.setModalBodyPadding('20px');
                return false;
            }

            let p = 'a';
            $('[id^="pbcpPassengerData"]:visible')
                .not(parent)
                .each(function(i, el)
            {
                let suffix = '';
                let e_title = $(el).find('select[name^="title"]');
                let e_fname = $(el).find('input[name^="firstName"]');
                let e_lname = $(el).find('input[name^="lastName"]');
                let e_cpc   = $(el).find('input[name^="countryPhoneCode"]');
                let e_cpcText = $(el).find('input[name^="textPhoneNumberCountryCode"]');
                let e_pn    = $(el).find('input[name^="phoneNumber"]');
                let e_email = $(el).find('input[name^="email"]');

                if (e_fname.val() == '' && e_lname.val() == '')
                {
                    suffix = p;
                    p = nextLetter(p);

                    e_title.val(title);
                    e_fname.val(fname + ' ' + suffix);
                    e_lname.val(lname + ' ' + suffix);
                    e_cpc.val(cpc);
                    e_cpcText.val(cpcText);
                    e_pn.val(pn);
                    e_email.val(email);
                }
            });

        });
	};

    obj.backToResults = function ()
    {
        window.history.back();
    };

    obj.showResults = function(showLoader)
    {
        showLoader = typeof(showLoader) != "undefined" ? showLoader : true;

        if(showLoader){
            Loader.show();
        }
        var $content = $('#content').find('.row:first');
        $content.find('#bookingContainer').remove();
        $content.find('#accommodation-search-results').show();

        if(typeof Compare !== "undefined") {
            Compare.visible(true);
        }

        if(showLoader){
            $('html,body').animate({scrollTop: Accommodation.Booking.scrolledHeight}, 750);
            setTimeout(function() {Loader.hide();}, 200);
        }
    };

    obj.hotelBookNow = function(button)
    {
        var elem = 'div';
        let price =[];
        if(isOldIE() == 7 ) {
            elem = '';
        }
        var _self = Accommodation.Booking;
        if(_self.blockHotelBooking) {
            return;
        }
        Accommodation.Search.abortRemainingResultsFullRequest();
        _self.blockHotelBooking = true;

        _self.selectedRooms.length = 0;
        _self.$hotel = $(button).closest(elem + '.search-result_row');

        //validate number of rooms in hotel booking
        var requiredRooms = parseInt($('#searchRoomsNo').val(), 10);
        var foundRooms = 0;
        var enforceBookingFlow = false;

        $('select.multipleRoomsSelect', _self.$hotel).each(function() {
            let selectedRoom = parseInt($(this).val(), 10);
            foundRooms += selectedRoom;

            if (selectedRoom > 0 && enforceBookingFlow == false) {
                if (_self.enforceBookingFlow($(this))) {
                    enforceBookingFlow = true;
                }
            }
        });

        if(requiredRooms != foundRooms)
        {
            AlertError.show(makeAMessagePanel(_self.labelsText.invalidHotelRoomsNo.replace('#i', requiredRooms)), _self.labelsText.error);
			AlertError.setWidth('550px');
			AlertError.setModalBodyPadding('20px');
            _self.blockHotelBooking = false;
            return;
        }

        if(enforceBookingFlow == true)
        {
            _self.blockHotelBooking = false;
            return;
        }

        var errorInGroup = false;
        $(elem + '.rooms-details', _self.$hotel).each(function(){
            var $group = $(this);
            var roomsIdInGroup = $group.data('groupedroomsno');
            roomsIdInGroup = typeof roomsIdInGroup !== 'string' ? roomsIdInGroup.toString().split(',') : roomsIdInGroup.split(',');
            var foundRoomsInGroup = 0;
            $('select.multipleRoomsSelect', $group).each(function(){
                foundRoomsInGroup += parseInt($(this).val(), 10);
            });
            if(roomsIdInGroup.length != foundRoomsInGroup)
            {
                errorInGroup = true;
                var message = '';
                if(roomsIdInGroup.length == 1)
                {
                    message = _self.labelsText.invalidGroupRoomNo.replace('#i', roomsIdInGroup[0]);
                }
                else
                {
                    var roomMessage = '';
                    for(var i = 0; i < roomsIdInGroup.length; i++)
                    {
                        roomMessage += roomsIdInGroup[i];
                        if(i == roomsIdInGroup.length - 2)
                        {
                            roomMessage += ' and ';
                        }
                        else if(i < roomsIdInGroup.length - 2)
                        {
                            roomMessage += ', ';
                        }
                    }
                    message = _self.labelsText.invalidGroupRoomsNo.replace('#i', roomMessage);
                }
                AlertError.show(makeAMessagePanel(message), _self.labelsText.error);
                AlertError.setWidth('550px');
                AlertError.setModalBodyPadding('20px');
                return false;
            }
        });
        if(errorInGroup)
        {
            _self.blockHotelBooking = false;
            return;
        }

        //prepare data for hotel rooms
        var hotelRooms = [];
        $(elem + '.rooms-details', _self.$hotel).each(function(){
            //console.log('--------------------');
            var $group = $(this);

            var roomsIdInGroup = $group.data('groupedroomsno');
            roomsIdInGroup = typeof roomsIdInGroup !== 'string' ? roomsIdInGroup.toString().split(',') : roomsIdInGroup.split(',');
            roomsIdInGroup = $.map(roomsIdInGroup, function( val, i ) {
                return {roomId: parseInt(val, 10), room: null, idx: 1, group: $group.data('groupedroomsno')};
            });
            roomsIdInGroup = roomsIdInGroup.sort(function(a, b){
                return b.roomId - a.roomId;
            });

            var ratesArray = [];
            $('select.multipleRoomsSelect:enabled', $group).each(function() {
                var foundRoomsInGroup = parseInt($(this).val(), 10);
                for(var i = 0; i < foundRoomsInGroup; i++) {
                    ratesArray.push($(this).closest(elem + '.rdRow'));
                }
            });

            //wtf let's check again
            if(roomsIdInGroup.length != ratesArray.length)
            {
                errorInGroup = true;
                return false;
            }
            //now try to match the rooms
            if(roomsIdInGroup.length == 1) //simple 1 on 1
            {
                roomsIdInGroup[0].room = ratesArray[0][0];
                ratesArray.length = 0;
            }
            else
            {
                for(var i = 0; i < roomsIdInGroup.length; i++)
                {
                    //check for a exact match in a room with roomsCount = 1;
                    for(var j = ratesArray.length - 1; j >= 0; j--)
                    {
                        var $room = ratesArray[j];
                        //console.log(i, roomsIdInGroup[i].roomId, $room.data('roomscount'), $room.data('roomrunno.1'));
                        if(parseInt($room.data('roomscount'), 10) == 1 && parseInt($room.data('roomrunno.1'), 10) + 1 == roomsIdInGroup[i].roomId) //a match
                        {
                            //console.log('hit');
                            $room = ratesArray.splice(j, 1);
                            roomsIdInGroup[i].room = $room[0][0];
                            break;
                        }
                    }
                    //console.log('room ' + i + ' multiple');
                    //try to find a match in remaining rooms
                    if(roomsIdInGroup[i].room === null)
                    {
                        for(var j = ratesArray.length - 1; j >= 0; j--)
                        {
                            var $room = ratesArray[j];
                            for(var k = parseInt($room.data('roomscount'), 10); k > 0; k--)
                            {
                                //console.log(i, roomsIdInGroup[i].roomId, $room.data('roomscount'), $room.data('roomrunno.' + k));
                                if(parseInt($room.data('roomrunno.' + k), 10) + 1 == roomsIdInGroup[i].roomId) //a match
                                {
                                    //console.log('hit');
                                    $room = ratesArray.splice(j, 1);
                                    roomsIdInGroup[i].room = $room[0][0];
                                    roomsIdInGroup[i].idx = k;
                                    break;
                                }
                            }
                            if(roomsIdInGroup[i].room !== null)
                            {
                                break;
                            }
                        }
                    }
                    //
                    if(roomsIdInGroup[i].room === null)
                    {
                        errorInGroup = true;
                        break;
                    }
                }
            }
            hotelRooms = hotelRooms.concat(roomsIdInGroup);
        });
        //console.log(hotelRooms);
        if (typeof IS_UMRAH_CUSTOMER !== "undefined" && Boolean(IS_UMRAH_CUSTOMER) === true)
        {
	        for(var j = 0; j < hotelRooms.length; j++)
	        {
	            var $roomprice = $(hotelRooms[j].room);
	            var dataIdxsearch = hotelRooms[j].idx;
	            price.push($roomprice.data('roomprice.' + dataIdxsearch))
	        }

            if($('.mrCheckContainer').is(":visible"))
            {
                $('.mrCheckContainer').hide();
            }
        }
        if(errorInGroup)
        {
            //some error message
            AlertError.show(makeAMessagePanel(_self.labelsText.noMatchForRoomsSelection), _self.labelsText.error);
            AlertError.setWidth('550px');
            AlertError.setModalBodyPadding('20px');
            _self.blockHotelBooking = false;
            return;
        }
        hotelRooms = hotelRooms.sort(function(a, b){
            return a.roomId - b.roomId;
        });

        _self.scrolledHeight  = $(document).scrollTop();

        //console.log(hotelRooms, _self.$hotel.data('hotelid'));
        var shouldReloadRooms = false;
        for(var i = 0; i < hotelRooms.length; i++)
        {
            var $tmpRoom = $(hotelRooms[i].room);
            hotelRooms[i].roomData = {id: $tmpRoom.data('roomid.' + hotelRooms[i].idx), board: $tmpRoom.data('board.' + hotelRooms[i].idx), onRequest: $tmpRoom.data('onrequest.' + hotelRooms[i].idx)};
            var roomPolicyHtml = Hotel.getRoomPolicyHtml($tmpRoom, null);
            if(roomPolicyHtml === false) {
                shouldReloadRooms = true;
            }
        }
        //console.log(hotelRooms, shouldReloadRooms);
        if(shouldReloadRooms)
        {
            var hotelId = _self.$hotel.data('hotelid');
            var allRoomsFound = true;
            Accommodation.Search.loadMoreBoards(hotelId, $(hotelRooms[0].room).find('.roomPolicy').find('span'), false, false, false, function(html)
            {
                //console.log(html);
                if(!html) {
                    allRoomsFound = false;
                }
                else
                {
                    for(var i = 0; i < hotelRooms.length; i++)
                    {
                        var $tmpRoom = $('#hotel_' + hotelId + '_row').
                            find('.rooms-details[data-groupedroomsno="' + hotelRooms[i].group + '"]').
                            find('.rdRow[data-roomid\\.' + hotelRooms[i].idx + '="' + hotelRooms[i].roomData.id +
                                '"][data-board\\.' + hotelRooms[i].idx + '="' + hotelRooms[i].roomData.board +
                                '"][data-onrequest\\.' + hotelRooms[i].idx + '="' + hotelRooms[i].roomData.onRequest + '"]');
                        if(typeof $tmpRoom[0] === 'undefined') {
                            allRoomsFound = false;
                            break;
                        }
                        else {
                            hotelRooms[i].room = $tmpRoom[0];
                        }
                    }
                }
            }, false);
            if(!allRoomsFound)
            {
                AlertError.show(_self.labelsText.cantBlockTheRoom, _self.labelsText.error);
                _self.blockHotelBooking = false;
                return;
            }
            else {
                _self.$hotel = $('#hotel_' + hotelId + '_row');
            }
        }

        //

        var locationName = _self.$hotel.data('location');
		$.each($.parseJSON($('#locationIds').val()), function(idx, location){
			if(location.id == locationName)
			{
				locationName = location.name;
				return false;
			}
		});
        var hotelId = _self.$hotel.data('hotelid');
        var params = $('#searchForm').serializeObject();
		params['matchingSearch'] = $('#matchingSearch').val();
		params['locationName'] = locationName;
                params['geoLocationName'] = $('#geoLocationsName_'+hotelId).html();
        params['tID'] = $(hotelRooms[0].room).data('tid');
        params['tokenCreationTime'] = $('#tokenCreationTime').val();
        for(var i = 0; i < hotelRooms.length; i++)
        {
            _self.selectedRooms[i + 1] = hotelRooms[i];

            var $room = $(hotelRooms[i].room);
            var dataIdx = hotelRooms[i].idx;
            //must be validated on server
            params['roomTypeCode[' + (i + 1) + ']'] = $room.data('roomid.' + dataIdx);
            params['roomRateBasis[' + (i + 1) + ']'] = $room.data('board.' + dataIdx);
            params['roomToken[' + (i + 1) + ']'] = $room.data('allocationdetails.' + dataIdx);
            params['roomMinRequiredPassengers[' + (i + 1) + ']'] = $room.data('passengernamesrequiredforbooking.' + dataIdx);
            params['roomChangedOccupancy[' + (i + 1) + ']'] = $room.data('changedoccupancy.' + dataIdx) != '' ? $room.data('changedoccupancy.' + dataIdx) : '0';
            //additional data non required
            params['roomPaymentMode[' + (i + 1) + ']'] = $room.data('paymentmode.' + dataIdx);
            params['roomNonRefundable[' + (i + 1) + ']'] = $room.data('nonrefundable.' + dataIdx);
            params['roomWithinCancellationDeadline[' + (i + 1) + ']'] = $room.data('withincancellationdeadline.' + dataIdx);
            params['roomOnRequest[' + (i + 1) + ']'] = $room.data('onrequest.' + dataIdx);
            params['roomAdditionalMandatoryServices[' + (i + 1) + ']'] = $room.data('additionalmandatoryservices.' + dataIdx);
            params['roomAllowsBeddingPreference[' + (i + 1) + ']'] = $room.data('allowsbeddingpreference.' + dataIdx);
            params['roomAllowsExtraMeals[' + (i + 1) + ']'] = $room.data('allowsextrameals.' + dataIdx);
            params['isBookable[' + (i + 1) + ']'] = $room.data('isbookable.' + dataIdx);
            params['roomRunNo[' + (i + 1) + ']'] = $room.data('roomrunno.' + dataIdx);
            params['roomRateRunNo[' + (i + 1) + ']'] = $room.data('runno.' + dataIdx);
			params['loyaltyPoints[' + (i + 1) + ']'] = $room.data('loyaltypoints.' + dataIdx);
            params['changeRestrictedWithCancelFromBookingTime[' + (i + 1) + ']'] = $room.data('changerestrictedwithcancelfrombookingtime.' + dataIdx);
            params['isRateAPR[' + (i + 1) + ']'] = $room.data('israteapr.' + dataIdx);
            params['supplierId[' + (i + 1) + ']'] = $room.data('supplierid.' + dataIdx);
        }
        _self.bookingParams = params;

        //console.log(params);
        Loader.show();

        var $content = $('#content').find('.row:first');
		$.ajax({
			url: _self.bookingUrl + '/' + _self.$hotel.data('hotelid'),
			dataType: 'json',
			type: "post",
			async: true,
			data: $.param(params),
			statusCode: {
				302: function () {
					window.location.href = BASE_CI_URL + '/login';
				}
			}
		}).done(function (result) {
			if(result.success === false) {
				if(typeof result.newRoomsData !== 'undefined')
				{
                    _self.bookingParams.length = 0; //reset the saved params
					_self.$hotel.find('.rooms-details').remove(); //remove all hotel's rooms
					_self.$hotel.find('[name="searchedRooms"]').remove();
                    _self.$hotel.find('.mrbnContainer').remove();
					var newRooms = $(result.newRoomsData);
					newRooms.insertAfter(_self.$hotel.find('div[name="roomsInsertionPoint"]')); //add new rooms data
					_self.$hotel.find('.price-range > .search_btn').data('rooms', newRooms.find('.rdRow').length); //update the rooms count on this hotel
					ResultFilter.reloadFilterCounters(); //update board basis filter
                    $('html,body').animate({scrollTop: _self.scrolledHeight}, 250);
                    _self.updateThisGroup(null, null, true);
				}
				AlertError.show(result.html, _self.labelsText.error);
				AlertError.setWidth('550px');
				AlertError.setModalBodyPadding('20px');
			} else {

			    if ($('#isSinglePage').length > 0) {
                    $(_self.resultsContainer).find('#searchForm').remove();
                    $(_self.resultsContainer).find('#searchTaps').remove();
                    $(_self.resultsContainer).find('.multipleRoomsSelect').remove();
                }
				var html = $(result.html);
				$(".bootstrapCheckBox", html).bootstrapSwitch();
				$content.find(_self.resultsContainer).hide();
                if($content.find(_self.bookingContainer).length > 0 )
                {
                    $content.find(_self.bookingContainer).remove();
                    $content.append(html);
                }else{
                    $content.append(html);
                }
                if ($('#isSinglePage').length > 0) {
                    $('.searchButtonsContainer >.search_btn').removeAttr('id');
                    $('.searchButtonsContainer >.search_btn').addClass('openRoomModal');

                }
                _self.initBookingForm(price);

                historyPushState("Booking", window.location.title, window.location.href + "#booking_form");
                if (showOverlay ==false) {
                    $('body').removeClass('modal-open').attr('style', '');
                }
                $('html,body').animate({
					scrollTop: $('#content').find('.row:first').offset().top
				}, 'slow');
			}
		}).fail(function (xhr, err, errText) {
			// only show the alert if the status is not a redirect
			if(xhr.status != 302)
			{
				AlertError.show(xhr.responseText, _self.labelsText.error);
			}
		}).always(function() {
			Loader.hide();
            _self.blockHotelBooking = false;
            $(".collapsiblePanelTabRoomPrice").trigger("click");
		});

    };

    obj.enforceBookingFlow = function(button)
    {
        /** Force trigger the View Cancellation policies */
        var row             = $(button).closest('.rdRow');
        var needsRoomCheck  = row.data('needsroomcheck');
        var _self           = Accommodation.Booking;

        if(needsRoomCheck == '1')
        {
            row.find('.roomPolicy span').first().trigger("click");
            row.data('needsroomcheck', "0");
            AlertError.show(makeAMessagePanel(_self.labelsText.enforceBookingFlow), _self.labelsText.error);

            return true;
        }

        $('.lefttooltip').remove();

        return false;
    };

	obj.roomBookNow = function(button, bookingData)
	{
        var _self = Accommodation.Booking;
        let price =[];
        if(_self.enforceBookingFlow(button))
        {
            return;
        }

        Accommodation.Search.abortRemainingResultsFullRequest();

        Loader.show();

        if(_self.blockHotelBooking) {
            return;
        }
        _self.blockHotelBooking = true;

		_self.selectedRooms.length = 0;

        var elem = 'div';
        if(isOldIE() == 7) {
            elem = '';
        }
        if ((button == 'searchPage' || button == 'homepage') && (bookingData != false)) {
            var bookFromCompare = true;
        } else {
            var bookFromCompare = false;
        }

        if (bookFromCompare)
        {
            var $room = $(bookingData['selectedRoom']).unwrap();
            _self.$hotel = $(bookingData['$hotel']).unwrap();
        }
        else
        {
            var $room = $(button).closest(elem +'.rdRow');
            var $rooms = $room.closest(elem +'.rooms-details');
            _self.$hotel = $rooms.closest(elem +'.search-result_row');
        }

        var hotelId = _self.$hotel.data('hotelid') ? _self.$hotel.data('hotelid') : bookingData['hotelId'];
	    if (typeof IS_UMRAH_CUSTOMER !== "undefined" && Boolean(IS_UMRAH_CUSTOMER) === true) {
        	price.push($room.data('roomprice.1'))
	    }
        if (bookFromCompare)
        {
            var locationName = bookingData['locationName'];
        }
        else
        {
            var locationName = _self.$hotel.data('location');
            $.each($.parseJSON($('#locationIds').val()), function(idx, location){
                if(location.id == locationName)
                {
                    locationName = location.name;
                    return false;
                }
            });

            //check if cancellation rules are loaded
            var roomPolicyHtml = Hotel.getRoomPolicyHtml($room, null);
            if(roomPolicyHtml === false)
            {
                var roomData = {id: $room.data('roomid.1'), board: $room.data('board.1'), onRequest: $room.data('onrequest.1')};
                //console.log(roomData);
                Accommodation.Search.loadMoreBoards(hotelId, $room.find('.roomPolicy').find('span'), false, false, false, function(html)
                {
                    //console.log(html);
                    if(!html) {
                        $room = null;
                    }
                    else
                    {
                        $room = $('#hotel_' + hotelId + '_row').
                            find('.rooms-details[data-groupedroomsno="1"]').
                            find('.rdRow[data-roomid\\.1="' + roomData.id + '"][data-board\\.1="' + roomData.board + '"][data-onrequest\\.1="' + roomData.onRequest + '"]');
                        //console.log($room, typeof $room[0] === 'undefined');
                        if(typeof $room[0] === 'undefined') {
                            $room = null;
                        }
                        else {
                            $rooms = $room.closest(elem +'.rooms-details');
                            _self.$hotel = $rooms.closest(elem +'.search-result_row');
                        }
                    }
                }, false);
                if($room === null)
                {
                    AlertError.show(_self.labelsText.cantBlockTheRoom, _self.labelsText.error);
                    _self.blockHotelBooking = false;
                    return;
                }
            }
        }
        _self.selectedRooms[1] = {roomId: 1, room: $room[0], idx: 1};
        _self.scrolledHeight  = $(document).scrollTop();
        var params = $('#searchForm').serializeObject() ? $('#searchForm').serializeObject() : bookingData['searchFormS'];
        params['matchingSearch'] = $('#matchingSearch').val() ? $('#matchingSearch').val() : bookingData['matchingSearch'];
		params['locationName'] = locationName;

        params['tID'] = bookFromCompare === true ? bookingData['tID'] : $room.data('tid');
        params['tokenCreationTime'] = $('#tokenCreationTime').val() ? $('#tokenCreationTime').val() :  bookingData['tokenCreationTime'];
		//must be validated on server
		params['roomTypeCode[1]'] = $room.data('roomid.1');
                params['geoLocationName'] = $('#geoLocationsName_'+hotelId).html();
		params['roomRateBasis[1]'] = $room.data('board.1');
		params['roomToken[1]'] = $room.data('allocationdetails.1');
		params['roomMinRequiredPassengers[1]'] = $room.data('passengernamesrequiredforbooking.1');
        if (!bookFromCompare) {
		    params['roomChangedOccupancy[1]'] = $room.data('changedoccupancy.1') != '' ? $room.data('changedoccupancy.1') : '0';
        } else {
            params['roomChangedOccupancy[1]'] = bookingData['roomChangedOccupancy[1]'] != '' ? bookingData['roomChangedOccupancy[1]'] : '0';
        }
		//additional data non required
		params['roomPaymentMode[1]'] = $room.data('paymentmode.1');
		params['roomNonRefundable[1]'] = $room.data('nonrefundable.1');
		params['roomWithinCancellationDeadline[1]'] = $room.data('withincancellationdeadline.1');
		params['roomOnRequest[1]'] = $room.data('onrequest.1');
		params['roomAdditionalMandatoryServices[1]'] = $room.data('additionalmandatoryservices.1');
		params['roomAllowsBeddingPreference[1]'] = $room.data('allowsbeddingpreference.1');
		params['roomAllowsExtraMeals[1]'] = $room.data('allowsextrameals.1');
        params['isBookable[1]'] = $room.data('isbookable.1');
        params['roomRunNo[1]'] = $room.data('roomrunno.1');
        params['roomRateRunNo[1]'] = $room.data('runno.1');
		params['loyaltyPoints[1]'] = $room.data('loyaltypoints.1');
        params['changeRestrictedWithCancelFromBookingTime[1]'] = $room.data('changerestrictedwithcancelfrombookingtime.1');
        params['isRateAPR[1]'] = $room.data('israteapr.1');
        params['supplierId[1]'] = $room.data('supplierid.1');

		if (bookFromCompare) {
            params['allocationDetails'] = bookingData['allocationDetails'] ? bookingData['allocationDetails'] : false ;
            params['dateFrom'] =  bookingData['dateFromBookFormat'];
            params['dateTo'] = bookingData['dateToBookFormat'];
            //params['destinationCity'] = bookingData['destinationCity'];
            params['PSearchId'] = bookingData['PSearchId'];
            params['PSearchType'] = bookingData['PSearchType'];
            params['PLocationType'] = bookingData['PLocationType'];
            params['nationality[1]'] = bookingData['nationality[1]'];
            params['nationalityText]'] = bookingData['nationalityText'];
            params['adultsCount[1]'] = bookingData['roomOccupancyRaw']['adults'];
            params['childrenCount[1]'] = bookingData['roomOccupancyRaw']['children'];
            params['skipValidate'] = true;
        }

        if(typeof $room.data('aprcurrencyid.1') !== 'undefined')
        {
            params['roomAprCurrencyId[1]'] = $room.data('aprcurrencyid.1');
        } else {
            params['roomAprCurrencyId[1]'] = bookingData['aprcurrencyid.1'];
        }

		_self.bookingParams = params;

		var $content = $('#content').find('.row:first');

        Loader.show();
		$.ajax({
			url: _self.bookingUrl + '/' + hotelId,
			dataType: 'json',
			type: "post",
			async: true,
			data: $.param(params),
			statusCode: {
				302: function () {
					window.location.href = BASE_CI_URL + '/login';
				}
			}
		}).done(function (result) {
		    if(result.success === false) {
				if(typeof result.newRoomsData !== 'undefined')
				{
					_self.bookingParams.length = 0; //reset the saved params
					_self.$hotel.find('.rooms-details').remove(); //remove all hotel's rooms
					_self.$hotel.find('[name="searchedRooms"]').remove();
					var newRooms = $(result.newRoomsData);
					newRooms.insertAfter(_self.$hotel.find(elem +'[name="roomsInsertionPoint"]')); //add new rooms data
					_self.$hotel.find('.price-range > .search_btn').data('rooms', newRooms.find('.rdRow').length); //update the rooms count on this hotel
					ResultFilter.reloadFilterCounters(); //update board basis filter
                    $('html,body').animate({scrollTop: _self.scrolledHeight}, 250);
				}
				AlertError.show(result.html, _self.labelsText.error);
				AlertError.setWidth('550px');
				AlertError.setModalBodyPadding('20px');
                if(isOldIE() == 7) {
                    $('label.required, div.required').append('<span title="Required!" style="color:#f00;"> *</span>'); // Add asterisks
                }
			}
            else
            {
				var html = $(result.html);
				$(".bootstrapCheckBox", html).bootstrapSwitch();
                if (button == 'homepage') {
                    $content.find('#content-landingpage').hide();
                }
                else {
				    $content.find(_self.resultsContainer).hide();
                }
                if ($('#isSinglePage').length > 0) {
                    $(_self.resultsContainer).find('#searchForm').remove();
                    $(_self.resultsContainer).find('#searchTaps').remove();
                    $(_self.resultsContainer).find('.multipleRoomsSelect').remove();
                }
                if($content.find(_self.bookingContainer).length > 0 )
                {
                    $content.find(_self.bookingContainer).remove();
                    $content.append(html);
                }else{
                    $content.append(html);
                }

                if ($('#isSinglePage').length > 0) {
                    $('.searchButtonsContainer > .search_btn').removeAttr('id');
                    $('.searchButtonsContainer > .search_btn').addClass('openRoomModal');
                }
				_self.initBookingForm(price);
                if (button != 'homepage') {
                    historyPushState("Booking", window.location.title, window.location.href + "#booking_form");
                }


				$('html,body').animate({
					scrollTop: $('#content').find('.row:first').offset().top
				}, 'slow');
                if (showOverlay ==false) {
                    $('body').removeClass('modal-open').attr('style', '');
                }
                if(typeof Compare !== "undefined") {
                    Compare.visible(false);
                }

			}
		}).fail(function (xhr, err, errText) {
			// only show the alert if the status is not a redirect
			if(xhr.status != 302)
			{
				AlertError.show(xhr.responseText, _self.labelsText.error);
			}
		}).always(function() {
			Loader.hide();
            _self.blockHotelBooking = false;
            $(".collapsiblePanelTabRoomPrice").trigger("click");
		});
	};

    obj.initRoomOnBookingForm = function(roomNo)
    {
        var _self = Accommodation.Booking;
        var $room = $(_self.selectedRooms[roomNo].room);
        var idx = _self.selectedRooms[roomNo].idx;

        //left panel
		$('#pblpRoomType' + roomNo).html($room.find('.roomTypeText').text());
        $('#pblpBoardBasis' + roomNo).html($room.find('.bbInfo').text());
        //price
        var price = parseFloat($room.data('roomprice.' + idx));
        var $pblpRoomCost = $('#pblpRoomCost' + roomNo);
        var $pblpExtraMealsCost = $('#pblpExtraMealsCost' + roomNo);

        $pblpRoomCost.html($room.data('currency.' + idx) + ' ' + price.formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR));
        $pblpExtraMealsCost.html($room.data('currency.' + idx) + ' ' + Number(0).formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR));
		$('#pblpTotalRoomCost' + roomNo)
            .data('totalcost', price)
            .data('commission', $room.data('commission.' + idx))
            .data('netprice', $room.data('netprice.' + idx))
            .data('currency', $room.data('currency.' + idx))
            .html($pblpRoomCost.html());

        var hotelId = $('.search-result_row').data('hotelid');
        var roomId = $room.data('roomid.' + idx)
        var roomRunno = $room.data('roomrunno.' + idx);
        var rateRunno = $room.data('runno.' + idx);
        var tId = $room.data('tid');

        var pricePerDayInfo = Accommodation.Search.showRoomPricePerDayInfo(tId, hotelId,roomRunno,roomId, rateRunno, 'perDayRoomCost' + idx);

        //occupancy
        if ($('#isSinglePage').length > 0) {
            var $occupancy = $room.find('.icon-validOccupancy');
            if (typeof $occupancy[0] !== 'undefined') {
                $occupancy = $.trim($occupancy.data('title'));
                $occupancy = $occupancy.replace(/(\s+)/g, ' ');
                $('#pblpOccupancy' + roomNo).find('strong').after($(' <strong>(' + $occupancy + ')</strong>'));
            }

            var cxlAmdPolicy = $room.find('input[name="cancellationRulesJson"]').val();
            if (typeof cxlAmdPolicy === 'undefined' || cxlAmdPolicy.length <= 0) {
                return '';
            }
            cxlAmdPolicy = $.parseJSON(cxlAmdPolicy);
            var $cxlAmdPolicyhtml = '';
            $.each(cxlAmdPolicy, function (index, value) {
                if (typeof value.t !== 'undefined') {
                    var html = $('#singleHotel' + value.t + 'Template').html();
                    $cxlAmdPolicyhtml += Mustache.render(html, value) + '<br class="clear" />';
                }
            });
            $('#pblpCxlAmd' + roomNo).html($cxlAmdPolicyhtml);
            $('#hotelAccordion' + idx).hoteltogglepanels();

        }


        //search form
		$('#pbcpRoomName' + roomNo).html($room.find('.roomTypeText').text());

        if(window.mealTypes.length == 0 || $room.data('allowsextrameals.' + idx) != true) //disable if we don't have meals
		{
			$('#pbcpExtraMeals' + roomNo).bootstrapSwitch('disabled', true);
			$pblpExtraMealsCost.parent().hide();
		}
		if($room.data('allowsspecialrequests.' + idx) != true) //disable if we don't allow special requests
		{
			$('#pbcpRequests' + roomNo).bootstrapSwitch('disabled', true);
		}
		if($room.data('additionalmandatoryservices.' + idx) == 1)
		{
			setTimeout(function(){_self.loadRoomMandatoryServices(roomNo);}, 50);
		}
		$('#pbcpPassengersData' + roomNo + ' .additionalPassengerData select, #pbcpPassengersData' + roomNo + ' .additionalPassengerData input').prop('disabled', 'disabled');

        $.each(window.newAllocationDetails, function(i, allocDetails)
        {
			if(allocDetails.index == roomNo && allocDetails.typeCode == $room.data('roomid.' + idx) && allocDetails.boardBasis == $room.data('board.' + idx))
			{
				$room.data('allocationdetails.' + idx, allocDetails.allocationDetails);
                //$room.find('.cancellationRulesInfo').html(allocDetails.cancelRules);
                $room.find('input[name="cancellationRulesJson"]').val($(allocDetails.cancelRules).val());
                $room.data('withincancellationdeadline.' + idx, allocDetails.withinCancellationDeadline);
                $room.data('isbookable.' + idx, allocDetails.isBookable);
                $room.data('onrequest.' + idx, allocDetails.onRequest);
				_self.bookingParams['roomToken[' + roomNo + ']'] = allocDetails.allocationDetails;
                _self.bookingParams['roomWithinCancellationDeadline[' + roomNo + ']'] = allocDetails.withinCancellationDeadline;
                _self.bookingParams['isBookable[' + roomNo + ']'] = allocDetails.isBookable;
                _self.bookingParams['roomOnRequest[' + roomNo + ']'] = allocDetails.onRequest;
				$('#pblpLoyaltyPoints' + roomNo).data('roomLoyaltyRates', allocDetails.roomLoyaltyRates);
			}
		});

		$('#pblpLoyaltyPoints' + roomNo).html($room.data('loyaltypoints.' + idx));

        _self.mealPriceUpdateInfo.price = -1;
        _self.mealPriceUpdateInfo.roomId = -1;
    };
	obj.initBookingForm = function(searchPrice = [])
	{
		$(document).trigger('booking.showPassengersForm');
        let nonumrahacm = $("input[name=nonumrahacm]").val();
        let searchBtn = $('#searchButton');
        selectedExtraMeals.length = 0;

		var _self = Accommodation.Booking;
        _self.nationalityTypeahead();

        if ($('#isSinglePage').length > 0) {
            imgSrc = _self.$hotel.find('input[name="hotelImageSrc"]').val();
        }else{
            var imgSrc = _self.$hotel.find('.search_img .mainGallery img').prop('src');
            if(typeof imgSrc === 'undefined') {
                imgSrc = _self.$hotel.find('.search_img img').first().prop('src');
            }
        }

		//left panel

        $('#pblpHotelImage').prop('src', imgSrc);

        //init rooms
        var totalPrice = 0;
        var totalCommission = 0;
        var totalNetPrice = 0;
        let searchedPrice = 0;
        for(var i = 1, j = parseInt($('#searchRoomsNo').val(), 10); i <= j; i++)
        {
            _self.initRoomOnBookingForm(i);
            var room = $('#pblpTotalRoomCost' + i);
            totalPrice += parseFloat(room.data('totalcost'));
            totalCommission += parseFloat(room.data('commission'));
            totalNetPrice += parseFloat(room.data('netprice'));
            searchedPrice +=parseFloat(searchPrice[i-1]);
        }
        let currency = $('#pblpTotalRoomCost1').data('currency');
        let searchPricetoDisplay = currency + ' ' + searchedPrice.formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR);
        let getRoomPricetoDisplay = currency + ' ' + totalPrice.formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR);
        if (searchPrice.length > 0 && typeof IS_UMRAH_CUSTOMER !== "undefined" && Boolean(IS_UMRAH_CUSTOMER) === true) {
            if (searchedPrice != totalPrice) {
                showOverlay = true;
                bootbox.confirm({
                    message: _self.labelsText.serachRatechangetoGetroom + _self.labelsText.previousPrice +searchPricetoDisplay+_self.labelsText.newPrice+getRoomPricetoDisplay+_self.labelsText.serachGetroomLastContent,
                    title: _self.labelsText.priceAlert,
                    buttons: {
                        cancel: {
                            label: Translations.getText('booking.button.rejectterms')
                        },
                        confirm: {
                            label: Translations.getText('booking.button.accepterms')
                        }
                    },
                    callback: function (result) {
                        if (result == false) {
                            if (nonumrahacm == 0) {
                                /**
                                 * In Case of umrah customer, Triggering the search again
                                 */
                                if (IS_UMRAH_CUSTOMER == 1) searchBtn.trigger('click')
                                else window.location.reload()
                            } else {
                                Accommodation.Booking.backToResults();
                                $(document).trigger('booking.hidePassengersForm');
                            }
                            return;
                        }
                    }
                });
            }
        }

        $('#pblpReservationTotalCost').html(currency + ' ' + totalPrice.formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR));
        $('#pblpReservationCommission').html(currency + ' ' + totalCommission.formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR));
        $('#pblpReservationNetPrice').html(currency + ' ' + totalNetPrice.formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR));

        //UH coupon code
        if($('#pblpReservationPsgTotalCost').is(":visible"))
        {
            $('#pblpReservationPsgTotalCost').html(currency + ' ' + totalPrice.formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR));
            $('#roomTotalPrice').val(totalPrice);
        }

		//display pin user - if any
        $('#loyaltyPIN').off('keystop').on('keystop', 500, function(event)
        {
			if(!$.trim($('#loyaltyPIN').val()))
            {
                $('#loyaltyUser').val('');
                $(".pinmessage").html(noUserPINFound).removeClass("text-danger").removeClass("text-success").addClass("text-danger");
                return;
            }
            $(".pinmessage").html(checkingPIN).removeClass("text-danger").removeClass("text-success").addClass("text-success");
            $.ajax({
                url: _self.checkPINUrl + '/' + $.trim($('#loyaltyPIN').val()),
                dataType: 'json',
                type: "get",
                async: true,
                statusCode: {
                    302: function () {
                        window.location.href = BASE_CI_URL + '/login';
                    }
                }
            }).done(function (result) {
				if (result.success && result.message!=''){
                    $(".pinmessage").html(pinAcceptedForUser+result.message).removeClass("text-danger").removeClass("text-success").addClass("text-success");
                } else {
                    $(".pinmessage").html(result.message).removeClass("text-danger").removeClass("text-success").addClass("text-danger");
                }
                $('#loyaltyUser').val(result.success ? result.message : '');
            }).fail(function (xhr, err, errText) {
                $('#loyaltyUser').val('');
                $(".pinmessage").html(noUserPINFound).removeClass("text-danger").removeClass("text-success").addClass("text-danger");
            }).always(function() {

            });
        });

		_self.validator = new ValidatorWithLaravelRules();
		_self.validator.rules             = _self.rules;
		_self.validator.messages          = _self.messages;
		$.extend(
			true,
			_self.validator.messages,
			{
				error: _self.labelsText.error,
				invalidValue: _self.labelsText.invalidValue
			}
		);
		_self.validator.formId            = _self.formId;
		_self.validator.FormDoSearch = function() {
			var postvalidateResult = _self.postvalidatePassengersForm();
			if(postvalidateResult.type != 'okidoki')
			{
				Loader.hide();
				if(postvalidateResult.type == 'warning')
				{
                    bootbox.confirm({
                        message: postvalidateResult.messages[0],
                        buttons: {
                            cancel: {
                                label: Translations.getText('booking.button.no')
                            },
                            confirm: {
                                label: Translations.getText('booking.button.yes')
                            }
                        },
                        callback: function(result) {
                            if(result == true)
                            {
                                Loader.show();
                                _self.continueToBook($(_self.formId).attr('action'));
                            }
                        }

                    });
				}
				else if(postvalidateResult.type == 'missingPin')
                {
                    var missingPinModal =  $('#missingPinModal');
                    // Fill modal with remote content
                    missingPinModal.off('show.bs.modal').on('show.bs.modal', function(e) {
                        Loader.show();
                        $.ajax( BASE_CI_URL + '/modals/loyalty/secretKeyword' )
                            .done(function(data) {
                                Loader.hide();
                                missingPinModal.find('.modal-content').html(data);
                                $('#saveSecretKey').off('click').on('click', function() {
                                    $('#loyaltySecret').val( $('#missingPinSecretKey').val() );
                                    _self.continueToBook($(_self.formId).attr('action'));
                                });
                                $('#missingPinForm').off('submit').on('submit', function() {
                                    $('#saveSecretKey').trigger('click');
                                    return false;
                                });
                            });
                    });
                    missingPinModal.off('hidden.bs.modal').on('hidden.bs.modal', function () {
                        missingPinModal.find('.modal-content').empty();
                        $(this).removeData('bs.modal');
                    });
                    missingPinModal.modal('show');
                }
				else
				{
					AlertError.show(makeAMessagePanel(postvalidateResult.messages), _self.labelsText.error);
					return false;
				}
			}
			else
			{
				_self.continueToBook($(_self.formId).attr('action'));
			}
		};
		_self.validator.init();

		$(document).off('click','.saveBooking').on('click', '.saveBooking', function()
		{

            var redirect = $(this).data('redirect');
			_self.saveBooking(redirect);
		});

	};

    obj.nationalityTypeahead = function()
    {
        var countriesArr = $('#countryList').val();

        if (typeof countriesArr === 'undefined') {
            return;
        }

        countriesArr = jQuery.parseJSON(countriesArr);

        var Typeaheadcountries;
        Typeaheadcountries = new Bloodhound({
            datumTokenizer: function (d) {
                var trn = Bloodhound.tokenizers.whitespace(d.countryNamePhoneCode.toString());
                if(typeof IS_UMRAH_CUSTOMER !== "undefined" && Boolean(IS_UMRAH_CUSTOMER) === true && _currentLang == 'ar')
                {
                    var trnumrah = Bloodhound.tokenizers.whitespace(d.textEn.toString());
                    trn = trn.concat(trnumrah);
                }
                $.each(trn,function(k,v){
                    i = 0;
                    while( (i+1) < v.length ){
                        trn.push(v.substr(i,v.length));
                        i++;
                    }
                })
                return trn;
            },
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            local: countriesArr
        });

        Typeaheadcountries.initialize();

        //UH-1890 change to add Nationality
        $('.typeaheadFiledCountry').typeahead(
            {
                minLength: 2,
                highlight: true,
                hint: false
            },
            {
                name      : 'country',
                displayKey: 'text',
                source    :  Typeaheadcountries.ttAdapter(),
                templates : {
                    suggestion: function (ctx) {
                        var siteUrl = BASE_URL + (FOLDER ? '/' + FOLDER : '');
                        return '<p><img src="' + siteUrl + '/images/destination/country/flags/' + ctx['flag'] + '" alt="" style="width:40px; height:20px"/>' +
                            '&nbsp;&nbsp;' + ctx['text']+'</p>';
                    }
                }
            }).on('typeahead:selected', function (j, ctx) {
            var $parent = $(this).parents();
            $parent.find('input[name^="passengerNationality"]').val(ctx['val']);

            $('input[name^="nationality"]').val(ctx['val']);

            $parent.find('input[name^="textPassengerNationality"]').val(ctx['text']);
        }).on('blur', function () {
            var $this = $(this);
            var $input = $this.parents().find('input[name^="textPassengerNationality"]');
            var $inputID = $this.parents().find('input[name^="passengerNationality"]');

            var country = null;
            if($this.val().length >= 3) {
                var searchedText = $this.val().toLowerCase();

                $.each(countriesArr, function(idx, el) {
                    var txt = el.text.toLowerCase();
                    if(txt === searchedText) {
                        country = el;
                        return false;
                    }
                });  //passengerNationality
                if(typeof IS_UMRAH_CUSTOMER !== "undefined" && Boolean(IS_UMRAH_CUSTOMER) === true && _currentLang == 'ar')
                {
                    $.each(countriesArr, function(idx, el) {
                        var txt = el.textEn.toLowerCase();
                        if(txt === searchedText) {
                            country = el;
                            return false;
                        }
                    });
                }
                if(country === null)
                {
                    $.each(countriesArr, function(idx, el) {
                        var txt = el.text.toLowerCase();
                        if(txt.indexOf(searchedText) !== -1) {
                            country = el;
                            return false;
                        }
                    });
                    if(typeof IS_UMRAH_CUSTOMER !== "undefined" && Boolean(IS_UMRAH_CUSTOMER) === true && _currentLang == 'ar')
                    {
                        $.each(countriesArr, function(idx, el) {
                            var txt = el.textEn.toLowerCase();
                            if(txt.indexOf(searchedText) !== -1) {
                                country = el;
                                return false;
                            }
                        });
                    }
                }
            }
            if(country === null || country.val !== $input.val())
            {
                if(country === null)
                {
                    $input.val('');

                    $inputID.val('');
                    $this.val('');
                    $this.data('ttTypeahead').input.query = '';
                }
                else
                {
                    $input.val(country.text);

                    $inputID.val(country.val);
                    $this.val(country.text);
                    $this.data('ttTypeahead').input.query = country.text;
                }
            }
        }).on('keydown', function (event) {
            var code = event.keyCode || event.which;
            if(code === 13)
            {
                event.preventDefault();
                $(this).trigger('blur');
            }
        });


        $('.typeaheadFiled').typeahead(
            {
                minLength: 2,
                highlight: true,
                hint: false
            },
            {
                name      : 'country',
                displayKey: 'countryNamePhoneCode',
                source    :  Typeaheadcountries.ttAdapter(),
                templates : {
                    suggestion: function (ctx) {
                        var siteUrl = BASE_URL + (FOLDER ? '/' + FOLDER : '');
                        return '<p><img src="' + siteUrl + '/images/destination/country/flags/' + ctx['flag'] + '" alt="" style="width:40px; height:20px"/>' +
                            '&nbsp;&nbsp;' + ctx['countryNamePhoneCode']+'</p>';
                    }
                }
            }).on('typeahead:selected', function (j, ctx) {
            var $parent = $(this).parents();
            $parent.find('input[name^="countryPhoneCode"]').val(ctx['phoneCode']);
        }).on('blur', function () {
            var $this = $(this);
            var $input = $this.parents().find('input[name^="countryPhoneCode"]');
            var country = null;
            if($this.val().length >= 3) {
                var searchedText = $this.val().toLowerCase();

                $.each(countriesArr, function(idx, el) {
                    var txt = el.countryNamePhoneCode.toLowerCase();
                    if(txt === searchedText) {
                        country = el;
                        return false;
                    }
                });
                if(typeof IS_UMRAH_CUSTOMER !== "undefined" && Boolean(IS_UMRAH_CUSTOMER) === true && _currentLang == 'ar')
                {
                    $.each(countriesArr, function(idx, el) {
                        var txt = el.textEn.toLowerCase();
                        if(txt === searchedText) {
                            country = el;
                            return false;
                        }
                    });
                }
                if(country === null)
                {
                    $.each(countriesArr, function(idx, el) {
                        var txt = el.countryNamePhoneCode.toLowerCase();
                        if(txt.indexOf(searchedText) !== -1) {
                            country = el;
                            return false;
                        }
                    });
                    if(typeof IS_UMRAH_CUSTOMER !== "undefined" && Boolean(IS_UMRAH_CUSTOMER) === true && _currentLang == 'ar')
                    {
                        $.each(countriesArr, function(idx, el) {
                            var txt = el.textEn.toLowerCase();
                            if(txt.indexOf(searchedText) !== -1) {
                                country = el;
                                return false;
                            }
                        });
                    }
                }
            }
            if(country === null || country.val !== $input.val())
            {
                if(country === null)
                {
                    $input.val('');
                    $this.val('');
                    $this.data('ttTypeahead').input.query = '';
                }
                else
                {
                    $input.val(country.phoneCode);
                    $this.val(country.countryNamePhoneCode);
                    $this.data('ttTypeahead').input.query = country.countryNamePhoneCode;
                }
            }
        }).on('keydown', function (event) {
            var code = event.keyCode || event.which;
            if(code === 13)
            {
                event.preventDefault();
                $(this).trigger('blur');
            }
        });
    };

    obj.updateRoomsGroup = function(select)
    {
        var _self = Accommodation.Booking;
        //hotel
        select = $(select);
        var hotel = select.closest('div.search-result_row');
        //already have a hotel with rooms?
        if(_self.lastHotelSelection.hotelId > 0 && parseInt(hotel.data('hotelid'), 10) != _self.lastHotelSelection.hotelId && select[0].selectedIndex > 0)
        {
            if(_self.lastHotelSelection.waitingForInput) //return if confirm box if already displayed
            {
                return;
            }
            _self.lastHotelSelection.waitingForInput = true;

            bootbox.confirm({
                message: _self.labelsText.roomSelectionChange,
                buttons: {
                    cancel: {
                        label: Translations.getText('booking.button.no')
                    },
                    confirm: {
                        label: Translations.getText('booking.button.yes')
                    }
                },
                callback: function(result) {
                    if(result == false)
                    {
                        select[0].selectedIndex = 0;
                        _self.lastHotelSelection.waitingForInput = false;
                        return;
                    }
                    else
                    {
                        _self.updateThisGroup(hotel, select, true);
                        _self.lastHotelSelection.waitingForInput = false;
                    }
                }
            });
        }
        else
        {
            _self.updateThisGroup(hotel, select, false);
        }
    };

    obj.updateThisGroup = function(hotel, select, clear)
    {
        var _self = Accommodation.Booking;
        var amount = 0.0;
        var elem = 'div';
        if(isOldIE() == 7 ) {
            elem = '';
        }

        //clear the current selection price box
        if(clear)
        {
            $('select.multipleRoomsSelect', $('#hotel_' + _self.lastHotelSelection.hotelId + '_row')).each(function() {
                $(this).prop('disabled', false);
                this.selectedIndex = 0;
            });
            _self.lastHotelSelection.hotelId = 0;
            $('.shoppingcart_container .total h4').html($('#activeCurrency').data('activecurrencyname') + ' ' + amount.formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR));
        }
        //if is from load search results just return
        if(hotel === null || select === null)
        {
            return;
        }

        //current selected hotel id
        _self.lastHotelSelection.hotelId = parseInt(hotel.data('hotelid'), 10);

        // update rooms group
        var $group = select.closest(elem +'.rooms-details');
        $('select.multipleRoomsSelect', $group).each(function() {
            $(this).prop('disabled', false);
        });

        if ( parseInt($('#searchRoomsNo').val(), 10) > 5) {

            let searchRoomContainer = $group.parent().find('.rdRow');
            let ratePlanCode = select.parent().parent().data('rateplancode.1')

            searchRoomContainer.each(function(k,v){
                if($(v).data('rateplancode.1') !== ratePlanCode){
                    $(v).find('select').not(select).attr('disabled', true)
                }
            })

            $('.rdrCenter').on('click', function(ev) {
                if($(this).find('.multipleRoomsSelect').prop('disabled') == true) {

                    searchRoomContainer.each(function(k,v){
                        $(this).find('.multipleRoomsSelect').attr('disabled', false).val(0);
                    })
                }

            })

        }

        var matches = _self.matchRoomsAndRates($group, select);
        //console.log(matches);

        //how much to pay?
        $('select.multipleRoomsSelect:enabled', hotel).each(function() {
            var foundRoomsInGroup = parseInt($(this).val(), 10);
            for(var i = 0; i < foundRoomsInGroup; i++)
            {
                amount += parseFloat($(this).closest(elem +'.rdRow').data('roomprice.' + (i + 1))); //update the selection cost
            }
        });
        if(amount == 0.0) //none so must have no room
        {
            _self.lastHotelSelection.hotelId = 0;
        }

        $('.shoppingcart_container .total h4').html($('#activeCurrency').data('activecurrencyname') + ' ' + amount.formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR));
    };

    obj.matchRoomsAndRates = function($group, select)
    {
        var elem = 'div';
        if(isOldIE() == 7 ) {
            elem = '';
        }

        //which rooms are in this group
        var roomsIdInGroup = $group.data('groupedroomsno');
        roomsIdInGroup = typeof roomsIdInGroup !== 'string' ? roomsIdInGroup.toString().split(',') : roomsIdInGroup.split(',');
        roomsIdInGroup = $.map(roomsIdInGroup, function( val, i ) {
            return {roomId: parseInt(val, 10), room: null, idx: 1};
        });
        roomsIdInGroup = roomsIdInGroup.sort(function(a, b){ //reverse sort
            return b.roomId - a.roomId;
        });

        //selected rates in this group
        var ratesArray = [];
        $('select.multipleRoomsSelect', $group).each(function() {
            var foundRatesInGroup = parseInt($(this).val(), 10);
            for(var i = 0; i < foundRatesInGroup; i++) {
                ratesArray.push({rate : $(this).closest(elem + '.rdRow'), current : this === select[0] ? true : false});
            }
        });

        if(ratesArray.length == 0) {
            return roomsIdInGroup;
        }
        //console.log(ratesArray);

        // first match the current selection
        for(var i = 0; i < ratesArray.length;)
        {
            if(ratesArray[i].current === true)
            {
                if(roomsIdInGroup.length == 1) //simple 1 on 1
                {
                    var item = ratesArray.splice(i, 1);
                    roomsIdInGroup[0].room = item[0].rate[0];
                }
                else
                {
                    var aRateFound = false;
                    for(var j = 0; j < roomsIdInGroup.length && i < ratesArray.length; j++)
                    {
                        var ratesCount = parseInt(ratesArray[i].rate.data('roomscount'), 10);
                        for(var k = ratesCount; k > 0; k--)
                        {
                            if(parseInt(ratesArray[i].rate.data('roomrunno.' + k), 10) + 1 == roomsIdInGroup[j].roomId) //a match
                            {
                                var item = ratesArray.splice(i, 1);
                                roomsIdInGroup[j].room = item[0].rate[0];
                                roomsIdInGroup[j].idx = k;
                                break;
                            }
                            if(roomsIdInGroup[j].room !== null) {
                                break;
                            }
                        }
                        if(roomsIdInGroup[j].room !== null) {
                            aRateFound = true;
                        }
                    }
                    if(!aRateFound) {
                        i++;
                    }
                }
            }
            else {
                i++;
            }
        }
        //console.log(roomsIdInGroup);

        // now match the remaining rooms
        for(var i = 0; i < roomsIdInGroup.length; i++)
        {
            if(roomsIdInGroup[i].room === null)
            {
                for(var j = 0; j < ratesArray.length; j++)
                {
                    if(parseInt(ratesArray[j].rate.data('roomscount'), 10) == 1 && parseInt(ratesArray[j].rate.data('roomrunno.1'), 10) + 1 == roomsIdInGroup[i].roomId) //a match
                    {
                        //console.log('hit');
                        var item = ratesArray.splice(j, 1);
                        roomsIdInGroup[i].room = item[0].rate[0];
                        j--;
                        break;
                    }
                }
                //try to find a match in remaining rooms
                if(roomsIdInGroup[i].room === null)
                {
                    for(var j = 0; j < ratesArray.length; j++)
                    {
                        for(var k = parseInt(ratesArray[j].rate.data('roomscount'), 10); k > 0; k--)
                        {
                            if(parseInt(ratesArray[j].rate.data('roomrunno.' + k), 10) + 1 == roomsIdInGroup[i].roomId) //a match
                            {
                                //console.log('hit');
                                var item = ratesArray.splice(j, 1);
                                roomsIdInGroup[i].room = item[0].rate[0];
                                roomsIdInGroup[i].idx = k;
                                j--;
                                break;
                            }
                        }
                        if(roomsIdInGroup[i].room !== null) {
                            break;
                        }
                    }
                }
            }
        }
        //console.log(roomsIdInGroup);

        //roomsIdInGroup = roomsIdInGroup.sort(function(a, b){
        //    return a.roomId > b.roomId;
        //});
        // remove rates surplus
        if(ratesArray.length > 0) { //still have some rates :)
            for(var i = 0, j = ratesArray.length; i < j; i++) {
                //console.log(ratesArray[i]);
                $('select.multipleRoomsSelect', ratesArray[i].rate).each(function() {
                    this.selectedIndex--;
                });
            }
        }

        //now check if we have at least one rate for every room
        for(var i = 0; i < roomsIdInGroup.length; i++)
        {
            if(roomsIdInGroup[i].room === null)
            {
                var ratesAreDisplayed = false;
                $('select.multipleRoomsSelect:visible', $group).each(function() {
                    var $row = $(this).closest('div.rdRow');
                    for(var k = parseInt($row.data('roomscount'), 10); k > 0; k--)
                    {
                        if(parseInt($row.data('roomrunno.' + k), 10) + 1 == roomsIdInGroup[i].roomId) {
                            ratesAreDisplayed = true;
                            break;
                        }
                    }
                });
                if(!ratesAreDisplayed)
                {
                    $group.find(elem +'.rdRow:not(.notInFilterRangeBoardBasis, .notInFilterRangeRateType)').removeClass('hidden');
                }
            }
        }

        return roomsIdInGroup;
    };

	obj.continueToBook = function (bookingUrl)
	{
        var _self = Accommodation.Booking;
        if(typeof IS_UMRAH_CUSTOMER !== "undefined" && Boolean(IS_UMRAH_CUSTOMER) === true && Boolean(_self.ccCustomer)===false && IS_MAQAM==0)
        {
            $('#umrah_search_book_loader').modal('show');
            $('.loader-bg-booking').show();
            $('.loader-bg').css("z-index", '');
        }
        else {
            Loader.show ();
        }

        var _self = Accommodation.Booking;
        var roomNo = 1;
		var bookingParams = {};
		var _bookingParams = $(_self.formId).serializeObject();

		// except extraMeals
		$.each(_bookingParams, function(idx, value){
			if(idx.indexOf('extraMeals') == -1){
				bookingParams[idx] = value;
			}});

		bookingParams = $.extend(bookingParams, _self.bookingParams);
		bookingParams['productCode'] = _self.$hotel.data('hotelid');

		bookingParams = $.param (bookingParams);

        //send extra meals for ALL rooms
        while(roomNo <= $('#searchRoomsNo').val())
        {
            if($('#pbcpExtraMeals' + roomNo).prop('checked') && Array.isArray(selectedExtraMeals[roomNo]) && selectedExtraMeals[roomNo].length > 0)
            {
                $.each(selectedExtraMeals[roomNo], function (idx, elem)
                {
                    var validMeal = elem.serializeInputs(idx);
                    if (validMeal.length > 0)
                    {
                        bookingParams = bookingParams + elem.serializeInputs(idx);
                    }
                });
            }
            roomNo++;
        }

		//var nonRefundable = false;
		var action, callback;

		if (_self.ccCustomer || _self.hasItinerary || bookingWithNonRefundableRates || bookingForceCCPayment)
		{
            action = 'saveBooking';
			callback = function (response)
			{
                var data = $(response);

                if(typeof(response.returnedCode) != "undefined"){
                    var successful = response.success,
                        itineraryNumber = response.returnedCode;
                } else {
                    var successful = data.find('result successful').text(),
                        itineraryNumber = data.find('result returnedCode').text();
                }

                if (successful.toString().toUpperCase() == 'TRUE')
                {
                    BookItineraryCnt.getItineraryQuotation(itineraryNumber);
                    ShoppingCart.init();
                    if ($('#isSinglePage').length > 0) {
                        $('#missingPinModal').modal('hide');
                    }else{
                        _self.showResults(false);
                    }
                    if(bookingForceCCPayment) {
                        BookItineraryCnt.bookingForceCCPayment = true;
                    }
                } else if(successful == 'FALSE') {

                    AlertError.show(makeAMessagePanel(data.find('result error details').text()), _self.labelsText.error);
                }
			};
		}
		else
		{
			action = 'confirmBooking';
			callback = function (data)
			{
				if(data.returnedCode > 0)
				{
					window.location.href = BASE_CI_URL + '/bookings?ref=' + data.returnedCode;
				}
				else
				{
					window.location.href = BASE_CI_URL + '/bookings/' + data.bookingCode;
				}
			};
		}

		doRequest(bookingUrl + '/' + action, bookingParams, function(response)
		{
            if(typeof IS_UMRAH_CUSTOMER !== "undefined" && Boolean(IS_UMRAH_CUSTOMER) === true)
            {
                $('#umrah_search_book_loader').modal('hide');
                $('.loader-bg-booking').hide();
            }
            else {
                Loader.hide();
            }
            if (response.success === false) {
                AlertError.show(response.message, _self.labelsText.error);
                AlertError.setWidth('550px');
                AlertError.setModalBodyPadding('20px');
            } else if (response.success === 'supplierWarning') { // supplier returns an error at confirm
                // display ModalFor Different allocation
                AlertInfo.show(response.message, response.warningTitle);
                AlertInfo.setWidth('60%');
                AlertInfo.setMinWidth('600px');
                $('#supplierWarningHolder').parents('.modal').on('click', function (e) {
                    e.preventDefault();
                    e.stopImmediatePropagation();
                });
            } else if (response.success === 'wallet-confirmation') {
                WalletConfirmation.showModal();
            } else {
                Accommodation.Booking.validateDuplicate = true;
                callback(response);
            }
		});

	};

	obj.saveBooking = function(redirectURL)
	{
        var _self = this;

		var form = $(_self.formId);
		var bookingUrl = form.attr('action');
		var roomNo = 1;
		var bookingParams = {};
		var _bookingParams = $(_self.formId).serializeObject();

		// except extraMeals
		$.each(_bookingParams, function(idx, value){
			if(idx.indexOf('extraMeals') == -1 && idx.indexOf('loyaltySecret') == -1){
				bookingParams[idx] = value;
			}});

		bookingParams = $.extend(bookingParams, _self.bookingParams);
		bookingParams['productCode'] = _self.$hotel.data('hotelid');
		bookingParams = $.param(bookingParams);

        //send extra meals for ALL rooms
        while(roomNo <= $('#searchRoomsNo').val()){
            if($('#pbcpExtraMeals' + roomNo).prop('checked') && Array.isArray(selectedExtraMeals[roomNo]) && selectedExtraMeals[roomNo].length > 0)
            {
                $.each(selectedExtraMeals[roomNo], function (idx, elem)
                {
                    var validMeal = elem.serializeInputs(idx);
                    if (validMeal.length > 0)
                    {
                        bookingParams = bookingParams + elem.serializeInputs(idx);
                    }
                });
            }
            roomNo++;
        }

        var callbackSave = function(response)
        {
            if(response.success === false) {
                AlertError.show(response.message, _self.labelsText.error);
                AlertError.setWidth('550px');
                AlertError.setModalBodyPadding('20px');
            }
            else {
                if(typeof IS_UMRAH_CUSTOMER !== "undefined" && Boolean(IS_UMRAH_CUSTOMER) === true) {
                    window.location.href = BASE_CI_URL + '/booking-management/savebooking/' + response.bookingIds[0];
                } else {
                    window.location.href = redirectURL || BASE_CI_URL + '/accommodation';
                }
            }
        };
        var FormDoSearch = function()
		{
            var postvalidateResult = _self.postvalidatePassengersForm();
            if(postvalidateResult.type != 'okidoki')
			{
                Loader.hide();
                if(postvalidateResult.type == 'warning')
				{
                    bootbox.confirm({
                        message: postvalidateResult.messages[0],
                        buttons: {
                            cancel: {
                                label: Translations.getText('booking.button.no')
                            },
                            confirm: {
                                label: Translations.getText('booking.button.yes')
                            }
                        },
                        callback: function(result) {
                            if(result == true) {
								bookingParams += '&loyaltySecret=' + encodeURIComponent($('#loyaltySecret').val());
                                Loader.show();
                                doRequest(bookingUrl + '/saveBooking', bookingParams, callbackSave);
                            }
                        }
                    });
                }
                else if(postvalidateResult.type == 'missingPin')
                {
                    var missingPinModal =  $('#missingPinModal');
                    // Fill modal with remote content
                    missingPinModal.off('show.bs.modal').on('show.bs.modal', function(e) {
                        Loader.show();
                        $.ajax( BASE_CI_URL + '/modals/loyalty/secretKeyword' )
                            .done(function(data) {
                                Loader.hide();
                                missingPinModal.find('.modal-content').html(data);
                                $('#saveSecretKey').off('click').on('click', function() {
                                    bookingParams += '&loyaltySecret=' + encodeURIComponent($('#missingPinSecretKey').val());
                                    Loader.show();
                                    doRequest(bookingUrl + '/saveBooking', bookingParams, callbackSave);
                                });
                            });
                    });
                    missingPinModal.off('hidden.bs.modal').on('hidden.bs.modal', function () {
                        missingPinModal.find('.modal-content').empty();
                        $(this).removeData('bs.modal');
                    });
                    missingPinModal.modal('show');
                }
                else {
                    AlertError.show(makeAMessagePanel(postvalidateResult.messages), _self.labelsText.error);
                    return false;
                }
            }
            else {
				bookingParams += '&loyaltySecret=' + encodeURIComponent($('#loyaltySecret').val());
                doRequest(bookingUrl + '/saveBooking', bookingParams, callbackSave);
            }
        };

        if(_self.saveValidator === null)
        {
            _self.saveValidator = new ValidatorWithLaravelRules();
            _self.saveValidator.rules = _self.rules;
            _self.saveValidator.messages = _self.messages;
            _self.saveValidator.formId = _self.formId;
            _self.saveValidator.events = 'validate';
            $.extend(
                true,
                _self.saveValidator.messages,
                {
                    error: _self.labelsText.error,
                    invalidValue: _self.labelsText.invalidValue
                }
            );
            _self.saveValidator.init();
        }
        _self.saveValidator.FormDoSearch = FormDoSearch;
		$(_self.formId).trigger('validate');
	};

    obj.getDataFromStorage = function(name)
    {
        if(typeof(Storage) !== "undefined") {
            return localStorage.getItem(name);
        }
        else {
            return '';
        }
    };

    obj.saveDataToStorage = function(name, value)
    {
        if(typeof(Storage) !== "undefined") {
            return localStorage.setItem(name, value);
        }
    };

    obj.deleteDataFromStorage = function(name)
    {
        if(typeof(Storage) !== "undefined") {
            return localStorage.removeItem(name);
        }
    };

    obj.getGuardedString = function(data)
    {
        data = data.split('&');

        var filter = [
                    'title',
                    'firstName',
                    'lastName',
                    'dateFrom',
                    'dateTo',
                    'roomsNo',
                    'residency',
                    'nationality',
                    'adultsCount',
                    'childrenCount',
                    'childrenAges',
                    'roomTypeCode',
                    'roomRateBasis',
                    'productCode',
                    'roomToken'
                ];

        data = data.filter(function(value) {
            value = value.split('=');
            value = value[0].indexOf('%') > 0 ? value[0].substring(0, value[0].indexOf('%')) : value[0];

            for(var i = 0, j = filter.length; i < j; i++)
            {
                if(value == filter[i]) {
                    return true;
                }
            }
            return false;
        });

        data = data.sort();
        data = data.join('&');

        return data;
    };

	var doRequest = function(action, params, callback, type)
	{
        if(action.indexOf('confirmBooking') > -1 || action.indexOf('saveBooking') > -1)
        {
            var timestamp = Math.floor(Date.now() / 1000);
            var duplicate = Accommodation.Booking.getGuardedString(params);
            var duplicateGuard = Accommodation.Booking.getDataFromStorage('ciDuplicateGuard');
            var duplicateTimestamp = Accommodation.Booking.getDataFromStorage('ciDuplicateTimestamp');

            if(
                duplicateGuard == ''
                || duplicateGuard != duplicate
                || (duplicateGuard == duplicate && timestamp - duplicateTimestamp > 120)
            ) {
                Accommodation.Booking.saveDataToStorage('ciDuplicateGuard', duplicate);
                Accommodation.Booking.saveDataToStorage('ciDuplicateTimestamp', timestamp);
            }
            else if (Accommodation.Booking.validateDuplicate)
            {
                Loader.hide();
                AlertError.show(makeAMessagePanel(Accommodation.Booking.labelsText.duplicateBookingError), Accommodation.Booking.labelsText.error);
                AlertError.setWidth('700px');
                AlertError.setModalBodyPadding('20px');
                return;
            }

            params += '&stack=' + encodeURIComponent(new Error().stack);
            params += '&browser=' + encodeURIComponent(navigator.userAgent);
        }

		$.ajax({
			url:      action,
			dataType: type || 'json',
			type:     'POST',
			data:     params,
            async: true,
			success:  function (response)
			{
				if ($.isFunction(callback))
				{
					callback(response);
				}
			},
			error:    function (xhr, type, error)
			{
				//console.log(xhr, type, error);

				if (xhr.status != 302)
				{
                    AlertError.show(xhr.reponseText, Accommodation.Booking.labelsText.error);
				}
			}
		}).always(function() {
			Loader.hide();
			if (Compare.bookFromPopupList == true) {
                Compare.remove(false, 'allHotels');
                Compare.bookFromPopupList = false;
            }
		});
	};

	obj.loadRoomMandatoryServices = function(roomId)
	{
		var _self = Accommodation.Booking;

		//var $room = $(_self.selectedRooms[roomId].room);

		var toSerialize = [
			'#fromDatepicker',
			'#dateFrom',
			'#toDatepicker',
			'#dateTo'
		];

		var params = '';
		$.each(toSerialize, function (idx, selector) {
			var $input = $(selector);
			params += '&' + encodeURIComponent($input.attr('name')) + '=' + encodeURIComponent($input.val());
		});

		//console.log($room, params);

		var $content = $('#additionalMandatoryServicesContainer' + roomId);
		$.ajax({
			url: _self.additionalMandatoryServicesUrl + '/' + _self.$hotel.data('hotelid'),
			dataType: 'json',
			type: "get",
			async: true,
			data: params + '&roomNo=' + roomId + '&mandatoryservices=' + $content.data('mandatoryservices'),
			statusCode: {
				302: function () {
					window.location.href = BASE_CI_URL + '/login';
				}
			}
		}).done(function (result) {
			if(result.success === false) {
				AlertError.show(result.html, _self.labelsText.error);
				AlertError.setWidth('550px');
				AlertError.setModalBodyPadding('20px');
			} else {
				$content.html(result.html);
			}
		}).fail(function (xhr, err, errText) {
			// only show the alert if the status is not a redirect
			if(xhr.status != 302)
			{
				AlertError.show(xhr.responseText, _self.labelsText.error);
			}
		}).always(function() {

		});
	};

	obj.showNextPassengerId = function(roomId, passengerId)
	{
		$('#pbcpPassengerData' + roomId + '_' + (passengerId + 1)).fadeIn(250).css('display','table-row');
		$('#pbcpPassengerData' + roomId + '_' + passengerId).find('.showPassenger').hide();
		$('#pbcpPassengerData' + roomId + '_' + passengerId).find('.hidePassenger').hide();
		$('#passengersNo' + roomId).val(passengerId + 2);

		$('#pbcpPassengerData' + roomId + '_' + (passengerId + 1) + ' select, #pbcpPassengerData' + roomId + '_' + (passengerId + 1) + ' input').prop('disabled', false);
	};

	obj.hideThisPassengerId = function(roomId, passengerId)
	{
		$('#pbcpPassengerData' + roomId + '_' + passengerId).fadeOut(250);
		$('#pbcpPassengerData' + roomId + '_' + (passengerId - 1)).find('.showPassenger').show();
		$('#pbcpPassengerData' + roomId + '_' + (passengerId - 1)).find('.hidePassenger').show();
		$('#passengersNo' + roomId).val(passengerId);

		$('#pbcpPassengerData' + roomId + '_' + passengerId + ' select, #pbcpPassengerData' + roomId + '_' + passengerId + ' input').prop('disabled', 'disabled');
	};

	obj.showHideSpecialRequests = function(roomId)
	{
		if($('#pbcpRequests' + roomId).prop('checked'))
		{
			$('#requestsContainer' + roomId).fadeIn(500);
		}
		else
		{
			$('#requestsContainer' + roomId).fadeOut(500);
		}
	};

	obj.showHideMeals = function(roomId)
	{
		var _self = Accommodation.Booking;
		if($('#pbcpExtraMeals' + roomId).prop('checked'))
		{
			if($('#extraMealsTable' + roomId).find('tr.mealContainer').length == 0)
			{
				_self.addMeal(roomId);
			}
			if(Array.isArray(selectedExtraMeals[roomId]) && selectedExtraMeals[roomId].length > 0)
			{
				var firstMeal = selectedExtraMeals[roomId][0];
				firstMeal.updatePrice();
			}
			$('#extraMealsContainer' + roomId).fadeIn(250);
			$('#mealsNo' + roomId).val(window.selectedExtraMeals[roomId].length);
		}
		else
		{
			$('#extraMealsContainer' + roomId).fadeOut(250);
			_self.updateRoomTotalCost(roomId, 0);
			$('#mealsNo' + roomId).val(0);
		}
	};

	obj.addMeal = function(roomId)
	{
		var _self = Accommodation.Booking;
		new ExtraMeals(roomId, _self.addMeal, _self.removeMeal, _self.updateRoomTotalCost);
	};

	obj.removeMeal = function(roomId, mealId)
	{
		var _self = Accommodation.Booking;
		if(Array.isArray(selectedExtraMeals[roomId]) && selectedExtraMeals[roomId].length > 0)
		{
			bootbox.confirm({
                message: _self.labelsText.removeMeals,
                buttons: {
                    cancel: {
                        label: Translations.getText('booking.button.no')
                    },
                    confirm: {
                        label: Translations.getText('booking.button.yes')
                    }
                },
                callback: function(result) {
                    if(result)
                    {
                        selectedExtraMeals[roomId] = $.grep(selectedExtraMeals[roomId], function(meal) {
                            if(meal._id == mealId)
                            {
                                meal.remove();
                                return false;
                            }
                            else
                            {
                                return true;
                            }
                        });
                    }
                }
            });
		}
	};

	obj.updateRoomTotalCost = function(roomId, price, mealCommission, mealNetPrice)
	{
		var _self = Accommodation.Booking;

        if(_self.mealPriceUpdateInfo.roomId == roomId && _self.mealPriceUpdateInfo.price == price) {
            return;
        }

        _self.mealPriceUpdateInfo.roomId = roomId;
        _self.mealPriceUpdateInfo.price = price;

        var $room = $(_self.selectedRooms[roomId].room);
        var idx = _self.selectedRooms[roomId].idx;

        //extra meals price
        $('#pblpExtraMealsCost' + roomId).html($room.data('currency.' + idx) + ' ' + price.formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR));

        //add room price
        price += parseFloat($room.data('roomprice.' + idx));

        //total room price
        $('#pblpTotalRoomCost' + roomId)
        .data('totalcost', price)
        .data('commission', $room.data('commission'))
        .data('netprice', $room.data('netprice'))
        .html($room.data('currency.' + idx) + ' ' + price.formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR));

        var totalPrice = 0, commission = 0, netPrice = 0;

        commission += parseFloat(mealCommission);
        netPrice   += parseFloat(mealNetPrice);

        $('td[id^="pblpTotalRoomCost"]').each(function()
        {
            totalPrice += parseFloat($(this).data('totalcost'));
            commission += parseFloat($(this).data('commission'));
            netPrice   += parseFloat($(this).data('netprice'));
        });

        var currency = $('#pblpTotalRoomCost1').data('currency');
        $('#pblpReservationTotalCost').html(currency + ' ' + totalPrice.formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR));
        $('#pblpReservationCommission').html(currency + ' ' + commission.formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR));
        $('#pblpReservationNetPrice').html(currency + ' ' + netPrice.formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR));

        //UH coupon code
        if($('#pblpReservationPsgTotalCost').is(":visible"))
        {
            $('#pblpReservationPsgTotalCost').html(currency + ' ' + totalPrice.formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR));
        }

    };

	obj.showHideBeddingWarning = function(roomId)
	{
		if($('#pbcpBedding' + roomId).val() == 0)
		{
			$('#pbcpBeddingAvailability' + roomId).hide();
		}
		else
		{
			$('#pbcpBeddingAvailability' + roomId).show();
		}
	};

	obj.postvalidatePassengersForm = function()
	{
		var _self = Accommodation.Booking;
		//clear errors class
		$(_self.formId).find('.error').removeClass('error');

		//validation result
		var result = {type: 'okidoki', messages: []};

		// validate supplier specific rules
		if(typeof window.supplierRules != 'undefined')
		{
			for(var i = 0; i < supplierRules.length; i ++)
			{
				var supplier = supplierRules[i];
				var roomNo = parseInt(supplier["roomRunNo"], 10) + 1;
				var passengersCount = parseInt($('#passengersNo' + roomNo).val(), 10);

				// validate passenger names using the supplier's regular expression
				if(supplier["regex"] && passengersCount > 0)
				{
					var reg = new RegExp(supplier['regex']);
					for(var ii = 0; ii < passengersCount; ii++)
					{
						var input = $('#pbcpFirstName' + roomNo + '_' + ii);
						if(!reg.test(input.val()))
						{
							input.addClass('error');
							result.type = 'error';
							result.messages.push(supplier['message']);
							break;
						}
						input = $('#pbcpLastName' + roomNo + '_' + ii);
						if(!reg.test(input.val()))
						{
							input.addClass('error');
							result.type = 'error';
							result.messages.push(supplier['message']);
							break;
						}
					}
				}

				// validate unique names in each room
				if(supplier['uniqueNames'] && passengersCount > 0)
				{
					var hashes = [];
					for(var ii = 0; ii < passengersCount; ii++)
					{
						var hash = $('#pbcpFirstName' + roomNo + '_' + ii).val() + '@' + $('#pbcpLastName' + roomNo + '_' + ii).val();
						if($.inArray(hash, hashes) != -1)
						{
							result.type = 'error';
							result.messages.push(_self.labelsText.passengersUniqueNames);
							$('#pbcpPassengerData' + roomNo + '_' + ii).addClass('error');
							break;
						}
						else
						{
							hashes.push(hash);
						}
					}
				}
			}
            result.messages = $.unique(result.messages);
		}

		//validate additional mandatory services
		$(_self.formId).find('[data-amsrequired="required"]').each(function (idx, el) {

			var $el = $(el);
			if($.trim(el.value) == '')
			{
				$el.addClass('error');
				//console.log($el);
				result.type = 'error';
				result.messages.push(_self.labelsText.amsRequired);
				return false;
			}
			// ams radio/checkboxes
			else if ($el.attr('data-multiple') == '1')
			{
				var name = $el.attr('name');
				// get all inputs with the same name
				var inputs = $(_self.formId).find('[name="' + name + '"]');

				// it mean we have no input checked
				if(inputs.length == inputs.filter(':not(:checked)').length)
				{
					$el.parent().parent().parent().addClass('error');
					result.type = 'error';
					result.messages.push(_self.labelsText.amsNoOptionSelected);
					return false;
				}
			}
		});

		//if not already failed check the passengers duplicate names
		if(result.type == 'okidoki')
		{
			var hashes = [];
			for(var i = 1; ; i++)
			{
				if(typeof $('#passengersNo' + i)[0] === 'undefined')
				{
					break;
				}
				if(!Array.isArray(hashes[i]))
				{
					hashes[i] = [];
				}
				var passengersCount = parseInt($('#passengersNo' + i).val(), 10);
				for(var ii = 0; ii < passengersCount; ii++)
				{
					var hash = $('#pbcpFirstName' + i + '_' + ii).val() + '@' + $('#pbcpLastName' + i + '_' + ii).val();
					var isDuplicate = false;
					//check in previous rooms
					for(var k = 1; k < i; k++)
					{
						if($.inArray(hash, hashes[k]) != -1)
						{
							isDuplicate = true;
							break;
						}
					}
                    if (isDuplicate && Boolean(IS_UMRAH_CUSTOMER) !== true)
					{
						result.type = 'warning';
						result.messages.push(_self.labelsText.passengersDuplicateNames.replace('#i', i));
					}
					else
					{
						hashes[i].push(hash);
					}
				}
			}
		}

		//if not already failed check the loyalty pin
		if(result.type == 'okidoki' && typeof $('#loyaltyPIN')[0] !== 'undefined')
        {
            var PIN         = $.trim($('#loyaltyPIN').val());
            var User        = $.trim($('#loyaltyUser').val());
            var nonrefundable = $('#loyaltyPIN').data('nonrefundable');

            if(!(PIN != '' && User != '')) {
                if(nonrefundable) {
                    result.type = 'warning';
                    result.messages.push(_self.labelsText.missingPINnonRefundable);
                }
                else {
                    result.type = 'missingPin';
                }
            }
        }

		return result;
	};

    obj.showBookingTC = function()
    {
        var _self = Accommodation.Booking;

        var selectedRooms = $.extend(true, [], _self.selectedRooms);
        for(var i = 1, ii = selectedRooms.length; i <= ii; i++)
        {
            if(!selectedRooms.hasOwnProperty(i))
            {
                continue;
            }
            selectedRooms[i].grp = [];
            selectedRooms[i].grp.push(selectedRooms[i].roomId);

            for(var j = i + 1; j <= ii; j++)
            {
                if(!selectedRooms.hasOwnProperty(j))
                {
                    continue;
                }

                if(selectedRooms[i].room === selectedRooms[j].room)
                {
                    //console.log('duplicate: ', selectedRooms[i], selectedRooms[j]);
                    selectedRooms[i].grp.push(selectedRooms[j].roomId);
                    selectedRooms.splice(j, 1);
                    j--;
                }
            }
        }

        //console.log(_self.selectedRooms, selectedRooms);

        var html = '<div class="col-12">';

        $.each(selectedRooms, function(idx, selectedRoom) {
            if(selectedRooms.hasOwnProperty(idx))
            {
                var $room = $(selectedRoom.room);

                html += '<div class="panel">';
                //room title
                if(selectedRoom.grp.length == 1) {
                    html += '<div class="panel-heading bg-info">' + _self.labelsText.roomText + ' # ' + selectedRoom.grp[0] + ': ' + $room.find('div').first().text() + '</div>';
                }
                else {
                    html += '<div class="panel-heading bg-info">' + _self.labelsText.roomsText + ' # ';
                    for(var i = 0; i < selectedRoom.grp.length; i++)
                    {
                        html += selectedRoom.grp[i];
                        if(i < selectedRoom.grp.length - 2) {
                            html += ', ';
                        }
                        else if(i < selectedRoom.grp.length - 1) {
                            html += ' ' + _self.labelsText.andText + ' ';
                        }
                    }
                    html += ': ' + $room.find('div').first().text() + '</div>';
                }

                html += '<div class="panel-body" style="padding-left: 0; padding-right: 0;">';

                //rate notes
                var rateNotes = $room.find('.rdrRight .icon-notes');
                if(rateNotes.data('title') != null && (rateNotes.data('content') != null || rateNotes.data('content-position') >= 0))
                {
                    html += '<div class="panel panel-danger">';
                    html += '<div class="panel-heading">' + rateNotes.data('title') + '</div>';
                    if(rateNotes.data('content') != null) {
                        html += '<div class="panel-body row">' + rateNotes.data('content') + '</div>';
                    }
                    else
                    {
                        var pos = rateNotes.data('content-position');
                        var notes = $room.parents('.search-result_row').find('input[name="tariffNotesRoom"]').val();
                        notes = notes.substring(pos);
                        pos = notes.indexOf('!#@#!');
                        html += '<div class="panel-body row">' + notes.substring(0, pos) + '</div>';
                    }
                    html += '</div>';
                }

                // Hardcode for Expedia RAPID terms
                /*html += '<div class="panel panel-danger"><div class="panel-heading">Rate Terms & Conditions</div>';
                html += '<div class="panel-body row">The online accommodation reservation service and content provided ' +
                        'through this Website might <span style="color:#ff1600">be</span> supplied by <span style="color:#ff1600">EPS</span>, and it is governed by ' +
                        'this entity\'s <a href="http://developer.ean.com/terms/en/" target="_blank">http://developer.ean.com/terms/en/</a>, which users have to accept when making a reservation ' +
                        'and by <a href="http://developer.ean.com/terms/agent/en/" target="_blank">http://developer.ean.com/terms/agent/en/</a>, which agents have to accept when making a reservation.</div></div>';*/

                //cancellation rules
                var cancelRules = Accommodation.Search.getCancellationRulesHtmlFromJson($room.find('input[name="cancellationRulesJson"]').val());
                html += '<div class="panel panel-danger">';
                html += '<div class="panel-heading">' + _self.labelsText.roomCPHeader + '</div>';
                html += '<div class="panel-body row">' + cancelRules + '</div>';
                html += '</div>';

                html += '</div>';
                html += '</div>';
            }
        });

        html += '<div class="panel panel-danger">';

        if(typeof IS_UMRAH_CUSTOMER !== "undefined" && Boolean(IS_UMRAH_CUSTOMER) === true) //contract PDF for umrah
        {
            html += '<div class="panel-body row text-center"><a target="_blank" download href="' + BASE_URL+'/Terms/uh/en-US/UHI FZ-LLC Client T&C.pdf">' + trans('customerContract') + '</a></div>';
        }
        else
        {
            html += '<div class="panel-body row text-center"><a target="_blank" href="' + customerContractLink + '">' + trans('customerContract') + '</a></div>';
        }


        html += '</div>';

        html += '</div>';

        AlertInfo.show(html, _self.labelsText.bookingTC);
        AlertInfo.setWidth('35%');
        AlertInfo.setMinWidth('600px');
    };
    obj.showTariffNotes = function()
    {
        var _self = Accommodation.Booking;

        var selectedRooms = $.extend(true, [], _self.selectedRooms);
        for(var i = 1, ii = selectedRooms.length; i <= ii; i++)
        {
            if(!selectedRooms.hasOwnProperty(i))
            {
                continue;
            }
            selectedRooms[i].grp = [];
            selectedRooms[i].grp.push(selectedRooms[i].roomId);

            for(var j = i + 1; j <= ii; j++)
            {
                if(!selectedRooms.hasOwnProperty(j))
                {
                    continue;
                }

                if(selectedRooms[i].room === selectedRooms[j].room)
                {
                    selectedRooms[i].grp.push(selectedRooms[j].roomId);
                    selectedRooms.splice(j, 1);
                    j--;
                }
            }
        }

        var html = '<div class="col-12">';

        $.each(selectedRooms, function(idx, selectedRoom) {
            if(selectedRooms.hasOwnProperty(idx))
            {
                var $room = $(selectedRoom.room);

                html += '<div class="panel">';
                //room title
                if(selectedRoom.grp.length == 1) {
                    html += '<div class="panel-heading bg-info">' + _self.labelsText.roomText + ' # ' + selectedRoom.grp[0] + ': ' + $room.find('div').first().text() + '</div>';
                }
                else {
                    html += '<div class="panel-heading bg-info">' + _self.labelsText.roomsText + ' # ';
                    for(var i = 0; i < selectedRoom.grp.length; i++)
                    {
                        html += selectedRoom.grp[i];
                        if(i < selectedRoom.grp.length - 2) {
                            html += ', ';
                        }
                        else if(i < selectedRoom.grp.length - 1) {
                            html += ' ' + _self.labelsText.andText + ' ';
                        }
                    }
                    html += ': ' + $room.find('div').first().text() + '</div>';
                }
                html += '<div class="panel-body" style="padding-left: 0; padding-right: 0;">';
                //rate notes
                var rateNotes = $room.find('.rdrRight .icon-notes');
                if(rateNotes.data('title') != null && (rateNotes.data('content') != null || rateNotes.data('content-position') >= 0))
                {
                    html += '<div class="panel panel-danger">';
                    html += '<div class="panel-heading">' + rateNotes.data('title') + '</div>';
                    if(rateNotes.data('content') != null) {
                        html += '<div class="panel-body row">' + rateNotes.data('content') + '</div>';
                    }
                    else
                    {
                        var pos = rateNotes.data('content-position');
                        var notes = $room.parents('.search-result_row').find('input[name="tariffNotesRoom"]').val();
                        notes = notes.substring(pos);
                        pos = notes.indexOf('!#@#!');
                        html += '<div class="panel-body row">' + notes.substring(0, pos) + '</div>';
                    }
                    html += '</div>';
                }

                html += '</div>';
                html += '</div>';
            }
        });

        html += '</div>';
        AlertInfo.show(html, _self.labelsText.tariffNotes);
        AlertInfo.setWidth('35%');
        AlertInfo.setMinWidth('600px');
    };

    obj.showRoomCP = function(roomId)
    {
        var _self = Accommodation.Booking;
        if(typeof _self.selectedRooms[roomId] === 'undefined' )
        {
            return;
        }

        var html = '';

        html += '<div class="col-12">';

        //var cancelRules = $(_self.selectedRooms[roomId].room).find('.rdrRight .cancellationRulesInfo');
        var cancelRules = Accommodation.Search.getCancellationRulesHtmlFromJson($(_self.selectedRooms[roomId].room).find('input[name="cancellationRulesJson"]').val());

        html += '<div class="panel panel-danger">';
        //html += '<div class="panel-heading">Cancellation and Amendment Policies</div>';
        html += '<div class="panel-body row">' + cancelRules + '</div>';
        html += '</div>';

        html += '</div>';

        AlertInfo.show(html, _self.labelsText.roomCP);
        AlertInfo.setWidth('25%');
        AlertInfo.setMinWidth('600px');
    };

    obj.showEanTC = function()
    {
        var _self = Accommodation.Booking;

        Loader.show();
        $.ajax({
            url: BASE_URL + (FOLDER ? '/' + FOLDER : '') + '/ajax/EANTermsOfUse.html',
            dataType: 'html',
            type: "get",
            async: true,
            statusCode: {
                302: function () {
                    window.location.href = BASE_CI_URL + '/login';
                }
            }
        }).done(function (result) {
            AlertInfo.show('<div style="min-height: 500px;">' + result + '</div>', _self.labelsText.eanTC);
            AlertInfo.setWidth('50%');
            AlertInfo.setMinWidth('700px');
        }).fail(function (xhr, err, errText) {
            // only show the alert if the status is not a redirect
            if(xhr.status != 302)
            {
                AlertError.show(xhr.responseText, _self.labelsText.error);
            }
        }).always(function() {
            Loader.hide();
        });
    };

    obj.changeBookingParamsRoomToken = function(newAllocationDetails)
    {
        $.each(newAllocationDetails, function(room, value) {
            if(typeof Accommodation.Booking.bookingParams['roomToken[' + room + ']'] !== 'undefined')
            {
                Accommodation.Booking.bookingParams['roomToken[' + room + ']'] = value;
            }
        });
    };

    obj.showUmrahTC = function()
    {
        var _self = Accommodation.Booking;
        AlertInfo.show('<div style="min-height: 500px;">' + $('#umrahBookingConsentText').val() + '</div>', _self.labelsText.eanTC);
        AlertInfo.setWidth('50%');
        AlertInfo.setMinWidth('700px');
    };

	return obj;
})(jQuery);

function ExtraMeals (roomId, callbackAdd, callbackRemove, callbackUpdate)
{
    this.roomId = roomId;
    this.callbackAdd = callbackAdd;
    this.callbackRemove = callbackRemove;
    this.callbackUpdate = callbackUpdate;
    this._id = '_' + (new Date().getTime().toString());

    this.price = 0.0;
    this.commission = 0.0;
    this.netPrice = 0.0;

    var $id = this.roomId + '_' + this._id;

    this.selectors = {
        guestType: '#guestType_' + $id,
        mealType: '#mealType_' + $id,
        meal: '#meal_' + $id,
        guestNbr: '#guestNbr_' + $id,
        childAge: '#childAge_' + $id,
        price: '#price_' + $id,
        commission: '#mealCommission_' + $id,
        netPrice: '#mealNetPrice_' + $id,
        datesContainer: '#datesContainer_' + $id
    };

    this.roomSearchRow = $('#searchForm #search_row' + this.roomId);

    this.init();

    if(!Array.isArray(selectedExtraMeals[this.roomId]))
    {
        selectedExtraMeals[this.roomId] = [];
    }

    //current meal buttons
    if(selectedExtraMeals[this.roomId].length == 0)
    {
        this.ShowAddButton();
    }
    else
    {
        this.ShowDeleteButton();
    }

    selectedExtraMeals[this.roomId].push(this);

    $(this.selectors.guestType).trigger('change');
}

ExtraMeals.prototype = {

    init: function ()
    {
        var _self = this;
        var $tmpl = $('#extraMealsTemplate').html();
        if(isOldIE() == 7)
        {
            $('#extraMealsTable' + _self.roomId).find('tbody').append(Mustache.render($tmpl, {
                room: _self.roomId, _id: _self._id
            }));
        }else {
            $('#extraMealsTable' + _self.roomId).append(Mustache.render($tmpl, {
                room: _self.roomId, _id: _self._id
            }));
        }
        var $mealContainer = $('#mealContainer_' + _self.roomId + '_' + _self._id);
        $mealContainer.find('.addMeal').click(function() {
            _self.callbackAdd(_self.roomId);
        });

        $mealContainer.find('.removeMeal').click(function() {
            _self.callbackRemove(_self.roomId, _self._id);
        });

        _self.addEmptyOptionTo($(_self.selectors.guestType));
        _self.populateGuestTypeSelect();
        _self.populateMealTypeSelect();

        $(_self.selectors.guestType).on('change', function () {
            _self.guestTypeSelectDidChange.call(_self, this);
        });

        $(_self.selectors.mealType).on('change', function () {
            _self.mealTypeSelectDidChange.call(_self, this);
        });

        $(_self.selectors.guestNbr).on('change', function () {
            _self.guestNbrSelectDidChange.call(_self, this);
        });

        $(_self.selectors.childAge).on('change', function () {
            _self.childAgeSelectDidChange.call(_self, this);
        });

        $(_self.selectors.meal).on('change', function () {
            _self.meal = this.value;
            if(_self.mealIsValid())
            {
                _self.updatePrice();
                _self.drawDaysCheckboxes();
            }
            else
            {
                _self.price = 0.0;
                _self.commission = 0.0;
                _self.netPrice = 0.0;
                _self.updatePrice();
                _self.clearDatesCheckboxes();
            }
        });

        $(document).on('click', ".dayPrice_" + _self.roomId  + '_' + _self._id, function ()
        {
            _self.dayCheckboxWasClicked.call(_self, this);
            _self.updateLoyalty();
        });

    },
    updateLoyalty: function()
    {
        var AB = Accommodation.Booking;
        var roomId = this.roomId;

        var $room = $(AB.selectedRooms[roomId].room);
        var idx = AB.selectedRooms[roomId].idx;

        if(! $room.data('loyaltypoints.' + idx))
        {
            return;
        }

        //read meal prices in usd
        var loyaltyPrices = {};
        if(selectedExtraMeals[roomId] != 'undefined')
        {
            for(var i = 0; i < selectedExtraMeals[roomId].length; i++)
            {
                var t = selectedExtraMeals[roomId][i].getCheckedDayPriceUsd();
                for(var j = 0; j < t.length; j++)
                {
                    jQuery.each(t[j], function(date, val)
                    {
                        if(typeof loyaltyPrices[date] === 'undefined') {
                            loyaltyPrices[date] = 0;
                        }

                        loyaltyPrices[date] += parseFloat(val);
                    });
                }
            }
            //if have meals => add rate price
            if(! $.isEmptyObject(loyaltyPrices))
            {
                var roomLoyaltyRates = $('#pblpLoyaltyPoints' + roomId).data('roomLoyaltyRates');
                jQuery.each(roomLoyaltyRates, function(date, val)
                {
                    if(typeof loyaltyPrices[date] === 'undefined') {
                        loyaltyPrices[date] = 0;
                    }

                    loyaltyPrices[date] += parseFloat(val);
                });
            }
        }

        if(! $.isEmptyObject(loyaltyPrices))
        {
            //get new loyalty roe
            var $searchRow = $('#search_row' + roomId);
            $.ajax({
                url: AB.getNewROEUrl,
                dataType: 'json',
                type: "get",
                async: true,
                data: {
                    dailyArray: loyaltyPrices,
                    hotelCode: AB.$hotel.data('hotelid'),
                    passengerNationality: $searchRow.find('input[name="nationality[' + roomId + ']"]').val(),
                    passengerResidency: $searchRow.find('input[name="residency[' + roomId + ']"]').val()
                },
                statusCode: {
                    302: function() {
                        window.location.href = BASE_CI_URL + '/login';
                    }
                }
            }).done(function(result) {
                var newROE = -1;
                if(result.success)
                {
                    newROE = result.roe;
                }

                if(newROE >= 0)
                {
                    $('#pblpLoyaltyPoints' + roomId).html(newROE);
                }
            });
        }
        else
        {
            $('#pblpLoyaltyPoints' + roomId).html($room.data('loyaltypoints.' + idx))
        }
    },
    remove: function()
    {
        $('#mealContainer_' + this.roomId + '_' + this._id).remove();
        $('#datesContainer_' + this.roomId + '_' + this._id).closest('tr').remove();
        this.updatePrice(true);
        this.updateLoyalty();
    },
    ShowAddButton: function()
    {
        $('#mealContainer_' + this.roomId + '_' + this._id).find('.addMeal').show();
    },
    ShowDeleteButton: function()
    {
        $('#mealContainer_' + this.roomId + '_' + this._id).find('.removeMeal').show();
    },
    updatePrice: function(skipMe)
    {
        var total = 0.0;
        var commission = 0.0;
        var netPrice = 0.0;

        var _self = this;
        $.each(selectedExtraMeals[_self.roomId], function (idx, extraMeal) {

            if(_self.roomId == extraMeal.roomId)
            {
                if(typeof skipMe !== 'undefined' && skipMe === true)
                {
                    if(_self._id != extraMeal._id)
                    {
                        total       += extraMeal.getPrice();
                        commission  += extraMeal.getCommission();
                        netPrice    += extraMeal.getNetPrice();
                    }
                }
                else
                {
                    total       += extraMeal.getPrice();
                    commission  += extraMeal.getCommission();
                    netPrice    += extraMeal.getNetPrice();
                }
            }
        });

        _self.callbackUpdate(_self.roomId, total, commission, netPrice);
    },
    getCommission: function()
    {
        return this.commission;
    },
    getNetPrice: function()
    {
        return this.netPrice;
    },
    getPrice: function ()
    {
        return this.price;
    },
	getCheckedDayPriceUsd: function()
    {
        var $datesSelected = $('[name^="extraMeals[' + this.roomId + '][' + this._id + '][dates]"]:checked');
        if(!this.mealIsValid() || !$datesSelected.length || !$('#pbcpExtraMeals' + this.roomId).prop('checked'))
        {
            return [];
        }
        $datesSelected = $('[name^="extraMeals[' + this.roomId + '][' + this._id + '][dates]"]');
        var result = [];

        var guestNbr = parseInt(this.guestNbr, 10);

        $.each($datesSelected, function (idx, selector)
        {
            var $input = $(selector);
            var p = {};

            p[$input.data('date')] = 0;
            if ($input[0].checked)
            {
                p[$input.data('date')] = $input.data('priceusd') * guestNbr;
            }

            result.push(p);
        });
        return result;
    },
    drawDaysCheckboxes: function ()
    {
        var _self = this;

        var currentMeal = $(_self.selectors.meal).val();
        var $daysContainer = $(_self.selectors.datesContainer);
        var applicableDays = window.mealTypes[_self.mealType]["dates"];
        _self.clearDatesCheckboxes();

        var selectAllContainer = $('<div>', {"class" : "col-12 text-left"});
        var selectAllLabel     = $('<label>', {css:{color: "red", cursor: "pointer"}});

        $('<input>', { type: "checkbox", css:{display: "none"} }).on('click', function ()
        {
            var isChecked = $(this).is(':checked');
            $('.dayPrice_' + _self.roomId  + '_' + _self._id).each(function(i, obj)
            {
                var _me = $(obj);
                if((isChecked && !_me.is(':checked')) || (!isChecked && _me.is(':checked')))
                {
                    _me.prop('checked', isChecked);
                    _self.dayCheckboxWasClicked.call(_self, obj);
                }
            });
            _self.updateLoyalty();

        }).appendTo(selectAllLabel);

        selectAllLabel.append($('<span>', {text: Accommodation.Booking.labelsText.checkAllDays}));

        selectAllContainer.append(selectAllLabel);
        $daysContainer.append(selectAllContainer);

        $.each(applicableDays, function (date, el) {

            var $day = $('<div>').addClass('col-2');
            var $label = $('<label>', {
                "for": "dates_" + date + '_' + _self._id
            });

            $day.append($label);
            var $input = $('<input>', {
                type: 'checkbox',
                name: 'extraMeals[' + _self.roomId + '][' + _self._id + '][dates][' + date + ']',
                value: el[currentMeal].netPrice || el[currentMeal].price,
                id: "dates_" + date + '_' + _self._id,
                "data-date": date,
                "data-pricePerDay": el[currentMeal].price,
				"data-priceUSD": el[currentMeal].priceUSD,
				"data-commission": el[currentMeal].commission,
				"data-netprice": el[currentMeal].netPrice,
                "class" : "dayPrice_" + _self.roomId  + '_' + _self._id
            });

            $label.append($input);
            $label.append(' ' + el[currentMeal]['day']);

            $day.appendTo($daysContainer);
        });
    },
    addEmptyOptionTo: function (parent)
    {
        parent.children().remove();
        parent.append($('<option>', {text: Accommodation.Booking.labelsText.chooseOne, value: ''}));
    },
    populateGuestTypeSelect: function ()
    {
        // check to see if the user also selected children as room occupants
        var childPresent = parseInt(this.roomSearchRow.find('[name^="childrenCount"]').val(), 10) > 0;

        var $guestTypeSelect = $(this.selectors.guestType);

        // add an empty option
        this.addEmptyOptionTo($guestTypeSelect);

        // add the adult option
        $guestTypeSelect.append($('<option>', {text: Accommodation.Booking.labelsText.adult, value: 'adult'}));

        // if we have at least a child in a room, add the child option
        if (childPresent && this.atLeastOneMealFitsAChildAge())
        {
            $guestTypeSelect.append($('<option>', {text: Accommodation.Booking.labelsText.child, value: 'child'}));
        }
        else
        {
            $('#extraMealsChildLabel' + this.roomId).hide();
            $('#extraMealsChildSpacer' + this.roomId).hide();
            $(this.selectors.childAge).parent().parent().hide();
            $(this.selectors.childAge).parent().parent().next().hide();
        }
    },
    atLeastOneMealFitsAChildAge: function ()
    {
        var $childrenAges = this.getChildAges();
        var childAgesThatHaveMeals = [];

        $.each(window.mealTypes, function (idx, meals)
        {
            if (!meals.meals.child)
            {
                return true;
            }

            $.each(meals["meals"]["child"], function (id, meal)
            {
                $.each($childrenAges, function(idx, childAgeInput)
                {
                    var childAge = parseInt(childAgeInput.value, 10);
                    var startAge = parseInt(meal.start, 10);
                    var endAge = parseInt(meal.stop, 10);

                    // only add this option if the meal is valid for the selected child age
                    if (childAge >= startAge && childAge <= endAge)
                    {
                        childAgesThatHaveMeals.push(childAge);
                    }
                });
            });
        });

        return childAgesThatHaveMeals.length > 0;
    },
    mealIsValid: function ()
    {
        return this.guestType && this.mealType && this.meal && this.guestNbr;
    },
    populateMealTypeSelect: function ()
    {
        var $mealTypeSelect = $(this.selectors.mealType);

        // remove all options and add an empty one
        this.addEmptyOptionTo($mealTypeSelect);

        // we have extra meals for this hotel
        // @TODO maybe do this check at init?!
        $.each(window.mealTypes, function (idx, element) {
            $mealTypeSelect.append($('<option>', {
                text: element.name,
                value: idx
            }));
        });
    },
    populateGuestNbrSelect: function ()
    {
        var $guestNbrSelect = $(this.selectors.guestNbr);

        this.addEmptyOptionTo($guestNbrSelect);
        var guestType = $(this.selectors.guestType).val();

        var type = 'children';
        if(guestType == 'adult')
        {
            type = 'adults';
        }

        var guestNbr = parseInt(this.roomSearchRow.find('[name^="' + type + 'Count"]').val(), 10);

        // only allow the user to select 1 guest for the children extra meals
        if (this.guestType == 'child')
        {
            guestNbr = 1;
        }

        for (var i = 1; i <= guestNbr; i ++)
        {
            $guestNbrSelect.append($('<option>', {text: i, value: i}));
        }
    },
    clearDatesCheckboxes: function ()
    {
        $(this.selectors.datesContainer).children().remove();
    },
    populateChildAges: function (age)
    {
        var _self = this;
        // get number of children
        var $childrenAges = _self.roomSearchRow.find('[name^="childrenAges"]:visible');
        if($childrenAges.length)
        {
            $.each($childrenAges, function (idx, element) {
                $('<option>', {text: element.value, value: element.value}).appendTo($(_self.selectors.childAge));
            });
        }
    },
    mealTypeSelectDidChange: function (select)
    {
        this.mealType = select.value;

        var $mealSelect = $(this.selectors.meal);

        this.addEmptyOptionTo($mealSelect);
        $mealSelect.trigger('change'); // trigger a change on the meal select so the value is updated

        if(select.value)
        {
            var guestType = $(this.selectors.guestType).val();
            var availableMeals = window.mealTypes[select.value]["meals"][guestType];

            // get the child age
            var childAge = parseInt($(this.selectors.childAge).val(), 10);

            $.each(availableMeals, function (id, meal) {

                if (guestType == "child") {
                    // check child ages
                    if (childAge >= parseInt(meal.start, 10) && childAge <= parseInt(meal.stop, 10)) {
                        $mealSelect.append($('<option>', {text: meal.meal, value: id}));
                    }
                }
                else {
                    $mealSelect.append($('<option>', {text: meal.meal, value: id}));
                }
            });

            $mealSelect.prop('disabled', !Object.keys(availableMeals).length);
        }

        this.clearDatesCheckboxes();

        if (this.mealIsValid())
        {
            this.drawDaysCheckboxes();
        }

        this.price = this.commission = this.netPrice = 0.0;
        this.updatePrice();
    },
    getChildAges: function ()
    {
        return this.roomSearchRow.find('[name^="childrenAges"]:visible');
    },
    atLeastOneMealTypeFitsAChildAge: function(idx, childAge)
    {
        var isValid = false;
        $.each(window.mealTypes[idx]['meals']['child'], function(id, meal) {

            var startAge = parseInt(meal.start, 10);
            var endAge = parseInt(meal.stop, 10);
            if(childAge >= startAge && childAge <= endAge)
            {
                isValid = true;
                return false;
            }
        });
        return isValid;
    },
    guestTypeSelectDidChange: function (select)
    {
        var _self = this;
        _self.guestType = select.value;

        _self.populateGuestNbrSelect();

        $(_self.selectors.mealType).prop('disabled', ! select.value).val('').trigger('change');
        $(_self.selectors.meal).prop('disabled', ! select.value).val('').trigger('change');
        $(_self.selectors.guestNbr).prop('disabled', ! select.value).val('').trigger('change');

        _self.clearDatesCheckboxes();

        var isChild = select.value == 'child';

        // clear the child age select
        $(_self.selectors.childAge).children().remove();
        _self.addEmptyOptionTo($(_self.selectors.childAge));
        $(_self.selectors.childAge).prop("disabled", !isChild);

        // draw child ages
        if (isChild)
        {
            var $childrenAges = _self.getChildAges();
            var childAgesThatHaveMeals = {};

            $(_self.selectors.childAge).parent().show();

            $.each(window.mealTypes, function (idx, meals)
            {
                $.each(meals["meals"][select.value], function (id, meal)
                {
                    $.each($childrenAges, function (idx, childAgeInput)
                    {
                        var childAge = parseInt(childAgeInput.value, 10);
                        var startAge = parseInt(meal.start, 10);
                        var endAge = parseInt(meal.stop, 10);

                        // only add this option if the meal is valid for the selected child age
                        if (childAge >= startAge && childAge <= endAge)
                        {
                            childAgesThatHaveMeals[childAge] = 1;
                        }
                    });
                })
            });

            var $childSelect = $(_self.selectors.childAge);
            $.each(childAgesThatHaveMeals, function (childAge)
            {
                $childSelect.append($('<option>', {text: childAge, value: childAge}));
            });

            $childSelect.trigger('change'); //repopulate meal types based on child age

        }
        else
        {
            $(_self.selectors.childAge).parent().hide();
            _self.populateMealTypeSelect(); //repopulate meal types
        }

        if (_self.mealIsValid())
        {
            _self.drawDaysCheckboxes();
        }

        _self.price = _self.commission = _self.netPrice = 0.0;
        _self.updatePrice();
    },
    guestNbrSelectDidChange: function (select)
    {
        this.guestNbr = select.value;

        // only search for a price if we have a value and all other selects have valid values
        if (this.mealIsValid())
        {
            this.drawDaysCheckboxes();
        }

        this.price = this.commission = this.netPrice = 0.0;
        this.updatePrice();
    },
    childAgeSelectDidChange: function (select)
    {
        var _self = this;
        var childAge = select.value;

        var $mealTypeSelect = $(_self.selectors.mealType);
        _self.addEmptyOptionTo($mealTypeSelect);
        $.each(window.mealTypes, function (idx, element) {
            if(_self.atLeastOneMealTypeFitsAChildAge(idx, childAge)) {
                $mealTypeSelect.append($('<option>', {text: element.name, value: idx}));
            };
        });

        // when the child age select changes, reset the meal types
        $(this.selectors.mealType).val('').trigger('change');
    },
    dayCheckboxWasClicked: function (input)
    {
        if (this.mealIsValid())
        {
            var pricePerDay     = parseFloat(input.getAttribute('data-pricePerDay'));
            var priceCommission = parseFloat(input.getAttribute('data-commission'));
            var priceNet        = parseFloat(input.getAttribute('data-netprice'));

            $(this.selectors.price).val(pricePerDay);
            $(this.selectors.commission).val(priceCommission);
            $(this.selectors.netPrice).val(priceNet);

            var guestNumber = parseInt($(this.selectors.guestNbr).val(), 10);
            if ($(input).is(':checked'))
            {
                this.price      += parseFloat(pricePerDay * guestNumber);
                this.commission += parseFloat(priceCommission * guestNumber);
                this.netPrice   += parseFloat(priceNet * guestNumber);
            }
            else
            {
                this.price      -= parseFloat(pricePerDay * guestNumber);
                this.commission -= parseFloat(priceCommission * guestNumber);
                this.netPrice   -= parseFloat(priceNet * guestNumber);
            }
        }
        else
        {
            $(this.selectors.price + ', ' + this.selectors.commission + ', ' + this.selectors.netPrice).val('');
        }

        if (this.price < 0)
        {
            this.price = this.commission = this.netPrice = 0.0;
        }

        this.updatePrice();
    },
    serializeInputs: function (currentIdx)
    {
        var $datesSelected = $('[name^="extraMeals[' + this.roomId + '][' + this._id + '][dates]"]:checked');
        if(!this.mealIsValid() || !$datesSelected.length || !$('#pbcpExtraMeals' + this.roomId).prop('checked'))
        {
            return '';
        }

        var toSerialize = [
            this.selectors.guestType,
            this.selectors.mealType,
            this.selectors.meal,
            this.selectors.guestNbr,
            this.selectors.childAge,
            this.selectors.price
        ];

        var output = '';
        $.each(toSerialize, function (idx, selector) {

            var $input = $(selector);
            var name = $input.attr('name').replace(/\[_\d+?]/, '[' + currentIdx + ']');
            output += '&' + encodeURIComponent(name) + '=' + encodeURIComponent($input.val());
        });
        $.each($datesSelected, function (idx, selector) {
            var $input = $(selector);
            var name = $input.attr('name').replace(/\[_\d+?]/, '[' + currentIdx + ']');
            output += '&' + encodeURIComponent(name) + '=' + encodeURIComponent($input.val());
        });

        return output;
    }
};


var Hotel = (function($)
{
    var obj = {};

    obj.getObject = function (obj)
    {
        if(typeof obj != 'object')
        {
            return $(obj);
        }

        return obj;
    };

    obj.getHotelData = function (hotel)
    {
        var $hotel = obj.getObject(hotel);

        return $hotel.data();
    };

    obj.getImagePath = function (hotel)
    {
        var $hotel = obj.getObject(hotel);

        return $hotel.find('.search_img img').attr('src');
    };

    obj.getHotelName = function (hotel)
    {
        var $hotel = obj.getObject(hotel);

        return $hotel.find('.unitName').text();
    };

    obj.getHotelStarRateHtml = function (hotel)
    {
        var $hotel = obj.getObject(hotel);

        return $hotel.find('.star_rate').prop('outerHTML');
    };

    obj.getHotelLocation = function (hotel)
    {
        var $hotel = obj.getObject(hotel);

        return $hotel.find('.search-location').text();
    };

    obj.getHotelLocationName = function (hotel)
    {
        var $hotel = obj.getObject(hotel);

        return $hotel.data('location');
    };

    obj.getHotelAmenities = function (hotel)
    {
        var $hotel = obj.getObject(hotel);
        var amenitiesCodes = $hotel.data('amenities');

        if(amenitiesCodes === parseInt(amenitiesCodes,10)) {
            amenitiesCodes = amenitiesCodes.toString();
        }
        amenitiesCodes = amenitiesCodes.split(',');

        return getFilterInputLabels('#filterAmenities', amenitiesCodes);
    };

    obj.getRoomData = function (room)
    {
        var $room = obj.getObject(room);
        return $room.data();
    };

    obj.getRoomId = function (room)
    {
        var $room = obj.getObject(room);

        return $room.data('roomid.1');
    };

    obj.getRoomNo =  function (room)
    {
        var $room = obj.getObject(room);

        return $room.data('runno.1');
    };

    obj.getRoomAmenitiesHtml = function (hotelId, roomId, callback)
    {
        Loader.show();
        var params = $('#searchForm').serialize();
        var amenities = false;

        $.ajax({
            url: Accommodation.Search.getRoomDetailsUrl + '/' + hotelId + '/' + roomId, //getRoomDetailsUrl
            dataType: 'json',
            type: "POST",
            data: params,
            async: false,
            statusCode: {
                302: function () {
                    window.location.href = BASE_CI_URL + '/login';
                }
            }
        }).done(function (result) {
            if(typeof(result.html) != "undefined"){
                amenities =  $(result.html).find('.list-group').prop('outerHTML');
                callback(amenities);
            } else {
                //console.log(result);
                amenities = false;
                callback(amenities);
            }
        }).fail(function (xhr, err, errText) {
            if(xhr.status != 302)
            {
                AlertError.show(xhr.responseText, Accommodation.Search.labelsText.error);
            }
        }).always(function() {
            //Loader.hide();
        });
    };

    obj.getRoomType = function (room)
    {
        var $room = obj.getObject(room);

        return $room.find('.roomTypeText').text();
    };

    obj.getRoomPolicyHtml = function (room,data)
    {
        var roomPolicyHtml = '-';
        var $room = obj.getObject(room);
        var roomPolicy = $room.find('.roomPolicy');

        if(typeof roomPolicy.find('span').attr('onclick') != 'undefined') {
            //"Click to get deadline"
            return false;
        }
        else if(roomPolicy.find('span').length == 0)
        {
            roomPolicyHtml = Accommodation.Search.getCancellationRulesHtmlFromJson($room.find('input[name="cancellationRulesJson"]').val());
            roomPolicyHtml = $(roomPolicyHtml).find('.criLegend').first().text();
            //roomPolicyHtml = $room.find('.cancellationRulesInfo').find('.criLegend:first').text();
            return roomPolicyHtml;
        }
        else
        {
            roomPolicyHtml = $room.find('.roomPolicy').html();
            return roomPolicyHtml;
        }
    };

	obj.getRoomPolicyRaw = function (room)
    {
        var $room = obj.getObject(room);
        var roomPolicy = $room.find('.roomPolicy');

        if(roomPolicy.find('span').length == 0)
        {
            roomPolicy = Accommodation.Search.getCancellationRulesHtmlFromJson($room.find('input[name="cancellationRulesJson"]').val());
            roomPolicy = $(roomPolicy).find('.criLegend').find('input').val();
            return roomPolicy;// $room.find('.cancellationRulesInfo').find('.criLegend').find('input').val();
        } else {
            return $room.find('.roomPolicy').find('input').val();
        }
    };

    obj.getPromotionRaw = function (room)
    {
        var $room = obj.getObject(room);
        var specialPromotions = $room.find('input[name="promotionsJson"]');

        if(typeof specialPromotions[0] == 'undefined') {
            return false;
        }

        return '<div>' + Accommodation.Search.getPromotionsHtmlFromJson(specialPromotions.val()) + '</div>';
    };

    obj.getRoomPaymentMode = function (room)
    {
        var $room = obj.getObject(room);
        var paymentType =  $room.data('paymentmode.1');

        if(typeof paymentType == "undefined") {
            return false;
        }

        return paymentType;
    };

    obj.getRoomRateType = function (room)
    {
        var $room         = obj.getObject(room);
        var filterValues  = [];
        var restricted = $room.data('nonrefundable.1').length;

        if(restricted > 0)
        {
            filterValues.push(2);
        } else {
            filterValues.push(1);
        }

        var rateType = getFilterInputLabels('#filterRateType', filterValues);

        return rateType[0];
    };

	obj.getRoomRateTypeNumeric = function (room)
    {
        var $room = obj.getObject(room);
        if($room.data('nonrefundable.1').length > 0)
        {
            return 2; //restricted
        } else {
            return 1; //flexible
        }
    };

    obj.getRoomBoardBasis = function (room)
    {
        var $room = obj.getObject(room);
        var board = $room.data('board.1');

        return getFilterInputLabels('#filterBoardBasis', [board]);
    };

	obj.getRoomBoardBasisCode = function(room)
    {
        var $room = obj.getObject(room);

        return $room.data('board.1');
    };

    obj.roomHasPromotions = function (room)
    {
        var $room = obj.getObject(room);
        var promotions = $room.data('promotions.1');

        return Boolean(promotions);
    };

    obj.getRoomPromotionsHtml = function (room)
    {
        var $room = obj.getObject(room);
        var specialPromotions = $room.find('input[name="promotionsJson"]');
        if(typeof specialPromotions[0] == 'undefined') {
            return false;
        }
        return Accommodation.Search.getPromotionsHtmlFromJson(specialPromotions.val());
    };

    obj.getRoomPrice = function (room)
    {
        var price;
        var $room = obj.getObject(room);
        var roomRateType = obj.getRoomRateType(room);

        if ((typeof roomRateType != 'undefined') && roomRateType.toLowerCase().trim() == 'restricted' && $room.data('displayedcurrency.1').toString().length > 1) {
            price = $room.data('displayedprice.1');
        } else {
            price = $room.data('roomformattedprice.1');
        }

        return price;
    };

    obj.getRoomMinPrice = function (room)
    {
        var $room = obj.getObject(room);

        return $room.data('minroomprice.1').toFixed(2);
    };

    obj.getCurrency = function (room)
    {
        var currency;
        var $room = obj.getObject(room);
        var roomRateType = obj.getRoomRateType(room);

        if ((typeof roomRateType != 'undefined') && roomRateType.toLowerCase().trim() == 'restricted' && $room.data('displayedcurrency.1').toString().length > 1) {
            currency = $room.data('displayedcurrency.1');
        } else {
            currency =  $room.data('currency.1');
        }

        return currency;
    };

    obj.getRoomsCount = function (room)
    {
        var $room = obj.getObject(room);

        return $room.data('roomscount');
    };

    obj.getRoomOccupancy = function (room)
    {
        var $room = obj.getObject(room);
        var $roomOccupancy = $room.siblings('.rdCaption');
        if($roomOccupancy.length)
        {
            //if multiple rooms, get room occupancy
            var $roomOccupancyArr = $roomOccupancy.text().split("\n");
            return $.trim($roomOccupancyArr[$roomOccupancyArr.length - 1]);
        }
        else
        {
            //if one room get search occupancy text
            var adults = $('[name*="adultsCount"]').val();
            var children = $('[name*="childrenCount"]').val();
            var ages =  $('[name^="childrenAges"]:visible')
                    .map(function() { return $( this ).val();  })
                    .get().join( ", " );

            return trans('compare.adultsText') + ': ' + adults + ', ' + trans('compare.childrenText') + ': ' + children + (children > 0 ? (', ' + trans('compare.childrenText') + ': ' + ages ) : '');
        }
    };

    obj.getRoomOccupancyRaw = function (room)
    {
        var adults = $('[name*="adultsCount"]').val();
        var children = $('[name*="childrenCount"]').val();
        var ages =  $('[name^="childrenAges"]:visible')
            .map(function() { return $( this ).val();  })
            .get().join( ", " );

        return {'adults': adults, 'children' : children, 'ages': ages};
    };

    return obj;
}(jQuery));

$ (function ()
    {
        $(document).on('click', '#searchButton', function(event){
            focusstatus=true;
            Accommodation.Search.setSearchModalBanners();
            ResultsSortBy.resetSorting();
			var SearchID = $('#searchForm').find('input[name="PSearchId"]').val();
            var searchQuery =  $('#searchForm').find('input[name="destination"]').val();

            var nonumrahacm = $("input[name=nonumrahacm]").val();

            if(typeof IS_UMRAH_CUSTOMER !== "undefined" && Boolean(IS_UMRAH_CUSTOMER) === true && nonumrahacm == 0){
                //for umrah customer and maqam search set subpcc
                if( $('#subpccCheckbox').is(":checked") && $('[name="subPcc"]').val() == ''){
                    $('[name="subPcc_text"]').val($('[name="SubPCCcode"]').val());
                    $('[name="subPcc"]').val($('[name="SubPCCcode"]').val());
                }
            }

            if(SearchID !== ''){
                if($('input[name="destinationCountry"]').val() == '' || $('input[name="destinationCountry"]').val() == undefined ) {
                    $('#searchForm').find('input[name="destinationCountry"]').val(9999);
                }
                $('#searchForm').trigger('submit');

                $("#searchForm > div.search_row").hide();

                return true;
            }else{
             //call the AJAX method to find hotels with city details
             $('#searchForm').find('input[name="PSearchId"]').val('');
             $('#searchForm').find('input[name="PSearchType"]').val('');
             $('#searchForm').find('input[name="cityHotels"]').val('');
             $('#searchForm').find('input[name="destinationCountry"]').val(9999);
             $.ajax({
                    url : CI_PROXY_URL + '?c=PredictiveSearch&m=searchHotels&limit=1000&searchquery='+searchQuery,
                    dataType: 'json',
                    type: 'get',
                    async: false,
                    statusCode: {
                        302: function () {
                            window.location.href = BASE_CI_URL + '/login';
                        }
                    }
                }).done(function (result) {
                    if(typeof result === 'undefined' || result.length <= 0) {
						$('#searchForm').trigger('submit');
                        return true;
                    }
                    var firstCity = result[0]['CityId'];
                    var hotels = result[0]['Id'];
                    var unmatchFound = false;
                    $.each(result, function (index, value) {
                        if(firstCity !== value['CityId'])
                        {
                            unmatchFound = true;
                            return false;
                        }
                        if(index !== 0){
                           hotels = hotels+","+value['Id'];
                        }
                    });
                    if(unmatchFound == true){
						$('#searchForm').trigger('submit');
                        return true;
                    }
                    $('#searchForm').find('input[name="PSearchId"]').val(firstCity);
                    $('#searchForm').find('input[name="PSearchType"]').val('city');
                    $('#searchForm').find('input[name="cityHotels"]').val(hotels);
                    $('#searchForm').find('input[name="destinationCountry"]').val(result[0]['countryId']);
					$('#searchForm').trigger('submit');
                    return true;
                }).fail(function () {
					$('#searchForm').trigger('submit');
                    return true;
                });
            }
        });

        $(document).on('click', '.openRoomModal', function (e) {
            var _self = Accommodation.Booking;
            var params = $('#searchForm').serialize();
            params += '&' +'doSearch=1'
            var accommodationId = $('.search-result_row').data('hotelid');
            Loader.show(false, false);
            var datasplice = $('#setdataDropdown').attr("data-id").split(":#");
            $.ajax({
                url: BASE_CI_URL + '/accommodation/hotel-room-details/' + accommodationId,
                dataType: 'html',
                type: "get",
                async: true,
                data: params,
                statusCode: {
                    302: function () {
                        window.location.href = BASE_CI_URL + '/login';
                    }
                }
            }).done(function (result)
            {
                result = jQuery.parseJSON(result);
                if(result.searchResult != undefined) {
                    var exCeptionSplice = result.searchResult.split("====");
                    if (exCeptionSplice[0] == 'Exception') {
                        AlertError.show(exCeptionSplice[1], _self.labelsText.error);
                    } else {
                        var noOfRooms = $('#searchRoomsNo').val();
                        $('.passDetailsModalBody').html(result.searchResult);
                        if (noOfRooms > 1) {
                            $('#passengerDetailsModal .price-range .search_btn').val('LESS RATES');
                            $('#passengerDetailsModal .price-range .search_btn').addClass('showLess');
                        }
                        $('#passengerDetailsModal .addRoomToCompare').remove();
                        $('#passengerDetailsModal .divider').remove();
                        $('#matchingSearch').val(result.matchingSearch);
                        $('#passengerDetailsModal').modal('show');
                        if ($('#isCriteriaChange').val() == 0) {
                            $('#passengerDetailsModal .multipleRoomsSelect').each(function (index) {

                                var checking = datasplice[index].split("+")
                                if ($(this).parent().find('.selectData').attr("data-id") == checking[1]) {
                                    if (checking[0] > 0) {
                                        $(this).val(checking[0]).trigger('change');
                                    }
                                }
                            });
                        }
                        $('#isCriteriaChange').val(0);
                        if ($('#passengerDetailsModal .rdRow').length < 3) {
                            $('#passengerDetailsModal').find("[name='booknow']").hide();
                        }
                    }
                }
            }).always(function() {
                Loader.hide();
            });
        });
        $(document).on('click', 'div#content .roomInfoIcon', function(){
            Accommodation.Search.showRoomInfo(this);
        });
        $(document).on('click', 'div#content .dailyRatesInfo', function(){
            Accommodation.Search.showPricePerDayInfo(this);
        });
        $(document).on('click', 'div#content .promoInfoIcon', function(){
            Accommodation.Search.showPromoInfo(this);
        });
        $(window).on('popstate', function(event) {
            if ($('#isSinglePage').length > 0) {
                location.reload();
            }
        });

            $(document).on('change','div#content .multipleRoomsSelect', function(e) {
                /*if($('#passengerDetailsModal').length == 0 )
                {*/
                    $('#setdataDropdown').attr("data-id", '');
                    var Selval='' ;
                    $('div#content .multipleRoomsSelect').each(function( index ) {
                        if($(this).val()!='')
                        {
                            if(Selval!='')
                            {
                                Selval=Selval+':#'+ this.value +'+'+$(this).parent().find('.selectData').attr("data-id");
                            }
                            else
                            {
                                Selval=this.value +'+'+$(this).parent().find('.selectData').attr("data-id");
                            }


                        }

                    });
                    $('#setdataDropdown').attr("data-id", Selval);
               /* }*/
            });
          /*In geust details page in search modal
          * when do some error another modal open over the search modal to manage the close of the
          * second modal this click method required
          * */
        $('.modal').on('hidden.bs.modal', function () {
            if($("#passengerDetailsModal:visible").length>0) {
                //if($(".modal:visible").length > 0) {
                setTimeout(function() {
                    $('body').addClass('modal-open');
                },100)
            }

        });

        $(document).on('click','#modal_cross', function(e) {
            var amount = 0.0;
            $('.shoppingcart_container .total h4').html($('#activeCurrency').data('activecurrencyname') + ' ' + amount.formatMoney(DECIMAL_POINTS, THOUSAND_SEPARATOR, DECIMAL_SEPARATOR));
        });
    });

let WalletConfirmation = (function($) {

    let obj = {};
    let modal = null;

    function getData()
    {
        let roomContainer = $('.rd-room-container');
        let data = [];

        roomContainer.each(function(el)
        {
            data.push({
                id: $(this).data('roomno'),
                name: $(this).find('.rd-roomtypename').html(),
                price: $(this).find('.rd-total-room-price').html(),
            });
        });

        return data;
    }

    obj.init = function() {

        $(document).on('click', '.btn-change-wallet-auth-code', obj.showModal);
        $(document).on('click', '#btn-wallet-close-modal', appendParams);
        $(document).on('click', '#btn-wallet-confirm-booking', onSubmit);
    };

    obj.showModal = function()
    {
        let data = getData();
        let customerWallets = getCustomerWallets();
        let template = $('#walletConfirmationTemplate').text();
        let reservationCost = $('#pblpReservationTotalCost').html();
        if($('#pblpReservationPsgDiscCost').is(":visible"))
        {
            reservationCost = $('#pblpReservationPsgDiscCost').html();
        }

        let confirmHtml = Mustache.render(template, {rooms: data, total: reservationCost, roomCnt: data.length, adtCnt: $('#adtCntVal').html(), chdCnt: $('#chdCntVal').html(), walletOptions: customerWallets});
        $(AlertInfo.dialog).addClass('umrah-accom-wallet-cfrm');
        modal = AlertInfo.show(confirmHtml, Accommodation.Booking.labelsText.walletConfirmation, function () {
            $(AlertInfo.dialog).removeClass('umrah-accom-wallet-cfrm');
        });

       };

    let onSubmit = function(ev)
    {
        if($('#wc-wallet-code').val() == '')
        {
            AlertError.show(Translations.getText('walletDropdown.walletAuthenticationMsg'));
            return false;
        }

        modal.hide();
        if(typeof IS_UMRAH_CUSTOMER !== "undefined" && Boolean(IS_UMRAH_CUSTOMER) === true)
        {
            $('#umrah_search_book_loader').modal('show');
            $('.loader-bg-booking').show();
        }
        appendParams();
        Accommodation.Booking.validateDuplicate = false;
        Accommodation.Booking.continueToBook($(Accommodation.Booking.formId).attr('action'));
        delete Accommodation.Booking.bookingParams.walletAuthenticationCode;
        delete Accommodation.Booking.bookingParams.walletId;
    };

    let appendParams = function()
    {
        Accommodation.Booking.bookingParams.walletAuthenticationCode = $('#wc-wallet-code').val();
        Accommodation.Booking.bookingParams.walletId = $('#walletIDPop').val();
    };

    return obj;
})(jQuery);

WalletConfirmation.init();

var hooks = {
    queue : {},

    add : function (name, fn) {
        // hooks.add() : add a hook
        // PARAM name : name of function to add hook to
        //       fn : function to call

        if ( ! hooks.queue[name]) {
            hooks.queue[name] = [];
        }
        hooks.queue[name].push(fn);
    },

    call : function (name, params) {
        // hooks.call() : call the hook functions
        // PARAM name : name of function to add hook to
        //       params : parameters

        if (hooks.queue[name])  {
            hooks.queue[name].forEach(function(fn) { return fn(params) });
            delete hooks.queue[name];
        }
    }
};
/*Let and arrow function does not work in IE */
function nextLetter (letter) {
    var charCode = letter.charCodeAt(0);
    var isCapital = letter == letter.toUpperCase();

    if (isCapital == true) {
        return String.fromCharCode((charCode - 64) % 26 + 65)
    } else {
        return String.fromCharCode((charCode - 96) % 26 + 97)
    }

}

$(document).on('click', '.totalPriceText', function () {
    switchSortElements(this, 'price');
});

$(document).on('click', '.roomTypeSort', function () {
    switchSortElements(this, 'roomType');
});

$(document).ready(function () {
    checkForSorting();
    removeBookingButton();
});

function switchSortElements(element, activeSorting) {
    let rows = $(element).parent().parent().children('.rdRow:visible');
    resetSortingIcons($(element).parent().parent(), activeSorting);
    let sortingIconClass = activeSorting === 'price' ? '.sortIconPrice' : '.sortIconRoomType';
    let orderedIconClass = activeSorting === 'price' ? 'glyphicon-sort-by-order' : 'glyphicon-sort-by-alphabet';
    let reverseOrderedIconClass = activeSorting === 'price' ? 'glyphicon-sort-by-order-alt' : 'glyphicon-sort-by-alphabet-alt';
    if ($(element).attr('data-sorted') === '1') {
        switchClass(element, '2', 'descending', sortingIconClass, orderedIconClass, reverseOrderedIconClass, activeSorting, rows);
    } else {
        switchClass(element, '1', 'ascending', sortingIconClass, orderedIconClass, reverseOrderedIconClass, activeSorting, rows);
    }
}

function switchClass(element, dataSorted, order, sortingIconClass, orderedIconClass, reverseOrderedIconClass, activeSorting, rows) {
    $(element).attr('data-sorted', dataSorted);
    $(element).children(sortingIconClass)
        .removeClass((order === 'ascending' ? reverseOrderedIconClass : orderedIconClass) + ' glyphicon-sort')
        .addClass(order === 'ascending' ? orderedIconClass : reverseOrderedIconClass);
    sortElements(rows, $(element).parent().parent(), order, activeSorting);
}

function sortElements(rows, tableElement, order, activeSorting) {
    let hiddenRows = $(tableElement).children('.rdRow:hidden');
    let header = $(tableElement).children('.rdHeading');
    let caption = $(tableElement).children('.rdCaption');
    quickSort(rows, 0, rows.length - 1, activeSorting);
    let arrayRows = [];
    rows.each(function () {
        arrayRows.push(this);
    });
    $(tableElement).empty().append(header).append(caption);

    arrayRows = order === 'ascending' ? arrayRows : arrayRows.reverse();
    for (let position = 0; position < arrayRows.length; position++) {
        $(tableElement).append(arrayRows[position]);
    }

    for (let position = 0; position < hiddenRows.length; position++) {
        $(tableElement).append(hiddenRows[position]);
    }
}

function getPriceValue(element) {
    let stringValue = ($(element).children('.priceValue').text()).replace(',', '');
    return Number(stringValue.slice(stringValue.search(/[\d.]/g)));
}

function partition(rows, low, high, activeSorting) {
    let pivot = activeSorting === 'price' ? getPriceValue(rows[high]) : ($(rows[high]).children('.roomTypeText').text()).toLowerCase();
    let i = (low - 1);
    for (let j = low; j <= high - 1; j++) {
        let comparingValue = activeSorting === 'price' ? getPriceValue(rows[j]) : ($(rows[j]).children('.roomTypeText').text()).toLowerCase();
        if (comparingValue < pivot) {
            i++;
            swap(rows, i, j);
        }
    }
    swap(rows, i + 1, high);
    return (i + 1);
}

function quickSort(rows, low, high, activeSorting) {
    if (low < high) {
        let pi = partition(rows, low, high, activeSorting);
        quickSort(rows, low, pi - 1, activeSorting);
        quickSort(rows, pi + 1, high, activeSorting);
    }
}

function swap(arr, i, j) {
    let temp = arr[i];
    arr[i] = arr[j];
    arr[j] = temp;
}

function resetSortingIcons(tableElement, activeSorting) {
    if (activeSorting === 'price') {
        $(tableElement).find('.roomTypeSort').attr('data-sorted', '0').children('.sortIconRoomType').removeClass().addClass('glyphicon sortIconRoomType glyphicon-sort');
    } else {
        $(tableElement).find('.totalPriceText').attr('data-sorted', '0').children('.sortIconPrice').removeClass().addClass('glyphicon sortIconPrice glyphicon-sort');
    }
}

function checkForSorting() {
    let tables = $('.rooms-details');
    tables.each(function () {
        let rows = $(this).children('.rdRow:visible');
        if (rows.length === 1) {
            removeSorting(this, 'roomTypeSort', 'sortIconRoomType');
            removeSorting(this, 'totalPriceText', 'sortIconPrice');
        }
    });
}

function removeSorting(table, targetActionClass, targetSymbolClass) {
    $(table).find('.' + targetActionClass).removeClass(targetActionClass);
    $(table).find('.' + targetSymbolClass).addClass('hidden');
}

function removeBookingButton() {
    let isUmrahCustomer = Number($('#isUmrahCustomer').val());

    if(!isUmrahCustomer)
    {
        let isSubCustomer         = Number($('#isSubCustomer').val());
        let isBranchCustomer      = Number($('#isBranchCustomer').val());
        let canParentCustomerBook = Number($('#canParentCustomerBook').val());
        let xmlCustomerCanBookPOS = Number($('#xmlCustomerCanBookPOS').val());
        let viewRateBook          = Number($('#viewRateBook').val());

        let removeButton = isSubCustomer ? !viewRateBook : !isBranchCustomer && !xmlCustomerCanBookPOS || isBranchCustomer && !canParentCustomerBook;
        if (removeButton && ($('.roomBookNowButton').length > 0 || $('.mrBookButton').length > 0)) {
            $('.roomBookNowButton').remove();
            $('.mrBookButton').remove();
        }
    }
}

function checkVisible(elm, eval) {
    eval = eval || "visible";
    const vpH = $(window).height(), // Viewport Height
        st = $(window).scrollTop(), // Scroll Top
        y = $(elm).offset().top,
        elementHeight = $(elm).height();

    if (eval === "visible") return ((y < (vpH + st)) && (y > (st - elementHeight)));
    if (eval === "above") return ((y < (vpH + st)));
}

Accommodation.Search.hideAllRooms = function (hotelId, element)
{
    var hotelSearchDiv = 'hotel_'+hotelId+'_row';
    $('#'+hotelSearchDiv).find('.accomodations-results').hide();
    $('#'+hotelSearchDiv).find('.available-rooms-btn').show();
    $('#'+hotelSearchDiv).find('.hide-rooms-btn').hide();
    $('#'+hotelSearchDiv).find('.rooms-details').hide();
    $('#'+hotelSearchDiv).find('.mrbnContainer').hide();
    $('#'+hotelSearchDiv).find('.mrCheckContainer').hide();
};
